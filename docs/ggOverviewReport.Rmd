---
title: 'NZ GREEN Grid project: Research data overview'
author: 'Ben Anderson (b.anderson@soton.ac.uk, `@dataknut`)'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    code_folding: hide
    fig_caption: true
    number_sections: true
    self_contained: no
    toc: true
    toc_float: true
    toc_depth: 2
  bookdown::pdf_document2:
    fig_caption: yes
    number_sections: yes
    toc: yes
    toc_depth: 2
bibliography: '`r path.expand("~/bibliography.bib")`'
---

```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) # by default turn off code echo
options(knitr.table.format = 'markdown') # try to fix the tables issue (seems to be pushing html into latex)
```


```{r codeSetup, include=FALSE}

# Set start time ----
startTime <- proc.time()


# Load nzGREENGrid package ----
library(nzGREENGridDataR) # local utilities

nzGREENGridDataR::setup()

# Packages needed in this .Rmd file ----
rmdLibs <- c("data.table", # data munching
             "ggplot2", # for fancy graphs
             "readr", # for reading & parsing .csv files
             "lubridate", # for year()
             "knitr", # for kable
             "stringr", # for str_wrap for long labels on plots
             "kableExtra" # for extra kable
)
# load them
nzGREENGrid::loadLibraries(rmdLibs)

# Local parameters ----

b2Kb <- 1024 #http://whatsabyte.com/P1/byteconverter.htm
b2Mb <- 1048576
plotLoc <- paste0(ggrParams$projLoc, "/docs/plots/")

  
# Local functions ----


```

\newpage

# About

## Report circulation:

 * Public - this report is intended to accompany the data release.
 
## License

```{r ccby license, child=ggrParams$licenseCCBY}
```
 
## Citation

If you wish to use any of the material from this report please cite as:

 * `r ggrParams$Authors` (`r 1900 + as.POSIXlt(Sys.Date())$year`) NZ GREEN Grid project: Research data overview, `r ggrParams$pubLoc`. 
 
> XX replace with UKDA DOI when available XX

This work is (c) `r lubridate::year(today())` the authors and the University of Southampton.

## History

Code history is generally tracked via our github [repo](https://github.com/dataknut/nzGREENGridDataR):

 * [Report history](https://github.com/dataknut/nzGREENGridDataR/commits/master/docs/ggOverviewReport.Rmd)
 * [General issues](https://github.com/dataknut/nzGREENGridDataR/issues)
 
## Requirements:

This report uses:
 
 * safe versions of the project research data and associated data quality statistics produced during processing of the original data. 

## Support

```{r generic support, child=ggrParams$supportGeneric}
```
 
\newpage

# Introduction

```{r generic sample, child=ggrParams$sampleGeneric}
```
 
This report provides an overview of the GREEN Grid project research data. The most recent version of this report can be found at https://dataknut.github.io/nzGREENGridDataR/.

# Study recruitment

```{r loadSafeHouseholdData, include=FALSE}
hhDT <- data.table::as.data.table(readr::read_csv(ggrParams$hhAttributes))
```

```{r loadHHgsStat, include=FALSE}
gsStatDT <- data.table::as.data.table(readr::read_csv(paste0(ggrParams$statsLoc, "hhStatsByDate.csv")))
```

The project research sample comprises `r nrow(hhDT)` households who were recruited in two batches, one starting in May 2014 and the second starting in November 2014 via two local lines companies (Powerco and Unison). 

Recruitment was via a non-random sampling method and a number of households were intentionally selected for their 'complex' electricity consumption (and embedded generation) patterns and appliances. As a result the sample cannot be assumed to represent the population of customers of either company, nor of the populations in each location.

Table \@ref(tab:sampleTable) shows the number in each sample and the dates from which Grid Spy data was collected. As can be seen data is still being collected on some households.

```{r sampleTable}
t <- hhDT[, .(nHouseholds = .N), keyby = .(Location, sample)]

kableExtra::kable(t, caption = "Sample location")
```

Table \@ref(tab:allHhData) shows key attributes for the recruited sample. Note that two grid spy monitors were re-used and so require new hhIDs to be set from the dates given. This has already been done in the [clean grid spy data](gridSpy1mProcessingReport.html#41_recoding_re-allocated_grid_spy_units) for the relevant households. Linkage between the survey and grid spy data should always use `linkID` to avoid errors.

```{r allHhData}
kable(hhDT[, c("sample", "hhID", "linkID", "Location", "notes", "r_stopDate")][order(linkID)], caption = "Sample details")

```

The households labeled 'NA' were initial pilot/test households who did not form part of the sample and for whom no survey data is available. They should be excluded from any data analysis.


# Data collection duration

Figure \@ref(fig:liveDataHouseholds) shows the total number of households for whom grid spy data exists on a given date by sample and indicates that for analytic purposes the period from April 2015 to March 2016 (indicated) would offer the maximum number of households.

```{r liveDataHouseholds, fig.cap="Sample size over time"}
setkey(gsStatDT, linkID)
dt <- merge(gsStatDT, hhDT, allow.cartesian=TRUE)

dt <- dt[, sample := factor(sample, levels = c("Unison","Powerco"))] # re-order for chart

plotDT <- dt[, .(nHH = uniqueN(hhID)), keyby = .(date, sample)]

# point plot ----
myCaption <- ""
rectAlpha <- 0.3
vLineAlpha <- 0.8
vLineCol <- "#0072B2" # http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette

yMin <- min(plotDT$nHH)
yMax <- 2 * max(plotDT$nHH)

ggplot2::ggplot(plotDT, aes( x = date, y = nHH, fill = sample)) +
  geom_col() +
  scale_x_date(date_labels = "%Y %b", date_breaks = "6 months") +
  theme(axis.text.x = element_text(angle = 90, 
                                   vjust = 0.5, 
                                   hjust = 0.5)) + 
  labs(title = "N live households per day for all clean grid spy data",
       caption = myCaption
       
  ) + 
  annotate("rect", xmin = as.Date("2015-04-01"),
             xmax = as.Date("2016-04-01"), 
             ymin = yMax, ymax = yMin, alpha = rectAlpha, fill = vLineCol)
```

# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

R packages used:

 * base R - for the basics [@baseR]
 * data.table - for fast (big) data handling [@data.table]
 * lubridate - date manipulation [@lubridate]
 * ggplot2 - for slick graphics [@ggplot2]
 * readr - for csv reading/writing [@readr]
 * dplyr - for select and contains [@dplyr]
 * progress - for progress bars [@progress]
 * knitr - to create this document & neat tables [@knitr]
 * kableExtra - for extra neat tables [@kableExtra]
 * nzGREENGridDataR - for local NZ GREEN Grid project utilities

Session info:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
