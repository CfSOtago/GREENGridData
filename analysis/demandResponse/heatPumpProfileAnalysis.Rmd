---
params:
 title: "Technical Potential of Demand Response"
 subtitle: "Heat Pump Analysis"
title: '`r params$title`'
subtitle: '`r params$subtitle`'
author: 'Carsten Dortans (xxx@otago.ac.nz)'
date: 'Last run at: `r Sys.time()`'
output:
  bookdown::html_document2:
    toc: true
    toc_float: TRUE
    toc_depth: 2
    keep_md: TRUE
    self_contained: no
  bookdown::pdf_document2:
    toc: true
    toc_depth: 2

---




```{r knitrSetup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE) # by default turn off code echo
#options(knitr.table.format = 'markdown') # try to fix the tables issue (seems to be pushing html into latex)
```

```{r codeSetup, include=FALSE}
#rm(list=ls(all=TRUE)) # remove all objects from workspace

# Set start time ----
startTime <- proc.time()

library(GREENGrid)

# Packages needed in this .Rmd file ----
rmdLibs <- c("data.table", # data munching
             "ggplot2", # for fancy graphs
             "lubridate", # date & time processing
             "readr", # writing to files
             "hms", # manipulate h:m:s
             "skimr", # for skim
             "knitr" # for kable
)
# load them
loadLibraries(rmdLibs)


# run gg set up
GREENGrid::setup() # sets a load of parameters which are then accessible via ggParams$xxx

# Local paramaters

sysInfo <- Sys.info()

userName <- sysInfo[[7]] # need this to then set the data location correctly

if(userName == "ben"){
  #ggParams$dataLoc <- path.expand("/Volumes/hum-csafe/Research Projects/GREEN Grid/cleanData/safe/gridSpy/1min/profiles") # <- HPS
  ggParams$dataLoc <- path.expand("~/Dropbox/Work/Carsten_MSc/ggData/profiles/") # <- dropbox
} 
if(userName == "carsten.dortans"){
  ggParams$dataLoc <- path.expand("/Volumes/hum-csafe/Research Projects/GREEN Grid/cleanData/safe/gridSpy/1min/dataExtracts/") # <- server
}
```

\newpage

# Citation

If you wish to use any of the material from this report please cite as:

 * Dortans, C. (`r 1900 + as.POSIXlt(Sys.Date())$year`) `r params$title`: `r params$subtitle`, `r ggParams$pubLoc`.

This work is (c) `r as.POSIXlt(Sys.time())$year + 1900` the University of Southampton.

\newpage

# About

## Circulation

```{r generic circulation, child=ggParams$circulationGenericRmd}
```
 
## Purpose

This report is intended to: 

 * load and test GREEN Grid heat pump and hot water profiles.

## Requirements:

 * test dataset stored at `r ggParams$dataLoc`

## History

```{r child=ggParams$historyGenericRmd}
```
 
Specific history of this code:

 * https://github.com/CfSOtago/GREENGrid/commits/master/analysis/demandResponse/

## Support

```{r child=ggParams$supportGenericRmd}
```
 

# Load data files

## Heat pump profiles

This file is the pre-aggregated data for all heat pump circuits in the GREEN Grid data for April 2015 - March 2016 (check!)

```{r set fileName}
#ggParams$profilesFile <- paste0(ggParams$dataLoc, "Heat #Pump_2015-04-01_2016-03-31_observations.csv.gz")
```

In this section we load and describe the  data files from `r ggParams$profilesFile`.

```{r load data}
#print(paste0("Trying to load: ", ggParams$profilesFile))

heatPumpProfileDT1 <- data.table::as.data.table(
 readr::read_csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/cleanData/safe/gridSpy/1min/dataExtracts/Heat Pump_2015-04-01_2016-03-31_observations.csv.gz",
                       col_types = cols(
                       hhID = col_character(),
                       linkID = col_character(),
                       r_dateTime = col_datetime(format = ""),
                       circuit = col_character(),
                       powerW = col_double() # <- crucial otherwise readr infers integers for some reason
                     )
                 )
)

#heatPumpProfileDT1 <- #data.table::as.data.table(readr::read_csv(ggParams$profilesFile))

heatPumpProfileDT <- heatPumpProfileDT1
heatPumpProfileDT <- heatPumpProfileDT[, year := lubridate::year(r_dateTime)]
heatPumpProfileDT <- heatPumpProfileDT[, obsHourMin := hms::as.hms(r_dateTime)]
heatPumpProfileDT <- heatPumpProfileDT[, month := lubridate::month(r_dateTime)]

heatPumpProfileDT <- heatPumpProfileDT[month == 12 | month == 1 | month == 2, season := "Summer"]
heatPumpProfileDT <- heatPumpProfileDT[month == 3 | month == 4 | month == 5, season := "Autumn"]
heatPumpProfileDT <- heatPumpProfileDT[month == 6 | month == 7 | month == 8, season := "Winter"]
heatPumpProfileDT <- heatPumpProfileDT[month == 9 | month == 10 | month == 11, season := "Spring"]

#Building daily average per season

#heatPumpProfileDT[ , 5][is.na(heatPumpProfileDT[ , 5] ) ] = 0 

heatPumpProfileDT <- heatPumpProfileDT[, .(meanW = mean(powerW, na.rm = TRUE)), keyby = .(obsHourMin, season)]
HeatPumptestDT1 <- copy(heatPumpProfileDT)#Used for test section after lighting analysis






```


Describe using skim:

```{r skimRable}
skimr::skim(heatPumpProfileDT)
```

Draw a plot of GreenGrid heat pump profiles.

```{r profilePlot, fig.cap="Heat pump profiles"}

myPlot <- ggplot2::ggplot(heatPumpProfileDT, aes(x = obsHourMin, colour = season)) +
  geom_point(aes(y = meanW)) +
  facet_grid(season ~ .)

myPlot
```


#Scaling
##Scaling method 1

Now draw a plot of what woud happen if we scaled this up to all NZ households?

Figure \@ref(fig:scaledUpPlots)

```{r scaledUpPlots,fig.cap='Mean Load Heat Pumps by Season'}
nzHH <- 1549890

heatPumpProfileDT <- heatPumpProfileDT[, scaledMWmethod1 := (meanW * nzHH)/10^6]

myPlot <- ggplot2::ggplot(heatPumpProfileDT, aes(x = obsHourMin, colour = season)) +
  geom_point(aes(y = scaledMWmethod1)) +
  facet_grid(season ~ .)

myPlot
```

##Scaling method 2

Alternative calculation method: Assuming EECA data is correct for heat pump value, 1) generating the percentage of total load (peroftotal) while telling data.table to create a new column with the calculation of the percentage. We then multiplied EECA's total GWh with the percentage

```{r new calc}
totalGWH<-708

summeanW<-heatPumpProfileDT[,sum(meanW)]



heatPumpProfileDT <- heatPumpProfileDT[, EECApmMethod2 := (meanW / summeanW) * totalGWH] 

myPlot <- ggplot2::ggplot(heatPumpProfileDT, aes(x = obsHourMin, colour = season)) +
  geom_point(aes(y = EECApmMethod2)) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh')

myPlot
```

#Aggregation to half-hours

So far we have used data at the 1 minute level. This makes for difficulties in comparison with standared electricity sector half-hourly tariff periods etc. This section takes each scaling method, aggregates to half-hours as appropriate and re-plots.

To do that we need to set a half-hour value from the observed time. We do this using truncate so that:

 * 13:18:00 -> 13:00:00
 * 13:40:00 -> 13:30 etc

> NB: This means any plots will be using the 1/2 hour value at the  _start_  of the period!

```{r set halfHours}
# create a 'half hour' variable for aggregation
heatPumpProfileDT <- heatPumpProfileDT[, obsHalfHour := hms::trunc_hms(obsHourMin, 1800)]

# <- this truncates the time to the previous half hour (hms works in seconds so 30 mins * 60 secs = 1800 secs). e.g. 13:18:00 -> 13:00:00 but 13:40:00 -> 13:30 etc

# This means any plots will be using the 1/2 hour value at the  -> start <-  of the period!

# check
head(heatPumpProfileDT)
```

## Method 1

```{r aggregateMethod1}
# aggregate the scaled MW to half hours
# as it is MW we need to take the mean - taking the sum would not be meaningful
method1AggDT <- heatPumpProfileDT[, .(meanMW = mean(scaledMWmethod1)), 
                                  keyby = .(season, obsHalfHour)] # <- takes the mean for each category of half hour & season

#Change the order in facet_grid()
method1AggDT$season <- factor(method1AggDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

myPlot <- ggplot2::ggplot(method1AggDT, aes(x = obsHalfHour, colour = season)) +
  geom_point(aes(y = meanMW)) +
  facet_grid(season ~ .) +
  theme(text = element_text(family = "Cambria")) +
  labs(x='Time of Day', y='Mean MW') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 

myPlot
```


## Method 2
Used the EECA total NZ number for heat pump energy consumption and converted it into GWh. Converted minute data into half-hour steps. 
To do :-)

> NB: should you aggregate this scaling method using mean or sum? Why? :-) -->Since we take the percentages of GWh we need to sum up


```{r aggregateMethod2}
# aggregate the percentage of GWh
method2AggDT <- heatPumpProfileDT[, .(GWh = sum(EECApmMethod2)), 
                                  keyby = .(season, obsHalfHour)] # <- takes the sum for each category of half hour & season

#Change the order in facet_grid()
method2AggDT$season <- factor(method2AggDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

myPlot <- ggplot2::ggplot(method2AggDT, aes(x = obsHalfHour, colour=GWh)) +
  geom_point(aes(y = GWh)) +
  ggtitle("Total New Zealand half hour heat pump energy consumption by season for 2015") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  theme(text = element_text(family = "Cambria")) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) +
scale_colour_gradient(low= "green", high="red")

myPlot
```

#BRANZ vs. EECA comparison
```{r branzvseeca}
nzHHheatPumps <- 515015 #This is based on the BRANZ report of household ownership (House condition survey 2015) and 2013 census data
wToKw <- 1000
assumeDaysPerSeason <- 90

heatPumpProfileDT <- heatPumpProfileDT[, scaledGWh := (((meanW * nzHHheatPumps)/wToKw)*(1/60)*assumeDaysPerSeason)/1000/1000] # <- convert mean W to kWh for all NZ hhs, then assumes 90 days per season and calculate GWh

sumbranzGWh <- heatPumpProfileDT[, sum(scaledGWh)]


diffbranzeeca <- 1-(sumbranzGWh/totalGWH)
skimr::skim(sumbranzGWh)
skimr::skim(totalGWH)
skimr::skim(diffbranzeeca)
```
Wee identify that BRANZ in comination with GREENGrid Grid Spy and 2013 household ownership census data represent a 9% lower total energy consumption for heat pumps than EECA calculates.

EECA total energy consumption by heat pumps for 2015 (totalGWH) <- 708GWh

BRANZ 40% of owner-occupied households and 25% of rentals own heat pumps. Energy consumption based on BRANZ proportion, Census 2013 and GREENGris Grid Spy data (sumbranzGWh) <- 638GWh 


#Yearly consumption
We need the original data for this, currently the data basis is for an average day in each season.
```{r yearlyconsumption}
heatPumpProfileDT <- heatPumpProfileDT[, obsHalfHour := hms::trunc_hms(obsHourMin, 1800)]

```

# Technical potential of demand response: Scenarios for heat pump data
We assume that peak time periods are prevalent from 6.00am-10.00am and from 4.00pm-8.00pm.

## Load curtailment to zero: SC1
In this first scenario we assume that the laod during peak time periods is cut out of the consumption pattern.

###Defining peak/off-peak periods 
Steps:
1) Extracting peak time-periods from heat pump data
2) Building sum of GWh

```{r defining peak/off-peak}

MPS <- hms::as.hms("06:00:00")
MPE <- hms::as.hms("10:00:00")

EPS <- hms::as.hms("17:00:00")
EPE <- hms::as.hms("21:00:00")

OP1S <- hms::as.hms("21:30:00")
OP1E <- hms::as.hms("23:30:00")

OP12S <- hms::as.hms("00:00:00")
OP12E <- hms::as.hms("05:30:00")

OP2S <- hms::as.hms("10:30:00")
OP2E <- hms::as.hms("16:30:00")



sc1data <- heatPumpProfileDT
sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc1data <- sc1data[, .(GWh = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
```


### Visualising periods
```{r visualising peak/off-peak}

#Change the order in facet_grid()
sc1data$season <- factor(sc1data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

myPlot <- ggplot2::ggplot(sc1data, aes(x = obsHalfHour, color=Period)) +
  geom_point(aes(y=GWh), size=1, alpha = 1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total heat pump energy consumption per day by time-period") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_color_discrete(breaks=c("Off Peak 1", "Morning Peak", "Off Peak 2",
                                "Evening Peak")) +
  scale_color_discrete(breaks=c("Off Peak 1", "Morning Peak", "Off Peak 2",
                                "Evening Peak"))+
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total heat pump energy consumption by time-period for 2015.jpeg",
#       dpi=600)
```

### Potential load curtailment output by period in GWh

```{r potential curtailment by season and period}

sc1data <- sc1data[, .(PotCur = sum(GWh)),
                   keyby = .(season, Period)]
sc1data

```

### Visualising curtailed periods

```{r setting peak periods to zero}

sc1data <- heatPumpProfileDT
sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc1data <- sc1data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc1data <- sc1data[, GWh:=GWhs1] # Creating new column GWh based on GWhs1


#sc1data <- sc1data[Period == "Evening Peak",
                   #GWh := 0]

sc1data <- sc1data[, GWh:= ifelse(Period == "Evening Peak", 0, GWh )] # If Period is Evening peak then make GWh zero
                   
sc1data <- sc1data[, GWh:= ifelse(Period == "Morning Peak", 0, GWh )]


#Change the order in facet_grid()
sc1data$season <- factor(sc1data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))
#setnames(sc1data, old=c("GWh"), new=c("MWh"))

myPlot <- ggplot2::ggplot(sc1data, aes(x = obsHalfHour, y = GWh, color=GWh)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total heat pump load curtailment in peak time-periods by season") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  #scale_y_continuous(breaks = c(3, 6, 9, 12)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot
  
#ggsave("Total heat pump load curtailment in peak time-periods by season.jpeg",
     # dpi=600) 

```
##Load curtailment of particular amount: SC2
###Visualising new load profile
```{r Curtail load based on percentage}

sc1data <- heatPumpProfileDT
sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc1data <- sc1data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc1data <- sc1data[, GWh:=GWhs1] # Creating new column GWh based on GWhs1

sc1data <- sc1data[, GWh:= ifelse(Period == "Evening Peak", 0.5*GWh, GWh )] # If Period is Evening peak then change the value of GWh by 50%
                   
sc1data <- sc1data[, GWh:= ifelse(Period == "Morning Peak", GWh*0.5, GWh )]



#Change the order in facet_grid()
sc1data$season <- factor(sc1data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))
#setnames(sc1data, old=c("GWh"), new=c("MWh"))

myPlot <- ggplot2::ggplot(sc1data, aes(x = obsHalfHour, y = GWh, color=GWh)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total heat pump load per curtailment in peak time-periods by season 50%") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous(breaks = c(3, 6, 9, 12)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total heat pump 0.5 load curtailment in peak time-periods by season.jpeg",
    #  dpi=600) 
```
###Potential load curtailment based on percentage curtailed
```{r Potential load curtialment in GWh of percentage curtailment}

sc1data <- sc1data[, .(PotCur = sum(GWh)),
                   keyby = .(season, Period)]
sc1data

```
##Load shifting to prior periods: SC3


```{r load shifting to prior periods}

sc1data <- heatPumpProfileDT
sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc1data <- sc1data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP <- sc1data[season == "Autumn" & Period == "Morning Peak",
                sum(GWhs1)]
WiMP <- sc1data[season == "Winter" & Period == "Morning Peak",
                sum(GWhs1)]
SpMP <- sc1data[season == "Spring" & Period == "Morning Peak",
                sum(GWhs1)]
SuMP <- sc1data[season == "Summer" & Period == "Morning Peak",
                sum(GWhs1)]

AuEP <- sc1data[season == "Autumn" & Period == "Evening Peak",
                sum(GWhs1)]
WiEP <- sc1data[season == "Winter" & Period == "Evening Peak",
                sum(GWhs1)]
SpEP <- sc1data[season == "Spring" & Period == "Evening Peak",
                sum(GWhs1)]
SuEP <- sc1data[season == "Summer" & Period == "Evening Peak",
                sum(GWhs1)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours <- nrow(sc1data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours <- nrow(sc1data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours <- nrow(sc1data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours <- nrow(sc1data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours <- nrow(sc1data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours <- nrow(sc1data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours <- nrow(sc1data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours <- nrow(sc1data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au <- AuMP/AuMPHalfHours
distGWhOP1Wi <- WiMP/WiMPHalfHours
distGWhOP1Sp <- SpMP/SpMPHalfHours
distGWhOP1Su <- SuMP/SuMPHalfHours

distGWhOP2Au <- AuEP/AuEPHalfHours
distGWhOP2Wi <- WiEP/WiEPHalfHours
distGWhOP2Sp <- SpEP/SpEPHalfHours
distGWhOP2Su <- SuEP/SuEPHalfHours



#Adding amount of spreaded peak consumption to off-peak periods
sc1data <- sc1data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Au]
sc1data <- sc1data[season == "Winter" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Wi]
sc1data <- sc1data[season == "Spring" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Sp]
sc1data <- sc1data[season == "Summer" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Su]


sc1data <- sc1data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Au]
sc1data <- sc1data[season == "Winter" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Wi]
sc1data <- sc1data[season == "Spring" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Sp]
sc1data <- sc1data[season == "Summer" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Su]


#Setting missing values in peak periods to NULL
sc1data <- sc1data[, GWhs3:= ifelse(Period =="Morning Peak",
                                  0, GWhs3)]
sc1data <- sc1data[, GWhs3:= ifelse(Period =="Evening Peak",
                                  0, GWhs3)]


#Renaming GWhs3 into GWh to depict the right text in the colorbar
setnames(sc1data, old=c("GWhs3"), new=c("GWh"))

#Visualising only shifted consumption
#myPlot <- ggplot2::ggplot(sc1data, aes(x = obsHalfHour, color=GWh)) +
  #geom_line(aes(y=GWh), size=0.5) +
  #theme(text = element_text(family = "Cambria")) +
  #ggtitle("Total shifted New Zealand half hour heat pump energy consumption by season for 2015") +
  #facet_grid(season ~ .) +
  #labs(x='Time of Day', y='GWh') +
  #scale_y_continuous(breaks = c(4, 8, 12, 16)) +
  #scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
  #hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

#myPlot

#myPlot <- ggplot2::ggplot(sc1data, aes(x = obsHalfHour)) +
 # geom_line(aes(y=GWh, color=GWh), size=0.5) +
  #geom_line(aes(y=GWhs1, color=GWhs1), size=0.5) +
 # theme(text = element_text(family = "Cambria")) +
 # ggtitle("Original and shifted New Zealand half hour heat pump energy consumption by season for 2015") +
 # facet_grid(season ~ .) +
 # labs(x='Time of Day', y='GWh') +
 # scale_y_continuous(breaks = c(4, 8, 12, 16)) +
 # scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
 # hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
 # scale_color_gradient(low= "green", high="red")

#myPlot

#Change the order in facet_grid()
sc1data$season <- factor(sc1data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising shifted and original consumption with labels in different colours
myPlot <- ggplot2::ggplot(sc1data, aes(x = obsHalfHour)) +
  geom_line(aes(y=GWh, color="red"), size=0.5) +
  geom_line(aes(y=GWhs1, color="blue"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Original and shifted New Zealand per day half hour heat pump energy consumption by season for 2015") +
  scale_colour_manual(name = element_blank(), 
         values =c('red'='red','blue'='blue'), labels = c('Original consumption',
                  'Shifted consumption')) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
# scale_y_continuous(breaks = c(4, 8, 12, 16)) +
 scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00")))  
  #scale_color_gradient(low= "green", high="red")

myPlot

#ggsave("Original and shifted New Zealand half hour heat pump energy consumption by season for 2015.jpeg",
     #  dpi=600)

```
#Technical potential of demand response: Scenarios for hot water data

## Loading data

This file is the pre-aggregated data for all hot water  circuits in the GREEN Grid data for April 2015 - March 2016 (check!)

```{r set fileName2}
#ggParams$profilesFile <- paste0(ggParams$dataLoc, "Hot #Water_2015-04-01_2016-03-31_overallSeasonalProfiles.csv.gz")
```

In this section we load and describe the  data files from `r ggParams$profilesFile`.

```{r load data2}
#print(paste0("Trying to load: ", ggParams$profilesFile))
#hotWaterProfileDT <- data.table::as.data.table(readr::read_csv(ggParams$profilesFile))

HotwaterHCS <- data.table::as.data.table(
 readr::read_csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/cleanData/safe/gridSpy/1min/dataExtracts/Hot Water_2015-04-01_2016-03-31_observations.csv.gz",
                       col_types = cols(
                       hhID = col_character(),
                       linkID = col_character(),
                       r_dateTime = col_datetime(format = ""),
                       circuit = col_character(),
                       powerW = col_double() # <- crucial otherwise readr infers integers for some reason
                     )
                 )
)

HotwaterObsDT <- data.table::as.data.table(HotwaterHCS)

HotwaterObsDT <- HotwaterObsDT[, year := lubridate::year(r_dateTime)]
HotwaterObsDT <- HotwaterObsDT[, obsHourMin := hms::as.hms(r_dateTime)]
HotwaterObsDT <- HotwaterObsDT[, month := lubridate::month(r_dateTime)]

HotwaterObsDT <- HotwaterObsDT[month >= 12 | month == 1 | month == 2, season := "Summer"]
HotwaterObsDT <- HotwaterObsDT[month >= 3 | month == 4 | month == 5, season := "Autumn"]
HotwaterObsDT <- HotwaterObsDT[month == 6 | month == 7 | month == 8, season := "Winter"]
HotwaterObsDT <- HotwaterObsDT[month == 9 | month == 10 | month == 11, season := "Spring"]

HotWatertestDT1 <- copy(HotwaterObsDT)#Used for test section after lighting analysis

#Building daily average per season

hotWaterProfileDT <- HotwaterObsDT[, .(meanW = mean(powerW)), keyby = .(obsHourMin, season)]


```

##BRANZ vs. EECA comparison
```{r branzvseeca2}

totalGWH <- 12727.99 * 0.2777777778 #Converting TJ (EECA 2015) into GWh
nzHH <- 1549890 #Based on Census 2013
nzHHhotWater <- nzHH * 0.88 #This is based on the BRANZ report HOT WATER OVER TIME– THE NEW ZEALAND EXPERIENCE (2008) No. 132; 88% of Hot Water Systems were electric in 2008

wToKw <- 1000
assumeDaysPerSeason <- 90

hotWaterProfileDT <- hotWaterProfileDT[, scaledGWh := (((meanW * nzHHhotWater)/wToKw)*(1/60)*assumeDaysPerSeason)/1000/1000] # <- convert mean W to kWh for all NZ hhs, then assumes 90 days per season and calculate GWh

sumbranzGWh <- hotWaterProfileDT[, sum(scaledGWh)]


diffbranzeeca <- 1-(sumbranzGWh/totalGWH)

```
I have used the 2015 EECA data because our load profiles data from the year 2015 as well. This given we identify that EECA assumes 3,535 GWh whereas the combination of BRANZ and Census 2013 calculates an amount of 3,313 GWh. EECA estimates therefore a 6% higher energy consumption of hot water systems in New Zealand using electricity fuel. In the following the BRANZ calculation will be used.

## Aggregation to half-hours and initial plot

So far we have used data at the 1 minute level. This makes for difficulties in comparison with standared electricity sector half-hourly tariff periods etc. This section takes each scaling method, aggregates to half-hours as appropriate and re-plots.

To do that we need to set a half-hour value from the observed time. We do this using truncate so that:

 * 13:18:00 -> 13:00:00
 * 13:40:00 -> 13:30 etc

> NB: This means any plots will be using the 1/2 hour value at the  _start_  of the period!

```{r set halfHours2}
# create a 'half hour' variable for aggregation
hotWaterProfileDT <- hotWaterProfileDT[, obsHalfHour := hms::trunc_hms(obsHourMin, 1800)] # <- this truncates the time to the previous half hour (hms works in seconds so 30 mins * 60 secs = 1800 secs). e.g. 13:18:00 -> 13:00:00 but 13:40:00 -> 13:30 etc

# This means any plots will be using the 1/2 hour value at the  -> start <-  of the period!

method2AggDT <- hotWaterProfileDT[, .(GWh = sum(scaledGWh)), 
                                  keyby = .(season, obsHalfHour)]#Building sum of half hours by season


# check
head(method2AggDT)

#Change the order in facet_grid()
method2AggDT$season <- factor(method2AggDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


myPlot <- ggplot2::ggplot(method2AggDT, aes(x = obsHalfHour, color=GWh)) +
  geom_line(aes(y=GWh), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total New Zealand half hour hot water energy consumption by season for 2015") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
  hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total New Zealand half hour hot water energy consumption by season for 2015.jpeg",
      # dpi = 600)

```
##Load curtailment to zero SC1

```{r load curtailment hot water data}

#Defining peak and off-peak

sc2data <- method2AggDT

#sc2data <- sc2data[, .(GWh = sum(scaledGWh)), 
 #                   keyby = .(season, obsHalfHour)]

sc2data <- sc2data[, Period := "Not Peak"]

sc2data <- sc2data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc2data <- sc2data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc2data <- sc2data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Change the order in facet_grid()
sc2data$season <- factor(sc2data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))
#setnames(sc2data, old=c("GWh"), new=c("MWh"))

#Visualisig peak periods

myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour, color=Period)) +
  geom_point(aes(y=GWh), size=1, alpha = 1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total New Zealand hot water energy consumption by time-period") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_color_discrete(breaks=c("Off Peak 1", "Morning Peak", "Off Peak 2",
                                "Evening Peak")) +
  scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),      hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00")))  
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total New Zealand per day hot water energy consumption by time-period.jpeg",
#       dpi = 600)

#Potential load curtailment by season

sc2data <- sc2data[, .(PotCur = sum(GWh)),
                   keyby = .(season, Period)]
sc2data

```
###Visualising curtailed periods

```{r visalising curtailed hot water consumption}

sc2data <- hotWaterProfileDT
sc2data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc2data <- sc2data[, .(GWhs2 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc2data <- sc2data[, Period := "Not Peak"]

sc2data <- sc2data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc2data <- sc2data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc2data <- sc2data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc2data <- sc2data[, GWh:=GWhs2] # Creating new column GWh based on GWhs2


sc2data <- sc2data[, GWh:= ifelse(Period == "Evening Peak", 0, GWh )] # If Period is Evening peak then make GWh zero
                   
sc2data <- sc2data[, GWh:= ifelse(Period == "Morning Peak", 0, GWh )]


#Change the order in facet_grid()
sc2data$season <- factor(sc2data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))
#setnames(sc2data, old=c("GWh"), new=c("MWh"))

myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour, y = GWh, color=GWh)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total hot water load curtailment in peak time-periods by season") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

 #ggsave("Total hot water load curtailment in peak time-periods by season.jpeg",
        #dpi = 600)

```
##Load curtailment of particular amount (50%): SC2

```{r hot water load consumption curtailment of particular amount}

sc2data <- hotWaterProfileDT
sc2data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc2data <- sc2data[, .(GWhs2 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc2data <- sc2data[, Period := "Not Peak"]

sc2data <- sc2data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc2data <- sc2data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc2data <- sc2data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc2data <- sc2data[, GWh:=GWhs2] # Creating new column GWh based on GWhs2


sc2data <- sc2data[, GWh:= ifelse(Period == "Evening Peak", GWh * 0.5, GWh )] # If Period is Evening peak then make GWh zero
                   
sc2data <- sc2data[, GWh:= ifelse(Period == "Morning Peak", GWh * 0.5, GWh )]


#Change the order in facet_grid()
sc2data$season <- factor(sc2data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))
#setnames(sc2data, old=c("GWh"), new=c("MWh"))

myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour, y = GWh, color=GWh)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("50 per cent per day hot water load curtailment at peak time-periods by season") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00")))  +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("50 per cent hot water load curtailment at peak time-periods by season.jpeg",
 #      dpi = 600)

```
###Potential load curtailment based on percentage

```{r potential load curtailment based on percentage}

sc2data <- sc2data[, .(PotCur = sum(GWh)),
                   keyby = .(season, Period)]
sc2data

```
##Load shifting to prior times: SC3

```{r load shifting to prior periods hot water}
#I had to insert a 2 and 4 respectively in order to allow comparisons between sc1data and sc2data. I can now run the whole script without affecting the variables associated to sc1data


sc2data <- hotWaterProfileDT
sc2data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

  sc2data <- sc2data[, .(GWhs2 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc2data <- sc2data[, Period := "Not Peak"]

sc2data <- sc2data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc2data <- sc2data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc2data <- sc2data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP2 <- sc2data[season == "Autumn" & Period == "Morning Peak",
                sum(GWhs2)]
WiMP2 <- sc2data[season == "Winter" & Period == "Morning Peak",
                sum(GWhs2)]
SpMP2 <- sc2data[season == "Spring" & Period == "Morning Peak",
                sum(GWhs2)]
SuMP2 <- sc2data[season == "Summer" & Period == "Morning Peak",
                sum(GWhs2)]

AuEP2 <- sc2data[season == "Autumn" & Period == "Evening Peak",
                sum(GWhs2)]
WiEP2 <- sc2data[season == "Winter" & Period == "Evening Peak",
                sum(GWhs2)]
SpEP2 <- sc2data[season == "Spring" & Period == "Evening Peak",
                sum(GWhs2)]
SuEP2 <- sc2data[season == "Summer" & Period == "Evening Peak",
                sum(GWhs2)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours2 <- nrow(sc2data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours2 <- nrow(sc2data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours2 <- nrow(sc2data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours2 <- nrow(sc2data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours2 <- nrow(sc2data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours2 <- nrow(sc2data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours2 <- nrow(sc2data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours2 <- nrow(sc2data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au2 <- AuMP2/AuMPHalfHours2
distGWhOP1Wi2 <- WiMP2/WiMPHalfHours2
distGWhOP1Sp2 <- SpMP2/SpMPHalfHours2
distGWhOP1Su2 <- SuMP2/SuMPHalfHours2

distGWhOP2Au2 <- AuEP2/AuEPHalfHours2
distGWhOP2Wi2 <- WiEP2/WiEPHalfHours2
distGWhOP2Sp2 <- SpEP2/SpEPHalfHours2
distGWhOP2Su2 <- SuEP2/SuEPHalfHours2



#Adding amount of spreaded peak consumption to off-peak periods
sc2data <- sc2data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs4 :=
                     GWhs2 + distGWhOP1Au2]
sc2data <- sc2data[season == "Winter" &
                     Period == "Off Peak 1", GWhs4 :=
                     GWhs2 + distGWhOP1Wi2]
sc2data <- sc2data[season == "Spring" &
                     Period == "Off Peak 1", GWhs4 :=
                     GWhs2 + distGWhOP1Sp2]
sc2data <- sc2data[season == "Summer" &
                     Period == "Off Peak 1", GWhs4 :=
                     GWhs2 + distGWhOP1Su2]


sc2data <- sc2data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs4 :=
                     GWhs2 + distGWhOP2Au2]
sc2data <- sc2data[season == "Winter" &
                     Period == "Off Peak 2", GWhs4 :=
                     GWhs2 + distGWhOP2Wi2]
sc2data <- sc2data[season == "Spring" &
                     Period == "Off Peak 2", GWhs4 :=
                     GWhs2 + distGWhOP2Sp2]
sc2data <- sc2data[season == "Summer" &
                     Period == "Off Peak 2", GWhs4 :=
                     GWhs2 + distGWhOP2Su2]


#Setting missing values in peak periods to NULL
sc2data <- sc2data[, GWhs4:= ifelse(Period =="Morning Peak",
                                  0, GWhs4)]
sc2data <- sc2data[, GWhs4:= ifelse(Period =="Evening Peak",
                                  0, GWhs4)]


#Renaming GWhs3 into GWh to depict the right text in the colorbar
setnames(sc2data, old=c("GWhs2"), new=c("GWh"))

#Visualising only shifted consumption
#myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour, color=GWh)) +
  #geom_line(aes(y=GWh), size=0.5) +
  #theme(text = element_text(family = "Cambria")) +
  #ggtitle("Total shifted New Zealand half hour heat pump energy consumption by season for 2015") +
  #facet_grid(season ~ .) +
  #labs(x='Time of Day', y='GWh') +
  #scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  #scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
  #hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

#myPlot

#Visualising shifted and original consumption
#myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour)) +
 # geom_line(aes(y=GWh, color=GWh), size=0.5) +
 # geom_line(aes(y=GWhs4, color=GWhs4), size=0.5) +
 # theme(text = element_text(family = "Cambria")) +
 # ggtitle("Original and shifted New Zealand half hour heat pump energy consumption by season for 2015") +
#  facet_grid(season ~ .) +
#  labs(x='Time of Day', y='GWh') +
 # scale_y_continuous(breaks = c(10, 20, 30, 40)) +
#  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
#  hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
 # scale_color_gradient(low= "green", high="red")

#myPlot

sc2data$season <- factor(sc2data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising shifted and original consumption two colours
  myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour)) +
  geom_line(aes(y=GWh, color="red"), size=0.5) +
  geom_line(aes(y=GWhs4, color="blue"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Original and shifted New Zealand half hour heat pump energy consumption by season for 2015") +
  scale_colour_manual(name = element_blank(), 
         values =c('red'='red','blue'='blue'), labels = c('Original consumption',
                  'Shifted consumption')) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
 

myPlot

#ggsave("Original and shifted New Zealand half hour hot water energy consumption by season for 2015.jpeg",
     #  dpi=600)

```
#Technical potential of demand response: Scenarios for refrigeration data

##Load curtailment to zero
```{r load curtialment to zero all three appliances 1}

totalGWH<-2074 #EECA fro refrigeration in 2015
nzHouseholds <- 1004329 + 453135

refrigerationProfileDT <- copy(heatPumpProfileDT)
refrigerationProfileDT <- refrigerationProfileDT[, scaledGWh := 2074/.N]#Spreading GWh equally



sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum((scaledGWh)/90)*1000), 
                    keyby = .(season, obsHalfHour)]

sc5data <- sc5data[, Period := "Not Peak"]

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


sc5data$season <- factor(sc5data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising peak ond off-peak
myPlot <- ggplot2::ggplot(sc5data, aes(x = obsHalfHour, color=Period)) +
  geom_point(aes(y=GWhREF), size=1, alpha = 1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total consumption refrigeration by season") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
 # scale_y_continuous(breaks = c(20, 40, 60, 80)) +
  scale_color_discrete(breaks=c("Off Peak 1", "Morning Peak", "Off Peak 2",
                                "Evening Peak")) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total consumption refrigeration by season.jpeg", dpi = 600)
```
###Potential load curtailment

```{r potential heat pump, hot water, refrigeration energy curtailment1}


sc5data <- sc5data[, .(PotCur = sum(GWhREF)),
                   keyby = .(season, Period)]
sc5data
```


###Visualising curtailed periods

```{r Visualising rf curtailed periods}
#Defining peak and off-peak for heat pump and hot water seperately


sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc5data <- sc5data[, Period := "Not Peak"]

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]




sc5data <- sc5data[, GWhREF:= ifelse(Period == "Evening Peak"|Period== "Morning Peak"
                                     , 0, GWhREF )] # If Period is Evening peak then make GWh zero
                   





#Renaming PumpandWater to depict the right y in the colorbar
setnames(sc5data, old=c("GWhREF"), new=c("MWh"))

myPlot <- ggplot2::ggplot(sc5data, aes(x = obsHalfHour, y = MWh, color=MWh)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total refrigeration load curtailment in peak time-periods by season") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous(breaks = c(3, 6, 9, 12)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Per_DayTotal refrigeration curtailment in peak time-periods by season.jpeg", dpi = 600)

```
##Load curtailment of particular amount
```{r load curtialmentall three appliances of particular amount1}
#Defining peak and off-peak for heat pump and hot water seperately

sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc5data <- sc5data[, Period := "Not Peak"]

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]





sc5data <- sc5data[, GWhREF:= ifelse(Period == "Evening Peak", GWhREF*0.5, GWhREF )] # If Period is Evening peak then make GWh zero
                   
sc5data <- sc5data[, GWhREF:= ifelse(Period == "Morning Peak", GWhREF*0.5, GWhREF )]

#Renaming PumpandWater to depict the right y in the colorbar
setnames(sc5data, old=c("GWhREF"), new=c("GWh"))


sc5data$season <- factor(sc5data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

myPlot <- ggplot2::ggplot(sc5data, aes(x = obsHalfHour, y = GWh, color=GWh)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total refrigeration 50 per cent load curtailment") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  #scale_y_continuous(breaks = c(2, 4, 6, 8)) +
 scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00")))  +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

ggsave("Total refrigeration 50 per cent load curtailment.jpeg", dpi = 600)

```
###Potential load curtailment heat pump and hot water based on percentage
```{r potential curtailment in GWh rf}


sc5data <- sc5data[, .(PotCur = sum(GWh)),
                   keyby = .(season, Period)]
sc5data

```
##Load shifting to prior times: SC3
```{r rf shifting}


sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc5data <- sc5data[, Period := "Not Peak"]

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]





sc3data <- sc5data






#Building the sum of each peak period by season
AuMP3 <- sc3data[season == "Autumn" & Period == "Morning Peak",
                sum(GWhREF)]
WiMP3 <- sc3data[season == "Winter" & Period == "Morning Peak",
                sum(GWhREF)]
SpMP3 <- sc3data[season == "Spring" & Period == "Morning Peak",
                sum(GWhREF)]
SuMP3 <- sc3data[season == "Summer" & Period == "Morning Peak",
                sum(GWhREF)]

AuEP3 <- sc3data[season == "Autumn" & Period == "Evening Peak",
                sum(GWhREF)]
WiEP3 <- sc3data[season == "Winter" & Period == "Evening Peak",
                sum(GWhREF)]
SpEP3 <- sc3data[season == "Spring" & Period == "Evening Peak",
                sum(GWhREF)]
SuEP3 <- sc3data[season == "Summer" & Period == "Evening Peak",
                sum(GWhREF)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours3 <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours3 <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours3 <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours3 <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours3 <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours3 <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours3 <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours3 <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au3 <- AuMP3/AuMPHalfHours3
distGWhOP1Wi3 <- WiMP3/WiMPHalfHours3
distGWhOP1Sp3 <- SpMP3/SpMPHalfHours3
distGWhOP1Su3 <- SuMP3/SuMPHalfHours3

distGWhOP2Au3 <- AuEP3/AuEPHalfHours3
distGWhOP2Wi3 <- WiEP3/WiEPHalfHours3
distGWhOP2Sp3 <- SpEP3/SpEPHalfHours3
distGWhOP2Su3 <- SuEP3/SuEPHalfHours3



#Adding amount of spreaded peak consumption to off-peak periods
sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs4 :=
                     GWhREF + distGWhOP1Au3]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 1", GWhs4 :=
                     GWhREF + distGWhOP1Wi3]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 1", GWhs4 :=
                     GWhREF + distGWhOP1Sp3]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 1", GWhs4 :=
                     GWhREF + distGWhOP1Su3]


sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs4 :=
                     GWhREF + distGWhOP2Au3]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 2", GWhs4 :=
                     GWhREF + distGWhOP2Wi3]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 2", GWhs4 :=
                     GWhREF + distGWhOP2Sp3]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 2", GWhs4 :=
                     GWhREF + distGWhOP2Su3]


#Setting missing values in peak periods to NULL
sc3data <- sc3data[, GWhs4:= ifelse(Period =="Morning Peak",
                                  0, GWhs4)]
sc3data <- sc3data[, GWhs4:= ifelse(Period =="Evening Peak",
                                  0, GWhs4)]


#Renaming GWhs3 into GWh to depict the right text in the colorbar
#setnames(sc2data, old=c("GWhs4"), new=c("GWh"))

#Visualising only shifted consumption
#myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour, color=GWh)) +
  #geom_line(aes(y=GWh), size=0.5) +
  #theme(text = element_text(family = "Cambria")) +
  #ggtitle("Total shifted New Zealand half hour heat pump energy consumption by season for 2015") +
  #facet_grid(season ~ .) +
  #labs(x='Time of Day', y='GWh') +
  #scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  #scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
  #hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

#myPlot

#Visualising shifted and original consumption
#myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour)) +
 # geom_line(aes(y=GWh, color=GWh), size=0.5) +
 # geom_line(aes(y=GWhs4, color=GWhs4), size=0.5) +
 # theme(text = element_text(family = "Cambria")) +
 # ggtitle("Original and shifted New Zealand half hour heat pump energy consumption by season for 2015") +
#  facet_grid(season ~ .) +
#  labs(x='Time of Day', y='GWh') +
 # scale_y_continuous(breaks = c(10, 20, 30, 40)) +
#  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
#  hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
 # scale_color_gradient(low= "green", high="red")

#myPlot

#Change the order in facet_grid()
sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising only winter 
  myPlot <- ggplot2::ggplot(subset(sc5data, season %in% c("Winter")), aes(x = obsHalfHour)) +
  geom_line(aes(y=GWhREF, color="blue"), size=0.5) +
  geom_line(aes(y=GWhs4, color="red"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Per day original and shifted New Zealand refrigeration energy #consumption by season for 2015") +
  scale_colour_manual(name = element_blank(), 
         values =c('blue'='blue','red'='red'), labels = c('Original consumption',
                  'Shifted consumption')) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh') +
  scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
myPlot

#ggsave("Winter.jpeg", dpi = 600)


# Orifginal plot, the one above depicts winter
#Visualising shifted and original consumption two colours
  myPlot <- ggplot2::ggplot(sc5data, aes(x = obsHalfHour)) +
  geom_line(aes(y=GWhREF, color="red"), size=0.5) +
  geom_line(aes(y=GWhs4, color="blue"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Per day original and shifted New Zealand refrigeration energy consumption by season for 2015") +
  scale_colour_manual(name = element_blank(), 
         values =c('red'='red','blue'='blue'), labels = c('Original consumption',
                 'Shifted consumption')) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
 

myPlot

#ggsave("Total shifted and original refrigeration in GWh.jpeg", dpi = 600)
```


#Both appliances together
##Load curtailment to zero: SC1
###Visualising peak time-periods
```{r heat pump and hot water together}
#Defining peak and off-peak for heat pump and hot water seperately
sc3data <- heatPumpProfileDT


sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


sc32data <- hotWaterProfileDT

sc32data <- sc32data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc32data <- sc32data[, Period := "Not Peak"]

sc32data <- sc32data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc32data <- sc32data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc32data <- sc32data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Copying hot water consumption column into heat pump data table
sc3data <- cbind(sc3data, sc32data[,"GWhHW"])

#Building sum of heat pump and hot water consumption
sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW]

sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising peak ond off-peak
myPlot <- ggplot2::ggplot(sc3data, aes(x = obsHalfHour, color=Period)) +
  geom_point(aes(y=PumpandWater), size=1, alpha = 1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total consumption heat pump and hot water by season") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous(breaks = c(20, 40, 60, 80)) +
  scale_color_discrete(breaks=c("Off Peak 1", "Morning Peak", "Off Peak 2",
                                "Evening Peak")) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total consumption heat pump and hot water by season.jpeg", dpi = 600)
```

###Potential load curtailment

```{r potential heat pump and hot water energy curtailment}


sc3data <- sc3data[, .(PotCur = sum(PumpandWater)),
                   keyby = .(season, Period)]
sc3data









#sc3data <- sc1data
#sc3data[, c("GWhs1"):=NULL] #Deleting unnecessary columns

#Copying the scaled GWh of hot water into the new data table
#sc3data <- cbind(sc3data, sc2data[,"GWhs4"])

#Building the sum of heat pump and hot water scaled numbers in a sepatrate variable
#sc3data <- sc3data[, PumpandWater := GWh + GWhs4]





```
###Visualising curtailed periods

```{r Visualising hp and hw curtailed periods}
#Defining peak and off-peak for heat pump and hot water seperately
sc3data <- heatPumpProfileDT


sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


sc32data <- hotWaterProfileDT

sc32data <- sc32data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc32data <- sc32data[, Period := "Not Peak"]

sc32data <- sc32data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc32data <- sc32data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc32data <- sc32data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Copying hot water consumption column into heat pump data table
sc3data <- cbind(sc3data, sc32data[,"GWhHW"])

#Building sum of heat pump and hot water consumption
sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW]


sc3data <- sc3data[, PumpandWater:= ifelse(Period == "Evening Peak", 0, PumpandWater )] # If Period is Evening peak then make GWh zero
                   
sc3data <- sc3data[, PumpandWater:= ifelse(Period == "Morning Peak", 0, PumpandWater )]



sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))



myPlot <- ggplot2::ggplot(sc3data, aes(x = obsHalfHour, y = PumpandWater, color=PumpandWater)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total heat pump and hot water load curtailment in peak time-periods by season") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous(breaks = c(20, 40, 60, 80)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total heat pump and hot water load curtailment in peak time-periods by season.jpeg", dpi = 600)


```
##Load curtailment of particular amount 50%: SC2
###Visualising new load profile

```{r particular amount of hp and hw}

sc3data <- heatPumpProfileDT


sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]


sc32data <- hotWaterProfileDT

sc32data <- sc32data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc32data <- sc32data[, Period := "Not Peak"]

sc32data <- sc32data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc32data <- sc32data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc32data <- sc32data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Copying hot water consumption column into heat pump data table
sc3data <- cbind(sc3data, sc32data[,"GWhHW"])

#Building sum of heat pump and hot water consumption
sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW]


sc3data <- sc3data[, PumpandWater:= ifelse(Period == "Evening Peak", PumpandWater*0.5, PumpandWater )] # If Period is Evening peak then make GWh zero
                   
sc3data <- sc3data[, PumpandWater:= ifelse(Period == "Morning Peak", PumpandWater*0.5, PumpandWater )]

#Renaming PumpandWater to depict the right y in the colorbar
setnames(sc3data, old=c("PumpandWater"), new=c("GWh"))

sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


myPlot <- ggplot2::ggplot(sc3data, aes(x = obsHalfHour, y = GWh, color=GWh)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total per day heat pump and hot water 50 per cent load curtailment") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous(breaks = c(20, 40, 60, 80)) +
 scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00")))  +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total heat pump and hot water 50 per cent load curtailment.jpeg", dpi = 600)
```

###Potential load curtailment heat pump and hot water based on percentage
```{r potential curtailment in GWh hp and hw}


sc3data <- sc3data[, .(PotCur = sum(GWh)),
                   keyby = .(season, Period)]
sc3data

```
##Load shifting to prior times: SC3
```{r hp and hw load shifting1}

sc3data <- heatPumpProfileDT
sc3data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

  sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]








sc4data <- hotWaterProfileDT

sc4data <- sc4data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc4data <- sc4data[, Period := "Not Peak"]

sc4data <- sc4data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc4data <- sc4data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc4data <- sc4data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc4data <- sc4data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc4data <- sc4data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


sc3data <- cbind(sc3data, sc4data[,"GWhHW"])


sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW]






#Building the sum of each peak period by season
AuMP3 <- sc3data[season == "Autumn" & Period == "Morning Peak",
                sum(PumpandWater)]
WiMP3 <- sc3data[season == "Winter" & Period == "Morning Peak",
                sum(PumpandWater)]
SpMP3 <- sc3data[season == "Spring" & Period == "Morning Peak",
                sum(PumpandWater)]
SuMP3 <- sc3data[season == "Summer" & Period == "Morning Peak",
                sum(PumpandWater)]

AuEP3 <- sc3data[season == "Autumn" & Period == "Evening Peak",
                sum(PumpandWater)]
WiEP3 <- sc3data[season == "Winter" & Period == "Evening Peak",
                sum(PumpandWater)]
SpEP3 <- sc3data[season == "Spring" & Period == "Evening Peak",
                sum(PumpandWater)]
SuEP3 <- sc3data[season == "Summer" & Period == "Evening Peak",
                sum(PumpandWater)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours3 <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours3 <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours3 <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours3 <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours3 <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours3 <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours3 <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours3 <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au3 <- AuMP3/AuMPHalfHours3
distGWhOP1Wi3 <- WiMP3/WiMPHalfHours3
distGWhOP1Sp3 <- SpMP3/SpMPHalfHours3
distGWhOP1Su3 <- SuMP3/SuMPHalfHours3

distGWhOP2Au3 <- AuEP3/AuEPHalfHours3
distGWhOP2Wi3 <- WiEP3/WiEPHalfHours3
distGWhOP2Sp3 <- SpEP3/SpEPHalfHours3
distGWhOP2Su3 <- SuEP3/SuEPHalfHours3



#Adding amount of spreaded peak consumption to off-peak periods
sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs4 :=
                     PumpandWater + distGWhOP1Au3]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 1", GWhs4 :=
                     PumpandWater + distGWhOP1Wi3]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 1", GWhs4 :=
                     PumpandWater + distGWhOP1Sp3]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 1", GWhs4 :=
                     PumpandWater + distGWhOP1Su3]


sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs4 :=
                     PumpandWater + distGWhOP2Au3]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 2", GWhs4 :=
                     PumpandWater + distGWhOP2Wi3]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 2", GWhs4 :=
                     PumpandWater + distGWhOP2Sp3]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 2", GWhs4 :=
                     PumpandWater + distGWhOP2Su3]


#Setting missing values in peak periods to NULL
sc3data <- sc3data[, GWhs4:= ifelse(Period =="Morning Peak",
                                  0, GWhs4)]
sc3data <- sc3data[, GWhs4:= ifelse(Period =="Evening Peak",
                                  0, GWhs4)]


#Renaming GWhs3 into GWh to depict the right text in the colorbar
#setnames(sc2data, old=c("GWhs4"), new=c("GWh"))

#Visualising only shifted consumption
#myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour, color=GWh)) +
  #geom_line(aes(y=GWh), size=0.5) +
  #theme(text = element_text(family = "Cambria")) +
  #ggtitle("Total shifted New Zealand half hour heat pump energy consumption by season for 2015") +
  #facet_grid(season ~ .) +
  #labs(x='Time of Day', y='GWh') +
  #scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  #scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
  #hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

#myPlot

#Visualising shifted and original consumption
#myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour)) +
 # geom_line(aes(y=GWh, color=GWh), size=0.5) +
 # geom_line(aes(y=GWhs4, color=GWhs4), size=0.5) +
 # theme(text = element_text(family = "Cambria")) +
 # ggtitle("Original and shifted New Zealand half hour heat pump energy consumption by season for 2015") +
#  facet_grid(season ~ .) +
#  labs(x='Time of Day', y='GWh') +
 # scale_y_continuous(breaks = c(10, 20, 30, 40)) +
#  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
#  hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
 # scale_color_gradient(low= "green", high="red")

#myPlot

#Change the order in facet_grid()
sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))



#Visualising shifted and original consumption two colours
  myPlot <- ggplot2::ggplot(sc3data, aes(x = obsHalfHour)) +
  geom_line(aes(y=GWhs4, color="red"), size=0.5) +
  geom_line(aes(y=PumpandWater, color="blue"), size=0.5) +
  geom_line(aes(y=GWhHP, color="green"), size=0.5) + 
  geom_line(aes(y=GWhHW, color="black"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Heat pump and hot water appliances together in GWh") +
  scale_colour_manual(name = element_blank(), 
        values = c('red'='red','blue'='blue', 'green'='green', 'black'='black'), labels = c('Orig. HW', 'Orig. HP & HW', 'Orig. HP', 'Shif. HP & HW')) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  #scale_y_continuous(breaks = c(20, 40, 60, 80)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 



myPlot

#ggsave("Heat pump and hot water appliances together in GWh.jpeg", dpi = 600)






```
#All three appliances together
##Generating refrigeration profile
```{r generating refrigeration profile}

totalGWH<-2074 #EECA fro refrigeration in 2015
nzHouseholds <- 1004329 + 453135

refrigerationProfileDT <- copy(heatPumpProfileDT)
refrigerationProfileDT <- refrigerationProfileDT[, scaledGWh := 2074/.N]#Spreading GWh equally

#myPlot <- ggplot2::ggplot(refrigerationProfileDT, aes(x = obsHalfHour, colour = season)) +
 # geom_point(aes(y = scaledGWh)) +
 # facet_grid(season ~ .) +
 #labs(x='Time of Day', y='GWh')

#myPlot
```
##Load curtailment to zero
```{r load curtialment to zero all three appliances}
#Defining peak and off-peak for heat pump and hot water seperately
sc3data <- heatPumpProfileDT


sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


sc32data <- hotWaterProfileDT

sc32data <- sc32data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc32data <- sc32data[, Period := "Not Peak"]

sc32data <- sc32data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc32data <- sc32data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc32data <- sc32data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]



sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc5data <- sc5data[, Period := "Not Peak"]

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Copying hot water consumption column into heat pump data table
sc3data <- cbind(sc3data, sc32data[,"GWhHW"], sc5data[,"GWhREF"])

#Building sum of heat pump and hot water consumption
sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW + GWhREF]

sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising peak ond off-peak
myPlot <- ggplot2::ggplot(sc3data, aes(x = obsHalfHour, color=Period)) +
  geom_point(aes(y=PumpandWater), size=1, alpha = 1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total consumption heat pump, hot water, refrigeration by season") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
 #scale_y_continuous(breaks = c(20, 40, 60, 80)) +
  scale_color_discrete(breaks=c("Off Peak 1", "Morning Peak", "Off Peak 2",
                                "Evening Peak")) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total consumption heat pump, hot water, refrigeration by season.jpeg", dpi = 600)


```
###Potential load curtailment

```{r potential heat pump, hot water, refrigeration energy curtailment}


sc3data <- sc3data[, .(PotCur = sum(PumpandWater)),
                   keyby = .(season, Period)]
sc3data
```
###Visualising curtailed periods

```{r Visualising hp and hw, rf curtailed periods}
#Defining peak and off-peak for heat pump and hot water seperately
sc3data <- heatPumpProfileDT


sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


sc32data <- hotWaterProfileDT

sc32data <- sc32data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc32data <- sc32data[, Period := "Not Peak"]

sc32data <- sc32data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc32data <- sc32data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc32data <- sc32data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]





sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc5data <- sc5data[, Period := "Not Peak"]

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Copying hot water consumption column into heat pump data table
sc3data <- cbind(sc3data, sc32data[,"GWhHW"], sc5data[,"GWhREF"])

#Building sum of heat pump and hot water consumption
sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW + GWhREF]


sc3data <- sc3data[, PumpandWater:= ifelse(Period == "Evening Peak", 0, PumpandWater )] # If Period is Evening peak then make GWh zero
                   
sc3data <- sc3data[, PumpandWater:= ifelse(Period == "Morning Peak", 0, PumpandWater )]



sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Renaming PumpandWater to depict the right y in the colorbar
setnames(sc3data, old=c("PumpandWater"), new=c("GWh"))

myPlot <- ggplot2::ggplot(sc3data, aes(x = obsHalfHour, y = GWh, color=GWh)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total heat pump hot water, refrigeration load curtailment in peak time-periods by season") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
 # scale_y_continuous(breaks = c(20, 40, 60, 80)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total heat pump, hot water load, refrigeration curtailment in peak time-periods by season.jpeg", dpi = 600)


```
##Load curtailment of particular amount
```{r load curtialmentall three appliances of particular amount}
#Defining peak and off-peak for heat pump and hot water seperately
sc3data <- heatPumpProfileDT


sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


sc32data <- hotWaterProfileDT

sc32data <- sc32data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc32data <- sc32data[, Period := "Not Peak"]

sc32data <- sc32data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc32data <- sc32data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc32data <- sc32data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]



sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc5data <- sc5data[, Period := "Not Peak"]

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Copying hot water consumption column into heat pump data table
sc3data <- cbind(sc3data, sc32data[,"GWhHW"], sc5data[,"GWhREF"])

#Building sum of heat pump and hot water consumption
sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW + GWhREF]

sc3data <- sc3data[, PumpandWater:= ifelse(Period == "Evening Peak", PumpandWater*0.5, PumpandWater )] # If Period is Evening peak then make GWh zero
                   
sc3data <- sc3data[, PumpandWater:= ifelse(Period == "Morning Peak", PumpandWater*0.5, PumpandWater )]

#Renaming PumpandWater to depict the right y in the colorbar
setnames(sc3data, old=c("PumpandWater"), new=c("GWh"))


sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

myPlot <- ggplot2::ggplot(sc3data, aes(x = obsHalfHour, y = GWh, color=GWh)) +
  geom_line(size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total heat pump, hot water, refrigeration 50 per cent load curtailment") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
 # scale_y_continuous(breaks = c(20, 40, 60, 80)) +
 scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00")))  +
  scale_colour_gradient(low= "green", high="red", guide = "colorbar")

myPlot

#ggsave("Total heat pump, hot water, refrigeration 50 per cent load curtailment.jpeg", dpi = 600)

```
###Potential load curtailment heat pump and hot water based on percentage
```{r potential curtailment all three appliances in GWh hp and hw, rf}


sc3data <- sc3data[, .(PotCur = sum(GWh)),
                   keyby = .(season, Period)]
sc3data

```
##Load shifting to prior times: SC3
```{r hp and hw load shifting}

sc3data <- heatPumpProfileDT
sc3data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

  sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]








sc4data <- hotWaterProfileDT

sc4data <- sc4data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc4data <- sc4data[, Period := "Not Peak"]

sc4data <- sc4data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc4data <- sc4data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc4data <- sc4data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc4data <- sc4data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc4data <- sc4data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]



sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc5data <- sc5data[, Period := "Not Peak"]

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


sc3data <- cbind(sc3data, sc4data[,"GWhHW"], sc5data[,"GWhREF"])


sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW + GWhREF]






#Building the sum of each peak period by season
AuMP3 <- sc3data[season == "Autumn" & Period == "Morning Peak",
                sum(PumpandWater)]
WiMP3 <- sc3data[season == "Winter" & Period == "Morning Peak",
                sum(PumpandWater)]
SpMP3 <- sc3data[season == "Spring" & Period == "Morning Peak",
                sum(PumpandWater)]
SuMP3 <- sc3data[season == "Summer" & Period == "Morning Peak",
                sum(PumpandWater)]

AuEP3 <- sc3data[season == "Autumn" & Period == "Evening Peak",
                sum(PumpandWater)]
WiEP3 <- sc3data[season == "Winter" & Period == "Evening Peak",
                sum(PumpandWater)]
SpEP3 <- sc3data[season == "Spring" & Period == "Evening Peak",
                sum(PumpandWater)]
SuEP3 <- sc3data[season == "Summer" & Period == "Evening Peak",
                sum(PumpandWater)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours3 <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours3 <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours3 <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours3 <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours3 <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours3 <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours3 <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours3 <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au3 <- AuMP3/AuMPHalfHours3
distGWhOP1Wi3 <- WiMP3/WiMPHalfHours3
distGWhOP1Sp3 <- SpMP3/SpMPHalfHours3
distGWhOP1Su3 <- SuMP3/SuMPHalfHours3

distGWhOP2Au3 <- AuEP3/AuEPHalfHours3
distGWhOP2Wi3 <- WiEP3/WiEPHalfHours3
distGWhOP2Sp3 <- SpEP3/SpEPHalfHours3
distGWhOP2Su3 <- SuEP3/SuEPHalfHours3



#Adding amount of spreaded peak consumption to off-peak periods
sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs4 :=
                     PumpandWater + distGWhOP1Au3]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 1", GWhs4 :=
                     PumpandWater + distGWhOP1Wi3]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 1", GWhs4 :=
                     PumpandWater + distGWhOP1Sp3]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 1", GWhs4 :=
                     PumpandWater + distGWhOP1Su3]


sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs4 :=
                     PumpandWater + distGWhOP2Au3]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 2", GWhs4 :=
                     PumpandWater + distGWhOP2Wi3]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 2", GWhs4 :=
                     PumpandWater + distGWhOP2Sp3]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 2", GWhs4 :=
                     PumpandWater + distGWhOP2Su3]


#Setting missing values in peak periods to NULL
sc3data <- sc3data[, GWhs4:= ifelse(Period =="Morning Peak",
                                  0, GWhs4)]
sc3data <- sc3data[, GWhs4:= ifelse(Period =="Evening Peak",
                                  0, GWhs4)]


#Renaming GWhs3 into GWh to depict the right text in the colorbar
#setnames(sc2data, old=c("GWhs4"), new=c("GWh"))

#Visualising only shifted consumption
#myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour, color=GWh)) +
  #geom_line(aes(y=GWh), size=0.5) +
  #theme(text = element_text(family = "Cambria")) +
  #ggtitle("Total shifted New Zealand half hour heat pump energy consumption by season for 2015") +
  #facet_grid(season ~ .) +
  #labs(x='Time of Day', y='GWh') +
  #scale_y_continuous(breaks = c(10, 20, 30, 40)) +
  #scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
  #hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
  #scale_colour_gradient(low= "green", high="red", guide = "colorbar")

#myPlot

#Visualising shifted and original consumption
#myPlot <- ggplot2::ggplot(sc2data, aes(x = obsHalfHour)) +
 # geom_line(aes(y=GWh, color=GWh), size=0.5) +
 # geom_line(aes(y=GWhs4, color=GWhs4), size=0.5) +
 # theme(text = element_text(family = "Cambria")) +
 # ggtitle("Original and shifted New Zealand half hour heat pump energy consumption by season for 2015") +
#  facet_grid(season ~ .) +
#  labs(x='Time of Day', y='GWh') +
 # scale_y_continuous(breaks = c(10, 20, 30, 40)) +
#  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
#  hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
 # scale_color_gradient(low= "green", high="red")

#myPlot

#Change the order in facet_grid()
sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))



#Visualising shifted and original consumption two colours
  myPlot <- ggplot2::ggplot(sc3data, aes(x = obsHalfHour)) +
  geom_line(aes(y=GWhREF, color="orange"), size=0.5) +  
  geom_line(aes(y=GWhs4, color="red"), size=0.5) +
  #geom_line(aes(y=PumpandWater, color="blue"), size=0.5) +
  geom_line(aes(y=GWhHP, color="green"), size=0.5) + 
  geom_line(aes(y=GWhHW, color="black"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total heat pump, hot water, refrigeration appliances together in GWh") +
  scale_colour_manual(name = element_blank(), 
        values = c('orange'='orange', 'red'='red','blue'='blue', 'green'='green', 'black'='black'), labels = c('Orig. HW', 'Orig. HP|HW|REF', 'Orig. HP', 'Orig. REF', 'Shif. HP|HW|REF')) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  #scale_y_continuous(breaks = c(20, 40, 60, 80)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 



myPlot

#ggsave("Total heat pump, hot water, refrigeration appliances together in GWh.jpeg", dpi = 600)
```




#Economic analysis
## Reading original data
```{r Loading wholesale prices}

WholesalePrices  <- "/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/EA_Wholesale_Prices/Wholesale_16-17_clean.csv"


print(paste0("Trying to load: ", WholesalePrices))

PricesDT <- data.table::as.data.table(readr::read_csv(WholesalePrices)) # reading data
```

## Time adjustments
```{r Time adjustments}
PricesDT <- PricesDT[, dateTimeStartUTC := lubridate::dmy_hm(`Period start`)] # creating column based on orig. data
PricesDT <- PricesDT[, dateTimeStart := lubridate::force_tz(dateTimeStartUTC, tz = "Pacific/Auckland")] # changing time to NZST
PricesDT$dateTimeStartUTC <- NULL
PricesDT <- PricesDT[, dstFlag := lubridate::dst(dateTimeStart)]
#PricesDT[, .(n = .N), keyby = .(month = lubridate::month(dateTimeStart), dstFlag)]# Daylight saving test
```

## Defining seasons
```{r Defining seasons}

PricesDT <- PricesDT[, month := lubridate::month(dateTimeStart)]

PricesDT <- PricesDT[month >= 9 & month <= 11, season := "Spring"]
PricesDT <- PricesDT[month == 12 | month == 1 | month == 2, season := "Summer"]
PricesDT <- PricesDT[month == 3 | month == 4 | month == 5, season := "Autumn"]
PricesDT <- PricesDT[month == 6 | month == 7 | month == 8, season := "Winter"]

```

## Mean Price per MWh
```{r Mean Price by season, region and half hour}
PricesDT <- PricesDT[, obsHalfHour := hms::as.hms(dateTimeStart)] # creating time column without date


SeasonAvgDT <- PricesDT[, .(meanprice = mean(`Price ($/MWh)`)), keyby = .(season, obsHalfHour, Region)]

```

### Visualisation
```{r test plot}
SeasonAvgDT$season <- factor(SeasonAvgDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

myPlot <- ggplot2::ggplot(SeasonAvgDT, aes(x = obsHalfHour)) +
  geom_line(aes(y=meanprice, color= Region), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Wholesale electricity prices 01.09.2016-31.08.2017") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='NZD/MWh') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),
                          hms::as.hms("12:00:00"), hms::as.hms("16:00:00"),
                          hms::as.hms("20:00:00")))
myPlot


#ggsave("Mean wholesale prices $ per MWh by season.jpeg", dpi = 600)
```

## Calculations
###Refrigeration economic value 
####Baseline value
```{r refrigeration setting peak periods to zero economic value2}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc0data <- refrigerationProfileDT
sc0data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc0data <- sc0data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc0data <- sc0data[, Period := "Not Peak"]

sc0data <- sc0data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc0data <- sc0data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc0data <- sc0data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc0data <- sc0data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc0data <- sc0data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


#Economic evaluation begins
sc0data <- sc0data[, MWh:=GWhs1*fac1000] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc0data, season, obsHalfHour)

Mergedsc0DT <- sc0data[SeasonAvgDT]

Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := 0]

Mergedsc0DT <- Mergedsc0DT[, MWh := MWh/5]

Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := MWh * (meanprice)/1000000, 
                           keyby = .(season, Region, obsHalfHour)]

#Change the order in facet_grid()
Mergedsc0DT$season <- factor(Mergedsc0DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))



#ggsave("Cost baseline scenario time of day.jpeg", dpi = 600)

#Building season sum by period
#Mergedsc0DT <- Mergedsc0DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(season, Region, Period)]
```
####Load curtailment to zero SC1

```{r refri. setting peak periods to zero economic value}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc1data <- refrigerationProfileDT
sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc1data <- sc1data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


#Economic evaluation begins
sc1data <- sc1data[, MWh:=GWhs1*fac1000] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc1data, season, obsHalfHour)

Mergedsc1DT <- sc1data[SeasonAvgDT]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := 0]
Mergedsc1DT <- Mergedsc1DT[, MWh := MWh / 5]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                (MWh * (meanprice))),
                           keyby = .(season, Region, obsHalfHour)] 


#Change the order in facet_grid()
Mergedsc1DT$season <- factor(Mergedsc1DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))



#Mergedsc1DT <- Mergedsc1DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]


```

####Load curtailment of particular amount: SC2

```{r refrig. economic value of particular amount}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc2data <- refrigerationProfileDT
sc2data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc2data <- sc2data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc2data <- sc2data[, Period := "Not Peak"]

sc2data <- sc2data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc2data <- sc2data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc2data <- sc2data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc2data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc2data <- sc2data[, MWh:= ifelse(Period == "Morning Peak" |
                                    Period == "Evening Peak", GWhs1*1000*0.5, GWhs1*1000)] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)

setkey(sc2data, season, obsHalfHour)

Mergedsc2DT <- sc2data[SeasonAvgDT]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := 0]
Mergedsc2DT <- Mergedsc2DT[, MWh := MWh / 5]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                MWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)] 

#Change the order in facet_grid()
Mergedsc2DT$season <- factor(Mergedsc2DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising only shifted consumption
myPlot <- ggplot2::ggplot(Mergedsc2DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Economic value of particular amount by region") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Economic value $/MWh') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                          hms::as.hms("09:00:00"), hms::as.hms("12:00:00"),
                          hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00")))
myPlot

#Mergedsc2DT <- Mergedsc2DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]



```

####Load shifting to prior time periods: SC3
```{r refrig. economic value load shifting heat pumps}


sc3data <- refrigerationProfileDT
sc3data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc3data <- sc3data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP <- sc3data[season == "Autumn" & Period == "Morning Peak",
                sum(GWhs1)]
WiMP <- sc3data[season == "Winter" & Period == "Morning Peak",
                sum(GWhs1)]
SpMP <- sc3data[season == "Spring" & Period == "Morning Peak",
                sum(GWhs1)]
SuMP <- sc3data[season == "Summer" & Period == "Morning Peak",
                sum(GWhs1)]

AuEP <- sc3data[season == "Autumn" & Period == "Evening Peak",
                sum(GWhs1)]
WiEP <- sc3data[season == "Winter" & Period == "Evening Peak",
                sum(GWhs1)]
SpEP <- sc3data[season == "Spring" & Period == "Evening Peak",
                sum(GWhs1)]
SuEP <- sc3data[season == "Summer" & Period == "Evening Peak",
                sum(GWhs1)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au <- AuMP/AuMPHalfHours
distGWhOP1Wi <- WiMP/WiMPHalfHours
distGWhOP1Sp <- SpMP/SpMPHalfHours
distGWhOP1Su <- SuMP/SuMPHalfHours

distGWhOP2Au <- AuEP/AuEPHalfHours
distGWhOP2Wi <- WiEP/WiEPHalfHours
distGWhOP2Sp <- SpEP/SpEPHalfHours
distGWhOP2Su <- SuEP/SuEPHalfHours



#Adding amount of spreaded peak consumption to off-peak periods
sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Su]


sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Su]


#Setting missing values in peak periods to NULL
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Morning Peak",
                                  0, GWhs3)]
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Evening Peak",
                                  0, GWhs3)]
#Economic value starts::

#Creating new column
sc3data <- sc3data[, DiffOrigMWh := 0]
#Calculating the amount added due to load shifting + converting to MWh
sc3data <- sc3data[, DiffOrigMWh := ifelse(GWhs3 > 0,
                                           (GWhs3-GWhs1) * 1000, (0-GWhs1 * 1000))]
#Preparation for merging DTs
setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc3data, season, obsHalfHour)

#Merging
Mergedsc3DT <- sc3data[SeasonAvgDT]
Mergedsc3DT <- Mergedsc3DT[, DiffOrigMWh := DiffOrigMWh / 5]
Mergedsc3DT <- Mergedsc3DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                DiffOrigMWh * (meanprice),
                                                DiffOrigMWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)]#WARNING DiffOrigMWh represents distinction between positive and negative already


#Change the order in facet_grid()
Mergedsc3DT$season <- factor(Mergedsc3DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Putting all values together and check!
EcoVaHHDT <- copy(Mergedsc0DT)

setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("Baseline"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc1DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc2DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc*0.5@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc3DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLs"))

EcoVaHHDT <- EcoVaHHDT[, c("GWhs1", "MWh") := NULL]

EcoVaHHDT <- EcoVaHHDT[, meanprice := meanprice + 0,
                 keyby = .(season, Region, obsHalfHour)]

```
####Visualisation refrigeration
```{r refrig. economic visualisation SC0}

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, Baseline := Baseline]# Converting to million $
EcoVaSumSC0DT <- EcoVaSumDT[, (Baseline = sum(Baseline)), keyby = .(Region, season, Period)]


EcoVaSumSC0DT$Period <- factor(EcoVaSumSC0DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)

SavingsMillionNZD <- CostBaseline-CostBaseline
SavingsPercent <- 0#Compared to Baseline

SavingsMillionNZD
SavingsPercent

myPlot <- ggplot2::ggplot(EcoVaSumSC0DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for heat pumps") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Baseline scenario: Cost for heat pumps by period.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC0DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for heat pumps in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Baseline scenario: Cost for heat pumps in winter by period.jpeg", dpi = 600)                        

```
```{r 1 economic visualisation SC1 1}
#Plots cost of load curtailment to zero, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := ifelse(Period == "Morning Peak" |
                                                      Period == "Evening Peak", 0,
                                                    `EcoVaLc@Peak`)]
EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumDT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostEcoVaLc@Peak` <- sum(EcoVaSumDT$`EcoVaLc@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc@Peak`
SavingsPercent <- 1-(`CostEcoVaLc@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent

#Visualisation
myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost for heat pumps") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Cost for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost per day for heat pumps in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Cost per day for heat pumps in winter.jpeg", dpi = 600)
```
```{r 1 economic visualisation SC1 2}
#Plots benefits when load is curtailed to zero 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC1DT <- EcoVaSumDT
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := ifelse(Period == "Off Peak 1" |
                                                            Period == "Off Peak 2", 0,
                                                          `EcoVaLc@Peak`*(-1))]#We want to disply savings
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumSC1DT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for heat pumps") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Savings at peak time-periods for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for heat pumps in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Savings at peak time-periods for heat pumps in winter.jpeg", dpi = 600)
```
```{r 1 economic visualisation SC2 1}

#Plots cost and benefits of load curtailment to 0.5, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Morning Peak" |
                                                          Period == "Evening Peak",
                                              (Baseline*0.5)*1000000,`EcoVaLc*0.5@Peak`)]

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumDT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1",
                                                                "Morning Peak",
                                                                "Off Peak 2",
                                                                "Evening Peak"))

#Analysis

`CostEcoVaLc*0.5@Peak` <- sum(EcoVaSumDT$`EcoVaLc*0.5@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc*0.5@Peak`
SavingsPercent <- 1-(`CostEcoVaLc*0.5@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent


myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for heat pumps") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Cost for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for heat pumps in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot

#ggsave("Load curtailment 0.5 scenario: Cost for heat pumps in winter.jpeg", dpi = 600)
```
```{r 1 economic visualisation SC2 2}

#Plots benefits when load is curtailed to 0.5 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC2DT <- EcoVaSumDT
EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Off Peak 1"|
                                                            Period == "Off Peak 2",0,
                                 `EcoVaLc*0.5@Peak`*(-1))]#We want to disply savings


EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumSC2DT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for heat pumps") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for heat pumps in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for heat pumps in winter.jpeg", dpi = 600)
```
```{r  1 economic visualisation SC3 1}

#Plots cost and benefits of load shifting, does not consider baseline but increases costs at off peaks
EcoVaSumDT <- copy(EcoVaHHDT)


EcoVaSumDT <- EcoVaSumDT[, EcoSummary := ifelse(Period == "Off Peak 1" |
                                               Period == "Off Peak 2",
                                             Baseline + (EcoVaLs/1000000), 0)]#It has to be zero 



#EcoVaSumDT <- EcoVaSumDT[, `EcoSummary` := `EcoSummary`/1000000]# Converting to million $
EcoVaSumSC3DT <- EcoVaSumDT[, (`EcoSummary` = sum(`EcoSummary`)), keyby = .(Region, season, Period)]

EcoVaSumSC3DT$Period <- factor(EcoVaSumSC3DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))





#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostLoadShif` <- sum(EcoVaSumDT$`EcoSummary`)

SavingsMillionNZD <- CostBaseline - `CostLoadShif`
SavingsPercent <- 1-(`CostLoadShif` / CostBaseline)

SavingsMillionNZD
SavingsPercent




myPlot <- ggplot2::ggplot(EcoVaSumSC3DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for heat pumps") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load shifting scenario: Cost for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC3DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for heat pumps in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Load shifting scenario: Cost for heat pumps in winter.jpeg", dpi = 600)
```
###Heat pump economic value 
####Baseline value
```{r setting peak periods to zero economic value2}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc0data <- heatPumpProfileDT
sc0data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc0data <- sc0data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc0data <- sc0data[, Period := "Not Peak"]

sc0data <- sc0data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc0data <- sc0data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc0data <- sc0data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc0data <- sc0data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc0data <- sc0data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


#Economic evaluation begins
sc0data <- sc0data[, MWh:=GWhs1*fac1000] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc0data, season, obsHalfHour)

Mergedsc0DT <- sc0data[SeasonAvgDT]

Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := 0]

Mergedsc0DT <- Mergedsc0DT[, MWh := MWh /5]

Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := MWh * (meanprice)/1000000, 
                           keyby = .(season, Region, obsHalfHour)]

#Change the order in facet_grid()
Mergedsc0DT$season <- factor(Mergedsc0DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising
myPlot <- ggplot2::ggplot(Mergedsc0DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Costs baseline scenario time of day") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Cost in million NZD') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),
                          hms::as.hms("12:00:00"), hms::as.hms("16:00:00"),
                          hms::as.hms("20:00:00")))
myPlot

#ggsave("Cost baseline scenario time of day.jpeg", dpi = 600)

#Building season sum by period
#Mergedsc0DT <- Mergedsc0DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(season, Region, Period)]
```
####Load curtailment to zero SC1

```{r setting peak periods to zero economic value}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc1data <- heatPumpProfileDT
sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc1data <- sc1data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


#Economic evaluation begins
sc1data <- sc1data[, MWh:=GWhs1*fac1000] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc1data, season, obsHalfHour)

Mergedsc1DT <- sc1data[SeasonAvgDT]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := 0]
Mergedsc1DT <- Mergedsc1DT[, MWh := MWh /5]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                (MWh * (meanprice))),
                           keyby = .(season, Region, obsHalfHour)] 


#Change the order in facet_grid()
Mergedsc1DT$season <- factor(Mergedsc1DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising
myPlot <- ggplot2::ggplot(Mergedsc1DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Economic value of load curtailment to zero by region") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Economic value $/MWh') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                          hms::as.hms("09:00:00"), hms::as.hms("12:00:00"),
                          hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00")))
myPlot

#Mergedsc1DT <- Mergedsc1DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]


```

####Load curtailment of particular amount: SC2

```{r economic value of particular amount}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc2data <- heatPumpProfileDT
sc2data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc2data <- sc2data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc2data <- sc2data[, Period := "Not Peak"]

sc2data <- sc2data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc2data <- sc2data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc2data <- sc2data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc2data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc2data <- sc2data[, MWh:= ifelse(Period == "Morning Peak" |
                                    Period == "Evening Peak", GWhs1*1000*0.5, GWhs1*1000)] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)

setkey(sc2data, season, obsHalfHour)

Mergedsc2DT <- sc2data[SeasonAvgDT]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := 0]

Mergedsc2DT <- Mergedsc2DT[, MWh := MWh /5]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                MWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)] 

#Change the order in facet_grid()
Mergedsc2DT$season <- factor(Mergedsc2DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising only shifted consumption
myPlot <- ggplot2::ggplot(Mergedsc2DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Economic value of particular amount by region") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Economic value $/MWh') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                          hms::as.hms("09:00:00"), hms::as.hms("12:00:00"),
                          hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00")))
myPlot

#Mergedsc2DT <- Mergedsc2DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]



```

####Load shifting to prior time periods: SC3
```{r economic value load shifting heat pumps}


sc3data <- heatPumpProfileDT
sc3data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc3data <- sc3data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP <- sc3data[season == "Autumn" & Period == "Morning Peak",
                sum(GWhs1)]
WiMP <- sc3data[season == "Winter" & Period == "Morning Peak",
                sum(GWhs1)]
SpMP <- sc3data[season == "Spring" & Period == "Morning Peak",
                sum(GWhs1)]
SuMP <- sc3data[season == "Summer" & Period == "Morning Peak",
                sum(GWhs1)]

AuEP <- sc3data[season == "Autumn" & Period == "Evening Peak",
                sum(GWhs1)]
WiEP <- sc3data[season == "Winter" & Period == "Evening Peak",
                sum(GWhs1)]
SpEP <- sc3data[season == "Spring" & Period == "Evening Peak",
                sum(GWhs1)]
SuEP <- sc3data[season == "Summer" & Period == "Evening Peak",
                sum(GWhs1)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au <- AuMP/AuMPHalfHours
distGWhOP1Wi <- WiMP/WiMPHalfHours
distGWhOP1Sp <- SpMP/SpMPHalfHours
distGWhOP1Su <- SuMP/SuMPHalfHours

distGWhOP2Au <- AuEP/AuEPHalfHours
distGWhOP2Wi <- WiEP/WiEPHalfHours
distGWhOP2Sp <- SpEP/SpEPHalfHours
distGWhOP2Su <- SuEP/SuEPHalfHours



#Adding amount of spreaded peak consumption to off-peak periods
sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Su]


sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Su]


#Setting missing values in peak periods to NULL
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Morning Peak",
                                  0, GWhs3)]
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Evening Peak",
                                  0, GWhs3)]
#Economic value starts::

#Creating new column
sc3data <- sc3data[, DiffOrigMWh := 0]
#Calculating the amount added due to load shifting + converting to MWh
sc3data <- sc3data[, DiffOrigMWh := ifelse(GWhs3 > 0,
                                           (GWhs3-GWhs1) * 1000, (0-GWhs1 * 1000))]
#Preparation for merging DTs
setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc3data, season, obsHalfHour)

#Merging
Mergedsc3DT <- sc3data[SeasonAvgDT]
Mergedsc3DT <- Mergedsc3DT[, DiffOrigMWh := DiffOrigMWh /5]

Mergedsc3DT <- Mergedsc3DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                DiffOrigMWh * (meanprice),
                                                DiffOrigMWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)]#WARNING DiffOrigMWh represents distinction between positive and negative already


#Change the order in facet_grid()
Mergedsc3DT$season <- factor(Mergedsc3DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Putting all values together and check!
EcoVaHHDT <- copy(Mergedsc0DT)

setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("Baseline"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc1DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc2DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc*0.5@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc3DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLs"))

EcoVaHHDT <- EcoVaHHDT[, c("GWhs1", "MWh") := NULL]

EcoVaHHDT <- EcoVaHHDT[, meanprice := meanprice + 0,
                 keyby = .(season, Region, obsHalfHour)]

```
####Visualisation heat pump
```{r economic visualisation SC0}

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, Baseline := Baseline]# Converting to million $
EcoVaSumSC0DT <- EcoVaSumDT[, (Baseline = sum(Baseline)), keyby = .(Region, season, Period)]


EcoVaSumSC0DT$Period <- factor(EcoVaSumSC0DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)

SavingsMillionNZD <- CostBaseline-CostBaseline
SavingsPercent <- 0#Compared to Baseline

SavingsMillionNZD
SavingsPercent

myPlot <- ggplot2::ggplot(EcoVaSumSC0DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for heat pumps") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Baseline scenario: Cost for heat pumps by period.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC0DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for heat pumps in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Baseline scenario: Cost for heat pumps in winter by period.jpeg", dpi = 600)                        

```
```{r economic visualisation SC1 1}
#Plots cost of load curtailment to zero, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := ifelse(Period == "Morning Peak" |
                                                      Period == "Evening Peak", 0,
                                                    `EcoVaLc@Peak`)]
EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumDT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostEcoVaLc@Peak` <- sum(EcoVaSumDT$`EcoVaLc@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc@Peak`
SavingsPercent <- 1-(`CostEcoVaLc@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent

#Visualisation
myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost for heat pumps") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Cost for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost per day for heat pumps in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Cost per day for heat pumps in winter.jpeg", dpi = 600)
```
```{r economic visualisation SC1 2}
#Plots benefits when load is curtailed to zero 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC1DT <- EcoVaSumDT
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := ifelse(Period == "Off Peak 1" |
                                                            Period == "Off Peak 2", 0,
                                                          `EcoVaLc@Peak`*(-1))]#We want to disply savings
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumSC1DT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for heat pumps") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Savings at peak time-periods for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for heat pumps in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Savings at peak time-periods for heat pumps in winter.jpeg", dpi = 600)
```
```{r economic visualisation SC2 1}

#Plots cost and benefits of load curtailment to 0.5, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Morning Peak" |
                                                          Period == "Evening Peak",
                                              (Baseline*0.5)*1000000,`EcoVaLc*0.5@Peak`)]

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumDT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1",
                                                                "Morning Peak",
                                                                "Off Peak 2",
                                                                "Evening Peak"))

#Analysis

`CostEcoVaLc*0.5@Peak` <- sum(EcoVaSumDT$`EcoVaLc*0.5@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc*0.5@Peak`
SavingsPercent <- 1-(`CostEcoVaLc*0.5@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent


myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for heat pumps") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Cost for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for heat pumps in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot

#ggsave("Load curtailment 0.5 scenario: Cost for heat pumps in winter.jpeg", dpi = 600)
```
```{r economic visualisation SC2 2}

#Plots benefits when load is curtailed to 0.5 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC2DT <- EcoVaSumDT
EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Off Peak 1"|
                                                            Period == "Off Peak 2",0,
                                 `EcoVaLc*0.5@Peak`*(-1))]#We want to disply savings


EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumSC2DT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for heat pumps") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for heat pumps in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for heat pumps in winter.jpeg", dpi = 600)
```
```{r  economic visualisation SC3 1}

#Plots cost and benefits of load shifting, does not consider baseline but increases costs at off peaks
EcoVaSumDT <- copy(EcoVaHHDT)


EcoVaSumDT <- EcoVaSumDT[, EcoSummary := ifelse(Period == "Off Peak 1" |
                                               Period == "Off Peak 2",
                                             Baseline + (EcoVaLs/1000000), 0)]#It has to be zero 



#EcoVaSumDT <- EcoVaSumDT[, `EcoSummary` := `EcoSummary`/1000000]# Converting to million $
EcoVaSumSC3DT <- EcoVaSumDT[, (`EcoSummary` = sum(`EcoSummary`)), keyby = .(Region, season, Period)]

EcoVaSumSC3DT$Period <- factor(EcoVaSumSC3DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))





#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostLoadShif` <- sum(EcoVaSumDT$`EcoSummary`)

SavingsMillionNZD <- CostBaseline - `CostLoadShif`
SavingsPercent <- 1-(`CostLoadShif` / CostBaseline)

SavingsMillionNZD
SavingsPercent




myPlot <- ggplot2::ggplot(EcoVaSumSC3DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for heat pumps") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load shifting scenario: Cost for heat pumps.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC3DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for heat pumps in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Load shifting scenario: Cost for heat pumps in winter.jpeg", dpi = 600)
```
###Hot water economic value
####Baseline
```{r calculating baseline scenario SC0}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc0data <- hotWaterProfileDT
sc0data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc0data <- sc0data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc0data <- sc0data[, Period := "Not Peak"]

sc0data <- sc0data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc0data <- sc0data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc0data <- sc0data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc0data <- sc0data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc0data <- sc0data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


#Economic evaluation begins
sc0data <- sc0data[, MWh:=GWhs1*fac1000] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc0data, season, obsHalfHour)

Mergedsc0DT <- sc0data[SeasonAvgDT]

Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := 0]

Mergedsc0DT <- Mergedsc0DT[, MWh := MWh / 5]

Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := (MWh * (meanprice)/1000000), 
                           keyby = .(season, Region, obsHalfHour)]

#Change the order in facet_grid()
Mergedsc0DT$season <- factor(Mergedsc0DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising
myPlot <- ggplot2::ggplot(Mergedsc0DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Costs baseline scenario time of day for hot water") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Cost in million NZD') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),
                          hms::as.hms("12:00:00"), hms::as.hms("16:00:00"),
                          hms::as.hms("20:00:00")))
myPlot

#ggsave("Cost per day baseline scenario time of day.jpeg", dpi = 600)

#Building season sum by period
#Mergedsc0DT <- Mergedsc0DT[, .(EcoVal = sum(ecoValueHH)),
                  # keyby = .(season, Region, Period)]
```
####Load curtailment to zero SC1

```{r setting peak periods to zero economic value hot water}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc1data <- hotWaterProfileDT
sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc1data <- sc1data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


#Economic evaluation begins
sc1data <- sc1data[, MWh:=GWhs1*fac1000] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc1data, season, obsHalfHour)

Mergedsc1DT <- sc1data[SeasonAvgDT]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := 0]

Mergedsc1DT <- Mergedsc1DT[, MWh := MWh / 5]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                (MWh * (meanprice))),
                           keyby = .(season, Region, obsHalfHour)] 


#Change the order in facet_grid()
Mergedsc1DT$season <- factor(Mergedsc1DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising
#myPlot <- ggplot2::ggplot(Mergedsc1DT, aes(x = obsHalfHour)) +
#  geom_point(aes(y=ecoValueHH, color= Region), size=1.5) +
#  theme(text = element_text(family = "Cambria")) +
#  ggtitle("Economic value of load curtailment to zero by region") +
#  facet_grid(season ~ .) +
#  labs(x='Time of Day', y='Economic value $/MWh') +
#  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                        #  hms::as.hms("09:00:00"), hms::as.hms("12:00:00"),
                        #  hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00")))
#myPlot

#Mergedsc1DT <- Mergedsc1DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]


```
####Load curtailment of particular amount SC2
```{r economic value of particular amount hot water}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc2data <- hotWaterProfileDT
sc2data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc2data <- sc2data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc2data <- sc2data[, Period := "Not Peak"]

sc2data <- sc2data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc2data <- sc2data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc2data <- sc2data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc2data <- sc2data[, MWh:= ifelse(Period == "Morning Peak" |
                                    Period == "Evening Peak", GWhs1*1000*0.5, GWhs1*1000)] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)

setkey(sc2data, season, obsHalfHour)

Mergedsc2DT <- sc2data[SeasonAvgDT]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := 0]

Mergedsc2DT <- Mergedsc2DT[, MWh := MWh / 5]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                MWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)] 

#Change the order in facet_grid()
Mergedsc2DT$season <- factor(Mergedsc2DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising only shifted consumption
#myPlot <- ggplot2::ggplot(Mergedsc2DT, aes(x = obsHalfHour)) +
 # geom_point(aes(y=ecoValueHH, color= Region), size=1.5) +
 # theme(text = element_text(family = "Cambria")) +
 # ggtitle("Economic value of particular amount by region") +
 # facet_grid(season ~ .) +
 # labs(x='Time of Day', y='Economic value $/MWh') +
 # scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                         # hms::as.hms("09:00:00"), hms::as.hms("12:00:00"),
                         # hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00")))
#myPlot

#Mergedsc2DT <- Mergedsc2DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]



```
####Load shifting to prior time periods: SC3
```{r economic value load shifting hot water}


sc3data <- hotWaterProfileDT
sc3data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc3data <- sc3data[, .(GWhs1 = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP <- sc3data[season == "Autumn" & Period == "Morning Peak",
                sum(GWhs1)]
WiMP <- sc3data[season == "Winter" & Period == "Morning Peak",
                sum(GWhs1)]
SpMP <- sc3data[season == "Spring" & Period == "Morning Peak",
                sum(GWhs1)]
SuMP <- sc3data[season == "Summer" & Period == "Morning Peak",
                sum(GWhs1)]

AuEP <- sc3data[season == "Autumn" & Period == "Evening Peak",
                sum(GWhs1)]
WiEP <- sc3data[season == "Winter" & Period == "Evening Peak",
                sum(GWhs1)]
SpEP <- sc3data[season == "Spring" & Period == "Evening Peak",
                sum(GWhs1)]
SuEP <- sc3data[season == "Summer" & Period == "Evening Peak",
                sum(GWhs1)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au <- AuMP/AuMPHalfHours
distGWhOP1Wi <- WiMP/WiMPHalfHours
distGWhOP1Sp <- SpMP/SpMPHalfHours
distGWhOP1Su <- SuMP/SuMPHalfHours

distGWhOP2Au <- AuEP/AuEPHalfHours
distGWhOP2Wi <- WiEP/WiEPHalfHours
distGWhOP2Sp <- SpEP/SpEPHalfHours
distGWhOP2Su <- SuEP/SuEPHalfHours



#Adding amount of spreaded peak consumption to off-peak periods
sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Su]


sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Su]


#Setting missing values in peak periods to NULL
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Morning Peak",
                                  0, GWhs3)]
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Evening Peak",
                                  0, GWhs3)]
#Economic value starts::

#Creating new column
sc3data <- sc3data[, DiffOrigMWh := 0]
#Calculating the amount added due to load shifting + converting to MWh
sc3data <- sc3data[, DiffOrigMWh := ifelse(GWhs3 > 0,
                                           (GWhs3-GWhs1) * 1000, (0-GWhs1 * 1000))]
#Preparation for merging DTs
setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc3data, season, obsHalfHour)

#Merging
Mergedsc3DT <- sc3data[SeasonAvgDT]

Mergedsc3DT <- Mergedsc3DT[, DiffOrigMWh := DiffOrigMWh / 5]

Mergedsc3DT <- Mergedsc3DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                DiffOrigMWh * (meanprice),
                                                DiffOrigMWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)]#WARNING DiffOrigMWh represents distinction between positive and negative already


#Change the order in facet_grid()
Mergedsc3DT$season <- factor(Mergedsc3DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Putting all values together and check!
EcoVaHHDT <- copy(Mergedsc0DT)

setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("Baseline"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc1DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc2DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc*0.5@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc3DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLs"))

EcoVaHHDT <- EcoVaHHDT[, c("GWhs1", "MWh") := NULL]

EcoVaHHDT <- EcoVaHHDT[, meanprice := meanprice + 0,
                 keyby = .(season, Region, obsHalfHour)]

```
####Visualisation hot water
```{r economic visualisation SC0 hot water}

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, Baseline := Baseline]# Converting to million $
EcoVaSumSC0DT <- EcoVaSumDT[, (Baseline = sum(Baseline)), keyby = .(Region, season, Period)]


EcoVaSumSC0DT$Period <- factor(EcoVaSumSC0DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)

SavingsMillionNZD <- CostBaseline-CostBaseline
SavingsPercent <- 0#Compared to Baseline

SavingsMillionNZD
SavingsPercent

myPlot <- ggplot2::ggplot(EcoVaSumSC0DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for hot water") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Baseline scenario: Cost for hot water by period.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC0DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for hot water in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Baseline scenario: Cost for hot water in winter by period.jpeg", dpi = 600)                        

```
```{r economic visualisation SC1 1 hot water}
#Plots cost of load curtailment to zero, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := ifelse(Period == "Morning Peak" |
                                                      Period == "Evening Peak", 0,
                                                    `EcoVaLc@Peak`)]
EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumDT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostEcoVaLc@Peak` <- sum(EcoVaSumDT$`EcoVaLc@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc@Peak`
SavingsPercent <- 1-(`CostEcoVaLc@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent

#Visualisation
myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost for hot water") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Cost for hot water.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost for hot water in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Cost for hot water in winter.jpeg", dpi = 600)
```

```{r economic visualisation SC1 2 hot water}
#Plots benefits when load is curtailed to zero 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC1DT <- EcoVaSumDT
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := ifelse(Period == "Off Peak 1" |
                                                            Period == "Off Peak 2", 0,
                                                          `EcoVaLc@Peak`*(-1))]#We want to disply savings
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumSC1DT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for hot water") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Savings at peak time-periods for hot water.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for hot water in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Savings at peak time-periods for hot water in winter.jpeg", dpi = 600)
```
```{r economic visualisation SC2 1 hot water}

#Plots cost and benefits of load curtailment to 0.5, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Morning Peak" |
                                                          Period == "Evening Peak",
                                             ((Baseline*0.5)*1000000),`EcoVaLc*0.5@Peak`)]

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumDT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1",
                                                                "Morning Peak",
                                                                "Off Peak 2",
                                                                "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostEcoVaLc*0.5@Peak` <- sum(EcoVaSumDT$`EcoVaLc*0.5@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc*0.5@Peak`
SavingsPercent <- 1-(`CostEcoVaLc*0.5@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent


myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for hot water") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Cost for hot water.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for hot water in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot

#ggsave("Load curtailment 0.5 scenario: Cost for hot water in winter.jpeg", dpi = 600)
```

```{r economic visualisation SC2 2 hot water}

#Plots benefits when load is curtailed to 0.5 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC2DT <- EcoVaSumDT
EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Off Peak 1"|
                                                            Period == "Off Peak 2",0,
                                 `EcoVaLc*0.5@Peak`*(-1))]#We want to disply savings


EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumSC2DT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for hot water") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for hot water.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for hot water in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for hot water in winter.jpeg", dpi = 600)
```
```{r  economic visualisation SC3 1 hot water}

#Plots cost and benefits of load shifting, does not consider baseline but increases costs at off peaks
EcoVaSumDT <- copy(EcoVaHHDT)


EcoVaSumDT <- EcoVaSumDT[, EcoSummary := ifelse(Period == "Off Peak 1" |
                                               Period == "Off Peak 2",
                                             (Baseline*1000000) + EcoVaLs, 0)]#It has to be zero 



EcoVaSumDT <- EcoVaSumDT[, `EcoSummary` := `EcoSummary`/1000000]# Converting to million $
EcoVaSumSC3DT <- EcoVaSumDT[, (`EcoSummary` = sum(`EcoSummary`)), keyby = .(Region, season, Period)]

EcoVaSumSC3DT$Period <- factor(EcoVaSumSC3DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))





#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostLoadShif` <- sum(EcoVaSumDT$`EcoSummary`)

SavingsMillionNZD <- CostBaseline - `CostLoadShif`
SavingsPercent <- 1-(`CostLoadShif` / CostBaseline)

SavingsMillionNZD
SavingsPercent




myPlot <- ggplot2::ggplot(EcoVaSumSC3DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for hot water") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load shifting scenario: Cost for hot water.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC3DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for hot water in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Load shifting scenario: Cost for hot water in winter.jpeg", dpi = 600)
```
###Both appliances together
```{r heat pump and hot water together economic}
#Defining peak and off-peak for heat pump and hot water seperately
sc3data <- heatPumpProfileDT

sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]




sc32data <- hotWaterProfileDT

sc32data <- sc32data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

#Defining peak and off-peak periods

sc32data <- sc32data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc32data <- sc32data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc32data <- sc32data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Copying hot water consumption column into heat pump data table
sc3data <- cbind(sc3data, sc32data[,"GWhHW"])

#Building sum of heat pump and hot water consumption
sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW]
```
####Baseline
```{r calculating baseline scenario SC0 economic}

#Economic evaluation begins
sc3data <- sc3data[, MWh:=PumpandWater*fac1000] # Creating new column MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc3data, season, obsHalfHour)

Mergedsc0DT <- sc3data[SeasonAvgDT]

Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := 0]

Mergedsc0DT <- Mergedsc0DT[, MWh := MWh /5]

Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := (MWh * (meanprice)/1000000), 
                           keyby = .(season, Region, obsHalfHour)]

#Change the order in facet_grid()
Mergedsc0DT$season <- factor(Mergedsc0DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising
myPlot <- ggplot2::ggplot(Mergedsc0DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Costs baseline scenario time of day for heat pump and hot water") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Cost in million NZD') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
myPlot

#ggsave("Cost baseline scenario time of day.jpeg", dpi = 600)

#Building season sum by period
#Mergedsc0DT <- Mergedsc0DT[, .(EcoVal = sum(ecoValueHH)),
                  # keyby = .(season, Region, Period)]
```
####Load curtailment to zero SC1

```{r setting peak periods to zero economic value both appliances}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc1data <- sc3data#WARNING PREVIOUS SECTION MUST BE EXECUTED TO REPRESENT CORRECT VALUES HERE WARNING



sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc1data <- sc1data[, .(GWhs1 = sum(PumpandWater)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


#Economic evaluation begins
sc1data <- sc1data[, MWh:=GWhs1*fac1000] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc1data, season, obsHalfHour)

Mergedsc1DT <- sc1data[SeasonAvgDT]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := 0]

Mergedsc1DT <- Mergedsc1DT[, MWh := MWh / 5]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                (MWh * (meanprice))),
                           keyby = .(season, Region, obsHalfHour)] 


#Change the order in facet_grid()
Mergedsc1DT$season <- factor(Mergedsc1DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising
myPlot <- ggplot2::ggplot(Mergedsc1DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Economic value of load curtailment to zero by region") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Economic value $/MWh') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                          hms::as.hms("09:00:00"), hms::as.hms("12:00:00"),
                          hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00")))
myPlot

#Mergedsc1DT <- Mergedsc1DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]


```
####Load curtailment of particular amount: SC2

```{r economic value of particular amount both appliances}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc2data <- sc3data#WARNING PREVIOUS TWO CHUNKS MUST BE EXECUTED TO WORK PROPERLY HERE WARNING
sc2data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc2data <- sc2data[, .(GWhs1 = sum(PumpandWater)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc2data <- sc2data[, Period := "Not Peak"]

sc2data <- sc2data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc2data <- sc2data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc2data <- sc2data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc2data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc2data <- sc2data[, MWh:= ifelse(Period == "Morning Peak" |
                                    Period == "Evening Peak", GWhs1*1000*0.5, GWhs1*1000)] # Creating new column GWh based on GWhs1 in MWh
sc2data <- sc2data[, MWh:= MWh /5]

setkey(SeasonAvgDT, season, obsHalfHour)

setkey(sc2data, season, obsHalfHour)

Mergedsc2DT <- sc2data[SeasonAvgDT]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := 0]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                MWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)] 

#Change the order in facet_grid()
Mergedsc2DT$season <- factor(Mergedsc2DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising only shifted consumption
myPlot <- ggplot2::ggplot(Mergedsc2DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Economic value of particular amount by region") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Economic value $/MWh') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                          hms::as.hms("09:00:00"), hms::as.hms("12:00:00"),
                          hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00")))
myPlot

#Mergedsc2DT <- Mergedsc2DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]



```
####Load shifting to prior time periods: SC3
```{r economic value load shifting both appliances}



sc3data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc3data <- sc3data[, .(GWhs1 = sum(PumpandWater)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP <- sc3data[season == "Autumn" & Period == "Morning Peak",
                sum(GWhs1)]
WiMP <- sc3data[season == "Winter" & Period == "Morning Peak",
                sum(GWhs1)]
SpMP <- sc3data[season == "Spring" & Period == "Morning Peak",
                sum(GWhs1)]
SuMP <- sc3data[season == "Summer" & Period == "Morning Peak",
                sum(GWhs1)]

AuEP <- sc3data[season == "Autumn" & Period == "Evening Peak",
                sum(GWhs1)]
WiEP <- sc3data[season == "Winter" & Period == "Evening Peak",
                sum(GWhs1)]
SpEP <- sc3data[season == "Spring" & Period == "Evening Peak",
                sum(GWhs1)]
SuEP <- sc3data[season == "Summer" & Period == "Evening Peak",
                sum(GWhs1)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au <- AuMP/AuMPHalfHours
distGWhOP1Wi <- WiMP/WiMPHalfHours
distGWhOP1Sp <- SpMP/SpMPHalfHours
distGWhOP1Su <- SuMP/SuMPHalfHours

distGWhOP2Au <- AuEP/AuEPHalfHours
distGWhOP2Wi <- WiEP/WiEPHalfHours
distGWhOP2Sp <- SpEP/SpEPHalfHours
distGWhOP2Su <- SuEP/SuEPHalfHours



#Adding amount of spreaded peak consumption to off-peak periods
sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Su]


sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Su]


#Setting missing values in peak periods to NULL
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Morning Peak",
                                  0, GWhs3)]
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Evening Peak",
                                  0, GWhs3)]
#Economic value starts::

#Creating new column
sc3data <- sc3data[, DiffOrigMWh := 0]
#Calculating the amount added due to load shifting + converting to MWh
sc3data <- sc3data[, DiffOrigMWh := ifelse(GWhs3 > 0,
                                           (GWhs3-GWhs1) * 1000, (0-GWhs1 * 1000))]

sc3data <- sc3data[, DiffOrigMWh := DiffOrigMWh / 5]
                     
#Preparation for merging DTs
setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc3data, season, obsHalfHour)

#Merging
Mergedsc3DT <- sc3data[SeasonAvgDT]

Mergedsc3DT <- Mergedsc3DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                DiffOrigMWh * (meanprice),
                                                DiffOrigMWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)]#WARNING DiffOrigMWh represents distinction between positive and negative already


#Change the order in facet_grid()
Mergedsc3DT$season <- factor(Mergedsc3DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Putting all values together and check!
EcoVaHHDT <- copy(Mergedsc0DT)

setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("Baseline"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc1DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc2DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc*0.5@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc3DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLs"))

EcoVaHHDT <- EcoVaHHDT[, c("GWhs1", "MWh") := NULL]

EcoVaHHDT <- EcoVaHHDT[, meanprice := meanprice + 0,
                 keyby = .(season, Region, obsHalfHour)]

```
####Visualisation both aplliances
```{r economic visualisation SC0 both appliances}

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, Baseline := Baseline]# Converting to million $
EcoVaSumSC0DT <- EcoVaSumDT[, (Baseline = sum(Baseline)), keyby = .(Region, season, Period)]


EcoVaSumSC0DT$Period <- factor(EcoVaSumSC0DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)

SavingsMillionNZD <- CostBaseline-CostBaseline
SavingsPercent <- 0#Compared to Baseline

SavingsMillionNZD
SavingsPercent

myPlot <- ggplot2::ggplot(EcoVaSumSC0DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for HP & HW") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Baseline scenario: Cost for HP & HW by period.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC0DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for HP & HW in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Baseline scenario: Cost for HP & HW in winter by period.jpeg", dpi = 600)                        

```
```{r economic visualisation SC1 1 both appliances}
#Plots cost of load curtailment to zero, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := ifelse(Period == "Morning Peak" |
                                                      Period == "Evening Peak", 0,
                                                    `EcoVaLc@Peak`)]
EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumDT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostEcoVaLc@Peak` <- sum(EcoVaSumDT$`EcoVaLc@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc@Peak`
SavingsPercent <- 1-(`CostEcoVaLc@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent

#Visualisation
myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost for HP & HW") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Cost for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost for HP & HW in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Cost for HP & HW in winter.jpeg", dpi = 600)
```
```{r economic visualisation SC1 2 both appliances}
#Plots benefits when load is curtailed to zero 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC1DT <- EcoVaSumDT
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := ifelse(Period == "Off Peak 1" |
                                                            Period == "Off Peak 2", 0,
                                                          `EcoVaLc@Peak`*(-1))]#We want to disply savings
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumSC1DT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for HP & HW") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Savings at peak time-periods for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for HP & HW in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Savings at peak time-periods for HP & HW in winter.jpeg", dpi = 600)
```

```{r economic visualisation SC2 1 both appliances}

#Plots cost and benefits of load curtailment to 0.5, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Morning Peak" |
                                                          Period == "Evening Peak",
                                              ((Baseline*0.5)*1000000), `EcoVaLc*0.5@Peak`)]

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumDT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1",
                                                                "Morning Peak",
                                                                "Off Peak 2",
                                                                "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostEcoVaLc*0.5@Peak` <- sum(EcoVaSumDT$`EcoVaLc*0.5@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc*0.5@Peak`
SavingsPercent <- 1-(`CostEcoVaLc*0.5@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent


myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for HP & HW") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Cost for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for HP & HW in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot

#ggsave("Load curtailment 0.5 scenario: Cost for HP & HW in winter.jpeg", dpi = 600)
```

```{r economic visualisation SC2 2 both appliances}

#Plots benefits when load is curtailed to 0.5 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC2DT <- EcoVaSumDT
EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Off Peak 1"|
                                                            Period == "Off Peak 2",0,
                                 `EcoVaLc*0.5@Peak`*(-1))]#We want to disply savings


EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumSC2DT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for HP & HW") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for HP & HW in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for HP & HW in winter.jpeg", dpi = 600)
```

```{r  economic visualisation SC3 1 both appliances}

#Plots cost and benefits of load shifting, does not consider baseline but increases costs at off peaks
EcoVaSumDT <- copy(EcoVaHHDT)


EcoVaSumDT <- EcoVaSumDT[, EcoSummary := ifelse(Period == "Off Peak 1" |
                                               Period == "Off Peak 2",
                                             (Baseline*1000000) + EcoVaLs, 0)]#It has to be zero 



EcoVaSumDT <- EcoVaSumDT[, `EcoSummary` := `EcoSummary`/1000000]# Converting to million $
EcoVaSumSC3DT <- EcoVaSumDT[, (`EcoSummary` = sum(`EcoSummary`)), keyby = .(Region, season, Period)]

EcoVaSumSC3DT$Period <- factor(EcoVaSumSC3DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))





#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostLoadShif` <- sum(EcoVaSumDT$`EcoSummary`)

SavingsMillionNZD <- CostBaseline - `CostLoadShif`
SavingsPercent <- 1-(`CostLoadShif` / CostBaseline)

SavingsMillionNZD
SavingsPercent




myPlot <- ggplot2::ggplot(EcoVaSumSC3DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for HP & HW") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load shifting scenario: Cost for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC3DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for HP & HW in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Load shifting scenario: Cost for HP & HW in winter.jpeg", dpi = 600)
```
###All three applainces togetehr
```{r all three together economic}
#Defining peak and off-peak for heat pump and hot water seperately
sc3data <- heatPumpProfileDT

sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]




sc32data <- hotWaterProfileDT

sc32data <- sc32data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

#Defining peak and off-peak periods

sc32data <- sc32data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc32data <- sc32data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc32data <- sc32data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc32data <- sc32data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]





sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

#Defining peak and off-peak periods

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Copying hot water consumption column into heat pump data table
sc3data <- cbind(sc3data, sc32data[,"GWhHW"], sc5data[, "GWhREF"])

#Building sum of heat pump and hot water consumption
sc3data <- sc3data[, PumpandWater := GWhHP + GWhHW + GWhREF]
```
####Baseline
```{r calculating baseline scenario SC0 economic all three}

#Economic evaluation begins
sc3data <- sc3data[, MWh:=(PumpandWater*fac1000)] # Creating new column MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc3data, season, obsHalfHour)

Mergedsc0DT <- sc3data[SeasonAvgDT]

Mergedsc0DT <- Mergedsc0DT[, MWh:= MWh]
Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := 0]
#Mergedsc0DT <- Mergedsc0DT[, avgregion := sum((meanprice)/5),
                          #keyby = .(season, obsHalfHour)]

Mergedsc0DT <- Mergedsc0DT[, MWh := MWh /5]

Mergedsc0DT <- Mergedsc0DT[, ecoValueHH := (MWh * meanprice), 
                           keyby = .(season, obsHalfHour)]

#Change the order in facet_grid()
Mergedsc0DT$season <- factor(Mergedsc0DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))







#Visualising
myPlot <- ggplot2::ggplot(subset(Mergedsc0DT, Region %in% c("Central North Island")), aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH), size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Costs baseline scenario time of day for heat pump and hot water") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Cost in NZD') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
myPlot

ggsave("ALLTHREE_PerDayCost baseline scenario time of day all three.jpeg", dpi = 600)

#Building season sum by period
#Mergedsc0DT <- Mergedsc0DT[, .(EcoVal = sum(ecoValueHH)),
                  # keyby = .(season, Region, Period)]
```
####Load curtailment to zero SC1

```{r setting peak periods to zero economic value all three appliances}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc1data <- sc3data#WARNING PREVIOUS SECTION MUST BE EXECUTED TO REPRESENT CORRECT VALUES HERE WARNING



sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc1data <- sc1data[, .(GWhs1 = sum(PumpandWater)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


#Economic evaluation begins
sc1data <- sc1data[, MWh:=GWhs1*fac1000] # Creating new column GWh based on GWhs1 in MWh


setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc1data, season, obsHalfHour)

Mergedsc1DT <- sc1data[SeasonAvgDT]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := 0]

Mergedsc1DT <- Mergedsc1DT[, MWh := MWh / 5]

Mergedsc1DT <- Mergedsc1DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                (MWh * (meanprice))),
                           keyby = .(season, Region, obsHalfHour)] 


#Change the order in facet_grid()
Mergedsc1DT$season <- factor(Mergedsc1DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising
myPlot <- ggplot2::ggplot(Mergedsc1DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Economic value of load curtailment to zero by region") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Economic value $/MWh') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                          hms::as.hms("09:00:00"), hms::as.hms("12:00:00"),
                          hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00")))
myPlot

#Mergedsc1DT <- Mergedsc1DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]


```
####Load curtailment of particular amount: SC2

```{r economic value of particular amount all three appliances}
fac1000 <- 1000 # We need this conversion to display MWh as required by prices per MWh

sc2data <- sc3data#WARNING PREVIOUS TWO CHUNKS MUST BE EXECUTED TO WORK PROPERLY HERE WARNING
sc2data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc2data <- sc2data[, .(GWhs1 = sum(PumpandWater)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc2data <- sc2data[, Period := "Not Peak"]

sc2data <- sc2data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc2data <- sc2data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc2data <- sc2data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc2data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc2data <- sc2data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc2data <- sc2data[, MWh:= ifelse(Period == "Morning Peak" |
                                    Period == "Evening Peak", GWhs1*1000*0.5, GWhs1*1000)] # Creating new column GWh based on GWhs1 in MWh
sc2data <- sc2data[, MWh:= MWh /5]

setkey(SeasonAvgDT, season, obsHalfHour)

setkey(sc2data, season, obsHalfHour)

Mergedsc2DT <- sc2data[SeasonAvgDT]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := 0]

Mergedsc2DT <- Mergedsc2DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                (`MWh` * (-meanprice)),
                                                MWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)] 

#Change the order in facet_grid()
Mergedsc2DT$season <- factor(Mergedsc2DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising only shifted consumption
myPlot <- ggplot2::ggplot(Mergedsc2DT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ecoValueHH, color= Region), size=1.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Economic value of particular amount by region") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Economic value $/MWh') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),
                          hms::as.hms("09:00:00"), hms::as.hms("12:00:00"),
                          hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00")))
myPlot

#Mergedsc2DT <- Mergedsc2DT[, .(EcoVal = sum(ecoValueHH)),
                   #keyby = .(Region, season, Period)]



```
####Load shifting to prior time periods: SC3
```{r economic value load shifting all three appliances}



sc3data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

sc3data <- sc3data[, .(GWhs1 = sum(PumpandWater)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP <- sc3data[season == "Autumn" & Period == "Morning Peak",
                sum(GWhs1)]
WiMP <- sc3data[season == "Winter" & Period == "Morning Peak",
                sum(GWhs1)]
SpMP <- sc3data[season == "Spring" & Period == "Morning Peak",
                sum(GWhs1)]
SuMP <- sc3data[season == "Summer" & Period == "Morning Peak",
                sum(GWhs1)]

AuEP <- sc3data[season == "Autumn" & Period == "Evening Peak",
                sum(GWhs1)]
WiEP <- sc3data[season == "Winter" & Period == "Evening Peak",
                sum(GWhs1)]
SpEP <- sc3data[season == "Spring" & Period == "Evening Peak",
                sum(GWhs1)]
SuEP <- sc3data[season == "Summer" & Period == "Evening Peak",
                sum(GWhs1)]


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 1"])
SpMPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 1"])
SuMPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 1"])

#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours <- nrow(sc3data[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours <- nrow(sc3data[season == "Winter" &
                              Period == "Off Peak 2"])
SpEPHalfHours <- nrow(sc3data[season == "Spring" &
                              Period == "Off Peak 2"])
SuEPHalfHours <- nrow(sc3data[season == "Summer" &
                              Period == "Off Peak 2"])

#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au <- AuMP/AuMPHalfHours
distGWhOP1Wi <- WiMP/WiMPHalfHours
distGWhOP1Sp <- SpMP/SpMPHalfHours
distGWhOP1Su <- SuMP/SuMPHalfHours

distGWhOP2Au <- AuEP/AuEPHalfHours
distGWhOP2Wi <- WiEP/WiEPHalfHours
distGWhOP2Sp <- SpEP/SpEPHalfHours
distGWhOP2Su <- SuEP/SuEPHalfHours



#Adding amount of spreaded peak consumption to off-peak periods
sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 1", GWhs3 :=
                     GWhs1 + distGWhOP1Su]


sc3data <- sc3data[season == "Autumn" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Au]
sc3data <- sc3data[season == "Winter" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Wi]
sc3data <- sc3data[season == "Spring" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Sp]
sc3data <- sc3data[season == "Summer" &
                     Period == "Off Peak 2", GWhs3 :=
                     GWhs1 + distGWhOP2Su]


#Setting missing values in peak periods to NULL
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Morning Peak",
                                  0, GWhs3)]
sc3data <- sc3data[, GWhs3:= ifelse(Period =="Evening Peak",
                                  0, GWhs3)]
#Economic value starts::

#Creating new column
sc3data <- sc3data[, DiffOrigMWh := 0]
#Calculating the amount added due to load shifting + converting to MWh
sc3data <- sc3data[, DiffOrigMWh := ifelse(GWhs3 > 0,
                                           (GWhs3-GWhs1) * 1000, (0-GWhs1 * 1000))]

sc3data <- sc3data[, DiffOrigMWh := DiffOrigMWh /5]
                     
#Preparation for merging DTs
setkey(SeasonAvgDT, season, obsHalfHour)
setkey(sc3data, season, obsHalfHour)

#Merging
Mergedsc3DT <- sc3data[SeasonAvgDT]

Mergedsc3DT <- Mergedsc3DT[, ecoValueHH := ifelse(Period == "Morning Peak" | 
                                                  Period == "Evening Peak",
                                                DiffOrigMWh * (meanprice),
                                                DiffOrigMWh * (meanprice)),
                           keyby = .(season, Region, obsHalfHour)]#WARNING DiffOrigMWh represents distinction between positive and negative already


#Change the order in facet_grid()
Mergedsc3DT$season <- factor(Mergedsc3DT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Putting all values together and check!
EcoVaHHDT <- copy(Mergedsc0DT)

setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("Baseline"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc1DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc2DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLc*0.5@Peak"))

EcoVaHHDT <- cbind(EcoVaHHDT, Mergedsc3DT[,"ecoValueHH"])
setnames(EcoVaHHDT, old=c("ecoValueHH"), new=c("EcoVaLs"))

EcoVaHHDT <- EcoVaHHDT[, c("GWhs1", "MWh") := NULL]

EcoVaHHDT <- EcoVaHHDT[, meanprice := meanprice + 0,
                 keyby = .(season, Region, obsHalfHour)]

```
####Visualisation all three aplliances
```{r economic visualisation SC0 all three appliances}

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, Baseline := Baseline]# Converting to million $
EcoVaSumSC0DT <- EcoVaSumDT[, (Baseline = sum(Baseline)), keyby = .(Region, season, Period)]


EcoVaSumSC0DT$Period <- factor(EcoVaSumSC0DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)

SavingsMillionNZD <- CostBaseline-CostBaseline
SavingsPercent <- 0#Compared to Baseline

SavingsMillionNZD
SavingsPercent

myPlot <- ggplot2::ggplot(EcoVaSumSC0DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for HP & HW") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Baseline scenario: Cost for HP & HW by period.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC0DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Baseline scenario: Cost for HP & HW in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Baseline scenario: Cost for HP & HW in winter by period.jpeg", dpi = 600)                        

```
```{r economic visualisation SC1 1 all three appliances}
#Plots cost of load curtailment to zero, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := ifelse(Period == "Morning Peak" |
                                                      Period == "Evening Peak", 0,
                                                    `EcoVaLc@Peak`)]
EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumDT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostEcoVaLc@Peak` <- sum(EcoVaSumDT$`EcoVaLc@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc@Peak`
SavingsPercent <- 1-(`CostEcoVaLc@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent

#Visualisation
myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost for HP & HW") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Cost for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Cost for HP & HW in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Cost for HP & HW in winter.jpeg", dpi = 600)
```
```{r economic visualisation SC1 2 all three appliances}
#Plots benefits when load is curtailed to zero 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC1DT <- EcoVaSumDT
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := ifelse(Period == "Off Peak 1" |
                                                            Period == "Off Peak 2", 0,
                                                          `EcoVaLc@Peak`*(-1))]#We want to disply savings
EcoVaSumSC1DT <- EcoVaSumSC1DT[, `EcoVaLc@Peak` := `EcoVaLc@Peak`/1000000]# Converting to million $
EcoVaSumSC1DT <- EcoVaSumSC1DT[, (`EcoVaLc@Peak` = sum(`EcoVaLc@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC1DT$Period <- factor(EcoVaSumSC1DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC1DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for HP & HW") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment scenario: Savings at peak time-periods for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC1DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment scenario: Savings at peak time-periods for HP & HW in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment scenario: Savings at peak time-periods for HP & HW in winter.jpeg", dpi = 600)
```

```{r economic visualisation SC2 1 all three appliances}

#Plots cost and benefits of load curtailment to 0.5, does not consider baseline
EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Morning Peak" |
                                                          Period == "Evening Peak",
                                              ((Baseline*0.5)*1000000), `EcoVaLc*0.5@Peak`)]

EcoVaSumDT <- EcoVaSumDT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumDT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]

EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1",
                                                                "Morning Peak",
                                                                "Off Peak 2",
                                                                "Evening Peak"))

#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostEcoVaLc*0.5@Peak` <- sum(EcoVaSumDT$`EcoVaLc*0.5@Peak`)

SavingsMillionNZD <- CostBaseline - `CostEcoVaLc*0.5@Peak`
SavingsPercent <- 1-(`CostEcoVaLc*0.5@Peak` / CostBaseline)

SavingsMillionNZD
SavingsPercent


myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for HP & HW") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Cost for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Cost for HP & HW in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot

#ggsave("Load curtailment 0.5 scenario: Cost for HP & HW in winter.jpeg", dpi = 600)
```

```{r economic visualisation SC2 2 all three appliances}

#Plots benefits when load is curtailed to 0.5 

EcoVaSumDT <- copy(EcoVaHHDT)

EcoVaSumSC2DT <- EcoVaSumDT
EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := ifelse(Period == "Off Peak 1"|
                                                            Period == "Off Peak 2",0,
                                 `EcoVaLc*0.5@Peak`*(-1))]#We want to disply savings


EcoVaSumSC2DT <- EcoVaSumSC2DT[, `EcoVaLc*0.5@Peak` := `EcoVaLc*0.5@Peak`/1000000]# Converting to million $
EcoVaSumSC2DT <- EcoVaSumSC2DT[, (`EcoVaLc*0.5@Peak` = sum(`EcoVaLc*0.5@Peak`)), keyby = .(Region, season, Period)]


EcoVaSumSC2DT$Period <- factor(EcoVaSumSC2DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))

myPlot <- ggplot2::ggplot(EcoVaSumSC2DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for HP & HW") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot 
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC2DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load curtailment 0.5 scenario: Savings at peak time-periods for HP & HW in winter") +
  labs(x='Period', y='Savings in million NZD') 
  
myPlot
#ggsave("Load curtailment 0.5 scenario: Savings at peak time-periods for HP & HW in winter.jpeg", dpi = 600)
```

```{r  economic visualisation SC3 1 all three appliances}

#Plots cost and benefits of load shifting, does not consider baseline but increases costs at off peaks
EcoVaSumDT <- copy(EcoVaHHDT)


EcoVaSumDT <- EcoVaSumDT[, EcoSummary := ifelse(Period == "Off Peak 1" |
                                               Period == "Off Peak 2",
                                             (Baseline*1000000) + EcoVaLs, 0)]#It has to be zero 



EcoVaSumDT <- EcoVaSumDT[, `EcoSummary` := `EcoSummary`/1000000]# Converting to million $
EcoVaSumSC3DT <- EcoVaSumDT[, (`EcoSummary` = sum(`EcoSummary`)), keyby = .(Region, season, Period)]

EcoVaSumSC3DT$Period <- factor(EcoVaSumSC3DT$Period, levels = c("Off Peak 1","Morning Peak",
                                                    "Off Peak 2", "Evening Peak"))





#Analysis
CostBaseline <- sum(EcoVaSumDT$Baseline)
`CostLoadShif` <- sum(EcoVaSumDT$`EcoSummary`)

SavingsMillionNZD <- CostBaseline - `CostLoadShif`
SavingsPercent <- 1-(`CostLoadShif` / CostBaseline)

SavingsMillionNZD
SavingsPercent




myPlot <- ggplot2::ggplot(EcoVaSumSC3DT, aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for HP & HW") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot 
#ggsave("ALLTHREE_Seasonal_Load shifting scenario: Cost for HP & HW.jpeg", dpi = 600)

myPlot <- ggplot2::ggplot(subset(EcoVaSumSC3DT,
                                 season %in% c("Winter")), aes(x = Period, fill = Region)) +
  geom_bar(aes(y= V1), stat = "identity", position = "dodge") +
  #geom_line(aes(y= V1)) +
  theme(text = element_text(family = "Cambria")) +
  facet_grid(season ~ .) +
  ggtitle("Load shifting scenario: Cost for HP & HW in winter") +
  labs(x='Period', y='Cost in million NZD') 
  
myPlot
#ggsave("ALLTHREE_Seasonal_Load shifting scenario: Cost for HP & HW in winter.jpeg", dpi = 600)
```




###CPD analysis
```{r CPD analysis}

#Hot water
#Loading data
CpdMinOrig12  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2012.csv")
CpdMinOrig13  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2013.csv")
CpdMinOrig14  <-read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2014.csv")
CpdMinOrig15  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2015.csv")
CpdMinOrig16  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2016.csv")


#Binding data
CpdMinAll <- rbind(CpdMinOrig12, CpdMinOrig13, CpdMinOrig14, CpdMinOrig15, CpdMinOrig16)


#Time and month adjustments
CpdMinAll <- data.table::as.data.table(CpdMinAll)
CpdMinAll <- CpdMinAll[, dateTime := lubridate::dmy_hm(DateTime, tz = "Pacific/Auckland")]
CpdMinAll <- CpdMinAll[, year := lubridate::year(dateTime)]
CpdMinAll <- CpdMinAll[, obsHalfHour := hms::as.hms(dateTime)]
CpdMinAll <- CpdMinAll[, month := lubridate::month(dateTime)]
CpdMinAll <- CpdMinAll[month >= 5 & month <= 5, season := "Autumn"]
CpdMinAll <- CpdMinAll[month == 6 | month == 7 | month == 8, season := "Winter"]


#Loading and scaling hot water load
HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)
CpdMergedHWDT <- HWprofileDT[CpdSumDT]

#Calculating average kW at congestion periods per household
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := kWperHh * Probability]
AvgHWCpdDem <- sum(CpdMergedHWDT$AvgDemCPD)

#Introducing prices #Using Frankton GXP of Aurora CPD pricing (lowest charges)
PS1 <- 0.3079
PS2 <- 0.3387
PS3 <- 0.3616
PS4 <- 0.4698

#Adding prices to DT
CpdSumDT <- CpdSumDT[, PS1 := PS1]
CpdSumDT <- CpdSumDT[, PS2 := PS2]
CpdSumDT <- CpdSumDT[, PS3 := PS3]
CpdSumDT <- CpdSumDT[, PS4 := PS4]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(CpdMergedHWDT, season, obsHalfHour)
CpdMergedHWDT <- CpdMergedHWDT[CpdSumDT]

#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDem * PS1 * 365
sumPS2HW <- AvgHWCpdDem * PS2 * 365
sumPS3HW <- AvgHWCpdDem * PS3 * 365
sumPS4HW <- AvgHWCpdDem * PS4 * 365


#Visualising CPD by season
  myPlot <- ggplot2::ggplot(CpdSumDT, aes(x = obsHalfHour)) +
  geom_line(aes(y=Probability, colour = season), size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Probability of congestion time-periods by season") +
  labs(x='Time of Day', y='Probability') +
  facet_grid(season ~ .) +
 # scale_y_continuous(breaks = c(20, 40, 60, 80)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"),hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),
                          hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), hms::as.hms("20:00:00")))

  
  myPlot
  
 #ggsave("Probability of congestion time-periods by season.jpeg", dpi = 600)


  
  
  
  
  
  #Heat pump
  #Loading and scaling hot water load
HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPprofileDT, season, obsHalfHour)
CpdMergedHPDT <- HPprofileDT[CpdSumDT]

#Calculating average kW at congestion periods per household
CpdMergedHPDT <- CpdMergedHPDT[, AvgDemCPD := kWperHh * Probability]
AvgHPCpdDem <- sum(CpdMergedHPDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1HP <- AvgHPCpdDem * PS1 * 365
sumPS2HP <- AvgHPCpdDem * PS2 * 365
sumPS3HP <- AvgHPCpdDem * PS3 * 365
sumPS4HP <- AvgHPCpdDem * PS4 * 365




#Refrigeration
#Loading and scaling hot refrigeration load
REFprofileDT <- refrigerationProfileDT[ !(season %in% c("Spring", "Summer"))]
REFprofileDT <- REFprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
REFprofileDT <- REFprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/nzHouseholds/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(REFprofileDT, season, obsHalfHour)
CpdMergedREFDT <- REFprofileDT[CpdSumDT]

#Calculating average kW at congestion periods per household
CpdMergedREFDT <- CpdMergedREFDT[, AvgDemCPD := kWperHh * Probability]
AvgREFCpdDem <- sum(CpdMergedREFDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1REF <- AvgREFCpdDem * PS1 * 365
sumPS2REF <- AvgREFCpdDem * PS2 * 365
sumPS3REF <- AvgREFCpdDem * PS3 * 365
sumPS4REF <- AvgREFCpdDem * PS4 * 365



#ALl three appliances together

HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season


#Loading and scaling hot refrigeration load
REFprofileDT <- refrigerationProfileDT[ !(season %in% c("Spring", "Summer"))]
REFprofileDT <- REFprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
REFprofileDT <- REFprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHouseholds)/90]#kW per household and half hour for the whole 90 day season





HPHWREFprofileDT <- copy(HWprofileDT)
HPHWREFprofileDT <- HPHWREFprofileDT[, kWperHhSum := kWperHh + (HPprofileDT$kWperHh) +
                                       (REFprofileDT$kWperHh)]

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPHWREFprofileDT, season, obsHalfHour)
CpdMergedHPHWREFDT <- HPHWREFprofileDT[CpdSumDT]

#Calculating average kW at congestion periods per household
CpdMergedHPHWREFDT <- CpdMergedHPHWREFDT[, AvgDemCPD := kWperHhSum * Probability]
AvgHPHWREFCpdDem <- sum(CpdMergedHPHWREFDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1HPHWREF <- AvgHPHWREFCpdDem * PS1 * 365
sumPS2HPHWREF <- AvgHPHWREFCpdDem * PS2 * 365
sumPS3HPHWREF <- AvgHPHWREFCpdDem * PS3 * 365
sumPS4HPHWREF <- AvgHPHWREFCpdDem * PS4 * 365








#Both appliances together

HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

HPHWprofileDT <- copy(HWprofileDT)
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := kWperHh + (HPprofileDT$kWperHh)]

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPHWprofileDT, season, obsHalfHour)
CpdMergedHPHWDT <- HPHWprofileDT[CpdSumDT]

#Calculating average kW at congestion periods per household
CpdMergedHPHWDT <- CpdMergedHPHWDT[, AvgDemCPD := kWperHhSum * Probability]
AvgHPHWCpdDem <- sum(CpdMergedHPHWDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1HPHW <- AvgHPHWCpdDem * PS1 * 365
sumPS2HPHW <- AvgHPHWCpdDem * PS2 * 365
sumPS3HPHW <- AvgHPHWCpdDem * PS3 * 365
sumPS4HPHW <- AvgHPHWCpdDem * PS4 * 365


#------------------------------------------------------------------------------

#Total New Zealand number: Must be run seperately to the previous one. Same variable names in results


#Hot water
#Loading data
CpdMinOrig12  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2012.csv")
CpdMinOrig13  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2013.csv")
CpdMinOrig14  <-read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2014.csv")
CpdMinOrig15  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2015.csv")
CpdMinOrig16  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/Aurora_CPD/Edited_2016.csv")


#Binding data
CpdMinAll <- rbind(CpdMinOrig12, CpdMinOrig13, CpdMinOrig14, CpdMinOrig15, CpdMinOrig16)


#Time and month adjustments
CpdMinAll <- data.table::as.data.table(CpdMinAll)
CpdMinAll <- CpdMinAll[, dateTime := lubridate::dmy_hm(DateTime, tz = "Pacific/Auckland")]
CpdMinAll <- CpdMinAll[, year := lubridate::year(dateTime)]
CpdMinAll <- CpdMinAll[, obsHalfHour := hms::as.hms(dateTime)]
CpdMinAll <- CpdMinAll[, month := lubridate::month(dateTime)]
CpdMinAll <- CpdMinAll[month >= 5 & month <= 5, season := "Autumn"]
CpdMinAll <- CpdMinAll[month == 6 | month == 7 | month == 8, season := "Winter"]


#Loading and scaling hot water load
HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)
CpdMergedHWDT <- HWprofileDT[CpdSumDT]

#Calculating average kW at congestion periods per household
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := kWperHh * Probability]
AvgHWCpdDem <- sum(CpdMergedHWDT$AvgDemCPD)

#Introducing prices
PS1 <- 0.3079
PS2 <- 0.3387
PS3 <- 0.3616
PS4 <- 0.4698

#Adding prices to DT
CpdSumDT <- CpdSumDT[, PS1 := PS1]
CpdSumDT <- CpdSumDT[, PS2 := PS2]
CpdSumDT <- CpdSumDT[, PS3 := PS3]
CpdSumDT <- CpdSumDT[, PS4 := PS4]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(CpdMergedHWDT, season, obsHalfHour)
CpdMergedHWDT <- CpdMergedHWDT[CpdSumDT]

#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDem * PS1 * 365/1000000
sumPS2HW <- AvgHWCpdDem * PS2 * 365/1000000
sumPS3HW <- AvgHWCpdDem * PS3 * 365/1000000
sumPS4HW <- AvgHWCpdDem * PS4 * 365/1000000



  
  
  
  
  
  #Heat pump
  #Loading and scaling hot water load
HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPprofileDT, season, obsHalfHour)
CpdMergedHPDT <- HPprofileDT[CpdSumDT]

#Calculating average kW at congestion periods per household
CpdMergedHPDT <- CpdMergedHPDT[, AvgDemCPD := kWperHh * Probability]
AvgHPCpdDem <- sum(CpdMergedHPDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1HP <- AvgHPCpdDem * PS1 * 365/1000000
sumPS2HP <- AvgHPCpdDem * PS2 * 365/1000000
sumPS3HP <- AvgHPCpdDem * PS3 * 365/1000000
sumPS4HP <- AvgHPCpdDem * PS4 * 365/1000000






#Both appliances together

HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/90]#kW per household and half hour for the whole 90 day season

HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/90]#kW per household and half hour for the whole 90 day season

HPHWprofileDT <- copy(HWprofileDT)
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := kWperHh + (HPprofileDT$kWperHh)]

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPHWprofileDT, season, obsHalfHour)
CpdMergedHPHWDT <- HPHWprofileDT[CpdSumDT]

#Calculating average kW at congestion periods per household
CpdMergedHPHWDT <- CpdMergedHPHWDT[, AvgDemCPD := kWperHhSum * Probability]
AvgHPHWCpdDem <- sum(CpdMergedHPHWDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1HPHW <- AvgHPHWCpdDem * PS1 * 365/1000000
sumPS2HPHW <- AvgHPHWCpdDem * PS2 * 365/1000000
sumPS3HPHW <- AvgHPHWCpdDem * PS3 * 365/1000000
sumPS4HPHW <- AvgHPHWCpdDem * PS4 * 365/1000000



#Further visualisation

 CPDVisual <- copy(CpdSumDT)
 CPDVisual <- CPDVisual[, SumMins := (SumMins)/60]
 
 #Visualising CPD by season
  myPlot <- ggplot2::ggplot(CPDVisual, aes(x = obsHalfHour, fill = season)) +
  geom_bar(aes(y=SumMins), stat = "identity", position = "dodge") +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Sum of average amount of congestion time-periods by season") + 
  #How many hours per half hour during 2012-2016 average
  labs(x='Time of Day', y='Hours ') +
  facet_grid(season ~ .) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"),hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),
                          hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), hms::as.hms("20:00:00")))

  
  myPlot
  #ggsave("Sum of average amount of congestion time-periods by season.jpeg", dpi = 600)
  
 CPDVisual <- copy(CpdSumDT)
 CPDVisual <- CPDVisual[, SumHours := ifelse(season == "Autumn" |
                                                  season == "Winter", sum(SumMins)/60,0),
                        keyby = .(season)]
 CPDVisual$SumHours


```


```{r CPD with scenarios one household}

#Heat Pump

#SC1 per household

 #Heat pump
  #Loading and scaling hot water load
HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/nzHHheatPumps/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HPprofileDT <- HPprofileDT[, Period := "Not Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HPprofileDT <- HPprofileDT[, kWperHhSC1 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPprofileDT, season, obsHalfHour)

CpdMergedHPDT <- HPprofileDT[CpdSumDT]
CpdMergedHPDT <- CpdMergedHPDT[, AvgDemCPD := kWperHhSC1 * Probability]
AvgHPCpdDemSC1 <- sum(CpdMergedHPDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HP <- AvgHPCpdDemSC1 * PS1 * 365
sumPS2HP <- AvgHPCpdDemSC1 * PS2 * 365
sumPS3HP <- AvgHPCpdDemSC1 * PS3 * 365
sumPS4HP <- AvgHPCpdDemSC1 * PS4 * 365

#______________________________________________________________________

#SC1 total NZ

 #Heat pump
  #Loading and scaling hot water load
HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HPprofileDT <- HPprofileDT[, Period := "Not Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HPprofileDT <- HPprofileDT[, kWperHhSC1 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPprofileDT, season, obsHalfHour)

CpdMergedHPDT <- HPprofileDT[CpdSumDT]
CpdMergedHPDT <- CpdMergedHPDT[, AvgDemCPD := kWperHhSC1 * Probability]
AvgHPCpdDemSC1 <- sum(CpdMergedHPDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HP <- AvgHPCpdDemSC1 * PS1 * 365/1000000
sumPS2HP <- AvgHPCpdDemSC1 * PS2 * 365/1000000
sumPS3HP <- AvgHPCpdDemSC1 * PS3 * 365/1000000
sumPS4HP <- AvgHPCpdDemSC1 * PS4 * 365/1000000

#______________________________________________________________________-

#Heat Pump

#SC2 per household

 #Heat pump
  #Loading and scaling hot water load
HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/nzHHheatPumps/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HPprofileDT <- HPprofileDT[, Period := "Not Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HPprofileDT <- HPprofileDT[, kWperHhSC2 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0.5, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPprofileDT, season, obsHalfHour)

CpdMergedHPDT <- HPprofileDT[CpdSumDT]
CpdMergedHPDT <- CpdMergedHPDT[, AvgDemCPD := kWperHhSC2 * Probability]
AvgHPCpdDemSC2 <- sum(CpdMergedHPDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HP <- AvgHPCpdDemSC2 * PS1 * 365
sumPS2HP <- AvgHPCpdDemSC2 * PS2 * 365
sumPS3HP <- AvgHPCpdDemSC2 * PS3 * 365
sumPS4HP <- AvgHPCpdDemSC2 * PS4 * 365



#______________________________________________________________________

#SC2 total NZ

 #Heat pump
  #Loading and scaling hot water load
HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HPprofileDT <- HPprofileDT[, Period := "Not Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HPprofileDT <- HPprofileDT[, kWperHhSC2 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0.5, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPprofileDT, season, obsHalfHour)

CpdMergedHPDT <- HPprofileDT[CpdSumDT]
CpdMergedHPDT <- CpdMergedHPDT[, AvgDemCPD := kWperHhSC2 * Probability]
AvgHPCpdDemSC2 <- sum(CpdMergedHPDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HP <- AvgHPCpdDemSC2 * PS1 * 365/1000000
sumPS2HP <- AvgHPCpdDemSC2 * PS2 * 365/1000000
sumPS3HP <- AvgHPCpdDemSC2 * PS3 * 365/1000000
sumPS4HP <- AvgHPCpdDemSC2 * PS4 * 365/1000000

#____________________________________________________________________________________



#SC3 per household & total (just adjust line 4461 to get the individual or total charge)

 #Heat pump
  #Loading and scaling hot water load
HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household

#Defining peak and off-peak periods

HPprofileDT <- HPprofileDT[, Period := "Not Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPprofileDT <- HPprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP <- HPprofileDT[season == "Autumn" & Period == "Morning Peak",
                sum(kWperHh)]
WiMP <- HPprofileDT[season == "Winter" & Period == "Morning Peak",
                sum(kWperHh)]


AuEP <- HPprofileDT[season == "Autumn" & Period == "Evening Peak",
                sum(kWperHh)]
WiEP <- HPprofileDT[season == "Winter" & Period == "Evening Peak",
                sum(kWperHh)]

        


#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours <- nrow(HPprofileDT[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours <- nrow(HPprofileDT[season == "Winter" &
                              Period == "Off Peak 1"])


#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours <- nrow(HPprofileDT[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours <- nrow(HPprofileDT[season == "Winter" &
                              Period == "Off Peak 2"])


#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au <- AuMP/AuMPHalfHours
distGWhOP1Wi <- WiMP/WiMPHalfHours


distGWhOP2Au <- AuEP/AuEPHalfHours
distGWhOP2Wi <- WiEP/WiEPHalfHours




#Adding amount of spreaded peak consumption to off-peak periods
HPprofileDT <- HPprofileDT[season == "Autumn" &
                     Period == "Off Peak 1", GWhs3 :=
                     kWperHh + distGWhOP1Au]
HPprofileDT <- HPprofileDT[season == "Winter" &
                     Period == "Off Peak 1", GWhs3 :=
                     kWperHh + distGWhOP1Wi]



HPprofileDT <- HPprofileDT[season == "Autumn" &
                     Period == "Off Peak 2", GWhs3 :=
                     kWperHh + distGWhOP2Au]
HPprofileDT <- HPprofileDT[season == "Winter" &
                     Period == "Off Peak 2", GWhs3 :=
                     kWperHh + distGWhOP2Wi]



#Setting missing values in peak periods to NULL
HPprofileDT <- HPprofileDT[, kWperHhSC3:= ifelse(Period =="Morning Peak" |
                                                   Period == "Evening Peak",
                                  0, GWhs3)]



#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPprofileDT, season, obsHalfHour)

CpdMergedHPDT <- HPprofileDT[CpdSumDT]
CpdMergedHPDT <- CpdMergedHPDT[, AvgDemCPD := kWperHhSC3 * Probability]
AvgHPCpdDemSC3 <- sum(CpdMergedHPDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HP <- AvgHPCpdDemSC3 * PS1 * 365
sumPS2HP <- AvgHPCpdDemSC3 * PS2 * 365
sumPS3HP <- AvgHPCpdDemSC3 * PS3 * 365
sumPS4HP <- AvgHPCpdDemSC3 * PS4 * 365


```




```{r CPD with scenarios for hot water}

#Hot water

#SC1 per household

 #Hot water
  #Loading and scaling hot water load
HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HWprofileDT <- HWprofileDT[, Period := "Not Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HWprofileDT <- HWprofileDT[, kWperHhSC1 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := kWperHhSC1 * Probability]
AvgHWCpdDemSC1 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDemSC1 * PS1 * 365
sumPS2HW <- AvgHWCpdDemSC1 * PS2 * 365
sumPS3HW <- AvgHWCpdDemSC1 * PS3 * 365
sumPS4HW <- AvgHWCpdDemSC1 * PS4 * 365

#______________________________________________________________________

#SC1 total NZ

 #Hot water
  #Loading and scaling hot water load
HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HWprofileDT <- HWprofileDT[, Period := "Not Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HWprofileDT <- HWprofileDT[, kWperHhSC1 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := kWperHhSC1 * Probability]
AvgHWCpdDemSC1 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDemSC1 * PS1 * 365/1000000
sumPS2HW <- AvgHWCpdDemSC1 * PS2 * 365/1000000
sumPS3HW <- AvgHWCpdDemSC1 * PS3 * 365/1000000
sumPS4HW <- AvgHWCpdDemSC1 * PS4 * 365/1000000


#___________________________________________________________________

#Hot water

#SC2 (per household)adjust /nzHeatpumps and /1000000 further down for total number

 #Hot water
  #Loading and scaling hot water load
HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HWprofileDT <- HWprofileDT[, Period := "Not Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HWprofileDT <- HWprofileDT[, kWperHhSC1 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0.5, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := kWperHhSC1 * Probability]
AvgHWCpdDemSC2 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDemSC2 * PS1 * 365
sumPS2HW <- AvgHWCpdDemSC2 * PS2 * 365
sumPS3HW <- AvgHWCpdDemSC2 * PS3 * 365
sumPS4HW <- AvgHWCpdDemSC2 * PS4 * 365

#________________________________________________________________________





# SC3 hot water (adjust number of hot water installations and /1000000 further down)

 #Hot water
  #Loading and scaling hot water load
HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household



#Defining peak and off-peak periods
HWprofileDT <- HWprofileDT[, Period := "Not Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP2 <- HWprofileDT[season == "Autumn" & Period == "Morning Peak",
                sum(kWperHh)]
WiMP2 <- HWprofileDT[season == "Winter" & Period == "Morning Peak",
                sum(kWperHh)]


AuEP2 <- HWprofileDT[season == "Autumn" & Period == "Evening Peak",
                sum(kWperHh)]
WiEP2 <- HWprofileDT[season == "Winter" & Period == "Evening Peak",
                sum(kWperHh)]



#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours2 <- nrow(HWprofileDT[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours2 <- nrow(HWprofileDT[season == "Winter" &
                              Period == "Off Peak 1"])


#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours2 <- nrow(HWprofileDT[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours2 <- nrow(HWprofileDT[season == "Winter" &
                              Period == "Off Peak 2"])


#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au2 <- AuMP2/AuMPHalfHours2
distGWhOP1Wi2 <- WiMP2/WiMPHalfHours2


distGWhOP2Au2 <- AuEP2/AuEPHalfHours2
distGWhOP2Wi2 <- WiEP2/WiEPHalfHours2




#Adding amount of spreaded peak consumption to off-peak periods
HWprofileDT <- HWprofileDT[season == "Autumn" &
                     Period == "Off Peak 1", GWhs4 :=
                     kWperHh + distGWhOP1Au2]
HWprofileDT <- HWprofileDT[season == "Winter" &
                     Period == "Off Peak 1", GWhs4 :=
                     kWperHh + distGWhOP1Wi2]


HWprofileDT <- HWprofileDT[season == "Autumn" &
                     Period == "Off Peak 2", GWhs4 :=
                     kWperHh + distGWhOP2Au2]
HWprofileDT <- HWprofileDT[season == "Winter" &
                     Period == "Off Peak 2", GWhs4 :=
                     kWperHh + distGWhOP2Wi2]



#Setting missing values in peak periods to NULL
HWprofileDT <- HWprofileDT[, GWhs4:= ifelse(Period =="Morning Peak",
                                  0, GWhs4)]
HWprofileDT <- HWprofileDT[, GWhs4:= ifelse(Period =="Evening Peak",
                                  0, GWhs4)]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := GWhs4 * Probability]
AvgHWCpdDemSC2 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDemSC2 * PS1 * 365
sumPS2HW <- AvgHWCpdDemSC2 * PS2 * 365
sumPS3HW <- AvgHWCpdDemSC2 * PS3 * 365
sumPS4HW <- AvgHWCpdDemSC2 * PS4 * 365

```


```{r CPD with scenarios for ref}

#Refrigeration

#SC1 per household

 #Refrigeration
  #Loading and scaling hot water load
HWprofileDT <- refrigerationProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHouseholds)/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HWprofileDT <- HWprofileDT[, Period := "Not Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HWprofileDT <- HWprofileDT[, kWperHhSC1 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := kWperHhSC1 * Probability]
AvgHWCpdDemSC1 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDemSC1 * PS1 * 365
sumPS2HW <- AvgHWCpdDemSC1 * PS2 * 365
sumPS3HW <- AvgHWCpdDemSC1 * PS3 * 365
sumPS4HW <- AvgHWCpdDemSC1 * PS4 * 365

#______________________________________________________________________

#SC1 total NZ

 #Hot water
  #Loading and scaling hot water load
HWprofileDT <- refrigerationProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000))/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HWprofileDT <- HWprofileDT[, Period := "Not Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HWprofileDT <- HWprofileDT[, kWperHhSC1 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := kWperHhSC1 * Probability]
AvgHWCpdDemSC1 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDemSC1 * PS1 * 365/1000000
sumPS2HW <- AvgHWCpdDemSC1 * PS2 * 365/1000000
sumPS3HW <- AvgHWCpdDemSC1 * PS3 * 365/1000000
sumPS4HW <- AvgHWCpdDemSC1 * PS4 * 365/1000000


#___________________________________________________________________

#Refrigeration

#SC2 (per household)adjust /nzHeatpumps and /1000000 further down for total number

 #Refrigeration
  #Loading and scaling hot water load
HWprofileDT <- refrigerationProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHouseholds)/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household
HWprofileDT <- HWprofileDT[, Period := "Not Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HWprofileDT <- HWprofileDT[, kWperHhSC1 := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHh*0.5, kWperHh)]
#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := kWperHhSC1 * Probability]
AvgHWCpdDemSC2 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDemSC2 * PS1 * 365
sumPS2HW <- AvgHWCpdDemSC2 * PS2 * 365
sumPS3HW <- AvgHWCpdDemSC2 * PS3 * 365
sumPS4HW <- AvgHWCpdDemSC2 * PS4 * 365

#________________________________________________________________________





# SC3 refrigeration (adjust number of hot water installations and /1000000 further down)

 #Refrigeration
  #Loading and scaling hot water load
HWprofileDT <- refrigerationProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHouseholds)/90]#kW per household and half hour for the whole 90 day season

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]

#Calculating average kW at congestion periods per household



#Defining peak and off-peak periods
HWprofileDT <- HWprofileDT[, Period := "Not Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HWprofileDT <- HWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP2 <- HWprofileDT[season == "Autumn" & Period == "Morning Peak",
                sum(kWperHh)]
WiMP2 <- HWprofileDT[season == "Winter" & Period == "Morning Peak",
                sum(kWperHh)]


AuEP2 <- HWprofileDT[season == "Autumn" & Period == "Evening Peak",
                sum(kWperHh)]
WiEP2 <- HWprofileDT[season == "Winter" & Period == "Evening Peak",
                sum(kWperHh)]



#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours2 <- nrow(HWprofileDT[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours2 <- nrow(HWprofileDT[season == "Winter" &
                              Period == "Off Peak 1"])


#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours2 <- nrow(HWprofileDT[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours2 <- nrow(HWprofileDT[season == "Winter" &
                              Period == "Off Peak 2"])


#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au2 <- AuMP2/AuMPHalfHours2
distGWhOP1Wi2 <- WiMP2/WiMPHalfHours2


distGWhOP2Au2 <- AuEP2/AuEPHalfHours2
distGWhOP2Wi2 <- WiEP2/WiEPHalfHours2




#Adding amount of spreaded peak consumption to off-peak periods
HWprofileDT <- HWprofileDT[season == "Autumn" &
                     Period == "Off Peak 1", GWhs4 :=
                     kWperHh + distGWhOP1Au2]
HWprofileDT <- HWprofileDT[season == "Winter" &
                     Period == "Off Peak 1", GWhs4 :=
                     kWperHh + distGWhOP1Wi2]


HWprofileDT <- HWprofileDT[season == "Autumn" &
                     Period == "Off Peak 2", GWhs4 :=
                     kWperHh + distGWhOP2Au2]
HWprofileDT <- HWprofileDT[season == "Winter" &
                     Period == "Off Peak 2", GWhs4 :=
                     kWperHh + distGWhOP2Wi2]



#Setting missing values in peak periods to NULL
HWprofileDT <- HWprofileDT[, GWhs4:= ifelse(Period =="Morning Peak",
                                  0, GWhs4)]
HWprofileDT <- HWprofileDT[, GWhs4:= ifelse(Period =="Evening Peak",
                                  0, GWhs4)]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := GWhs4 * Probability]
AvgHWCpdDemSC2 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWCpdDemSC2 * PS1 * 365
sumPS2HW <- AvgHWCpdDemSC2 * PS2 * 365
sumPS3HW <- AvgHWCpdDemSC2 * PS3 * 365
sumPS4HW <- AvgHWCpdDemSC2 * PS4 * 365

```

```{r CPD scenario analysis both appliances together}

# SC1

#Both appliances together

HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

HPHWprofileDT <- copy(HWprofileDT)
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := kWperHh + (HPprofileDT$kWperHh)]

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]


#Calculating average kW at congestion periods per household
HPHWprofileDT <- HPHWprofileDT[, Period := "Not Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHhSum*0, kWperHhSum)]


#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPHWprofileDT, season, obsHalfHour)
CpdMergedHPHWDT <- HPHWprofileDT[CpdSumDT]

CpdMergedHPHWDT <- CpdMergedHPHWDT[, AvgDemCPD := kWperHhSum * Probability]
AvgHPHWCpdDem <- sum(CpdMergedHPHWDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1HPHW <- AvgHPHWCpdDem * PS1 * 365
sumPS2HPHW <- AvgHPHWCpdDem * PS2 * 365
sumPS3HPHW <- AvgHPHWCpdDem * PS3 * 365
sumPS4HPHW <- AvgHPHWCpdDem * PS4 * 365



#__________________________________________________________

#SC2 Both appliances together


HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

HPHWprofileDT <- copy(HWprofileDT)
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := kWperHh + (HPprofileDT$kWperHh)]

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]


#Calculating average kW at congestion periods per household
HPHWprofileDT <- HPHWprofileDT[, Period := "Not Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHhSum*0.5, kWperHhSum)]


#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPHWprofileDT, season, obsHalfHour)
CpdMergedHPHWDT <- HPHWprofileDT[CpdSumDT]

CpdMergedHPHWDT <- CpdMergedHPHWDT[, AvgDemCPD := kWperHhSum * Probability]
AvgHPHWCpdDem <- sum(CpdMergedHPHWDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1HPHW <- AvgHPHWCpdDem * PS1 * 365
sumPS2HPHW <- AvgHPHWCpdDem * PS2 * 365
sumPS3HPHW <- AvgHPHWCpdDem * PS3 * 365
sumPS4HPHW <- AvgHPHWCpdDem * PS4 * 365

#_____________________________________________________________________________

#SC3 Both appliances together

HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

HPHWprofileDT <- copy(HWprofileDT)
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := kWperHh + (HPprofileDT$kWperHh)]

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]


#Calculating average kW at congestion periods per household
#Defining peak and off-peak periods
HPHWprofileDT <- HPHWprofileDT[, Period := "Not Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP2 <- HPHWprofileDT[season == "Autumn" & Period == "Morning Peak",
                sum(kWperHhSum)]
WiMP2 <- HPHWprofileDT[season == "Winter" & Period == "Morning Peak",
                sum(kWperHhSum)]


AuEP2 <- HPHWprofileDT[season == "Autumn" & Period == "Evening Peak",
                sum(kWperHhSum)]
WiEP2 <- HPHWprofileDT[season == "Winter" & Period == "Evening Peak",
                sum(kWperHhSum)]



#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours2 <- nrow(HPHWprofileDT[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours2 <- nrow(HPHWprofileDT[season == "Winter" &
                              Period == "Off Peak 1"])


#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours2 <- nrow(HPHWprofileDT[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours2 <- nrow(HPHWprofileDT[season == "Winter" &
                              Period == "Off Peak 2"])


#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au2 <- AuMP2/AuMPHalfHours2
distGWhOP1Wi2 <- WiMP2/WiMPHalfHours2


distGWhOP2Au2 <- AuEP2/AuEPHalfHours2
distGWhOP2Wi2 <- WiEP2/WiEPHalfHours2




#Adding amount of spreaded peak consumption to off-peak periods
HPHWprofileDT <- HPHWprofileDT[season == "Autumn" &
                     Period == "Off Peak 1", GWhs4 :=
                     kWperHhSum + distGWhOP1Au2]
HPHWprofileDT <- HPHWprofileDT[season == "Winter" &
                     Period == "Off Peak 1", GWhs4 :=
                     kWperHhSum + distGWhOP1Wi2]


HPHWprofileDT <- HPHWprofileDT[season == "Autumn" &
                     Period == "Off Peak 2", GWhs4 :=
                     kWperHhSum + distGWhOP2Au2]
HPHWprofileDT <- HPHWprofileDT[season == "Winter" &
                     Period == "Off Peak 2", GWhs4 :=
                     kWperHhSum + distGWhOP2Wi2]



#Setting missing values in peak periods to NULL
HPHWprofileDT <- HPHWprofileDT[, GWhs4:= ifelse(Period =="Morning Peak",
                                  0, GWhs4)]
HPHWprofileDT <- HPHWprofileDT[, GWhs4:= ifelse(Period =="Evening Peak",
                                  0, GWhs4)]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPHWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HPHWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := GWhs4 * Probability]
AvgHWHPCpdDemSC2 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWHPCpdDemSC2 * PS1 * 365
sumPS2HW <- AvgHWHPCpdDemSC2 * PS2 * 365
sumPS3HW <- AvgHWHPCpdDemSC2 * PS3 * 365
sumPS4HW <- AvgHWHPCpdDemSC2 * PS4 * 365










```




```{r CPD scenario analysis all three appliances together}

# SC1

#Both appliances together

HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

REFprofileDT <- refrigerationProfileDT[ !(season %in% c("Spring", "Summer"))]
REFprofileDT <- REFprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
REFprofileDT <- REFprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHouseholds)/90]#kW per household and half hour for the whole 90 day season

HPHWprofileDT <- copy(HWprofileDT)
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := kWperHh + (HPprofileDT$kWperHh) +
                                 (REFprofileDT$kWperHh)]

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]


#Calculating average kW at congestion periods per household
HPHWprofileDT <- HPHWprofileDT[, Period := "Not Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHhSum*0, kWperHhSum)]


#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPHWprofileDT, season, obsHalfHour)
CpdMergedHPHWDT <- HPHWprofileDT[CpdSumDT]

CpdMergedHPHWDT <- CpdMergedHPHWDT[, AvgDemCPD := kWperHhSum * Probability]
AvgHPHWCpdDem <- sum(CpdMergedHPHWDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1HPHW <- AvgHPHWCpdDem * PS1 * 365
sumPS2HPHW <- AvgHPHWCpdDem * PS2 * 365
sumPS3HPHW <- AvgHPHWCpdDem * PS3 * 365
sumPS4HPHW <- AvgHPHWCpdDem * PS4 * 365



#__________________________________________________________

#SC2 Both appliances together


HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

REFprofileDT <- refrigerationProfileDT[ !(season %in% c("Spring", "Summer"))]
REFprofileDT <- REFprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
REFprofileDT <- REFprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHouseholds)/90]#kW per household and half hour for the whole 90 day season

HPHWprofileDT <- copy(HWprofileDT)
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := kWperHh + (HPprofileDT$kWperHh) +
                                 (REFprofileDT$kWperHh)]

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]


#Calculating average kW at congestion periods per household
HPHWprofileDT <- HPHWprofileDT[, Period := "Not Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := ifelse(Period == "Morning Peak" | Period == "Evening Peak",
                                             kWperHhSum*0.5, kWperHhSum)]


#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPHWprofileDT, season, obsHalfHour)
CpdMergedHPHWDT <- HPHWprofileDT[CpdSumDT]

CpdMergedHPHWDT <- CpdMergedHPHWDT[, AvgDemCPD := kWperHhSum * Probability]
AvgHPHWCpdDem <- sum(CpdMergedHPHWDT$AvgDemCPD)
  

#Claculating annual charges hot water for one household
sumPS1HPHW <- AvgHPHWCpdDem * PS1 * 365
sumPS2HPHW <- AvgHPHWCpdDem * PS2 * 365
sumPS3HPHW <- AvgHPHWCpdDem * PS3 * 365
sumPS4HPHW <- AvgHPHWCpdDem * PS4 * 365

#_____________________________________________________________________________

#SC3 Both appliances together

HPprofileDT <- heatPumpProfileDT[ !(season %in% c("Spring", "Summer"))]
HPprofileDT <- HPprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HPprofileDT <- HPprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHheatPumps)/90]#kW per household and half hour for the whole 90 day season

HWprofileDT <- hotWaterProfileDT[ !(season %in% c("Spring", "Summer"))]
HWprofileDT <- HWprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
HWprofileDT <- HWprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHHhotWater)/90]#kW per household and half hour for the whole 90 day season

REFprofileDT <- refrigerationProfileDT[ !(season %in% c("Spring", "Summer"))]
REFprofileDT <- REFprofileDT[, .(sumGWhperHalfHour = sum(scaledGWh)),
                           keyby = .(season, obsHalfHour)]
REFprofileDT <- REFprofileDT[, kWperHh := (((sumGWhperHalfHour *
                                                2)*1000*1000)/nzHouseholds)/90]#kW per household and half hour for the whole 90 day season

HPHWprofileDT <- copy(HWprofileDT)
HPHWprofileDT <- HPHWprofileDT[, kWperHhSum := kWperHh + (HPprofileDT$kWperHh) +
                                 (REFprofileDT$kWperHh)]

#Calculating Probability
CpdSumDT <- CpdMinAll[, .(SumMins = sum(CPDmin)/5), keyby = .(season, obsHalfHour)]
CpdSumDT <- CpdSumDT[, totalMins := sum(SumMins)]
                          

CpdSumDT <- CpdSumDT[, Probability := SumMins / totalMins]


#Calculating average kW at congestion periods per household
#Defining peak and off-peak periods
HPHWprofileDT <- HPHWprofileDT[, Period := "Not Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

HPHWprofileDT <- HPHWprofileDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Building the sum of each peak period by season
AuMP2 <- HPHWprofileDT[season == "Autumn" & Period == "Morning Peak",
                sum(kWperHhSum)]
WiMP2 <- HPHWprofileDT[season == "Winter" & Period == "Morning Peak",
                sum(kWperHhSum)]


AuEP2 <- HPHWprofileDT[season == "Autumn" & Period == "Evening Peak",
                sum(kWperHhSum)]
WiEP2 <- HPHWprofileDT[season == "Winter" & Period == "Evening Peak",
                sum(kWperHhSum)]



#Counting number of rows that will be associated to spread the Morning Peak
AuMPHalfHours2 <- nrow(HPHWprofileDT[season == "Autumn" &
                              Period == "Off Peak 1"])
WiMPHalfHours2 <- nrow(HPHWprofileDT[season == "Winter" &
                              Period == "Off Peak 1"])


#Counting number of rows that will be associated to spread the Evening Peak
AuEPHalfHours2 <- nrow(HPHWprofileDT[season == "Autumn" &
                              Period == "Off Peak 2"])
WiEPHalfHours2 <- nrow(HPHWprofileDT[season == "Winter" &
                              Period == "Off Peak 2"])


#Calculating the proportion that each row will take on to spread the GWhs
distGWhOP1Au2 <- AuMP2/AuMPHalfHours2
distGWhOP1Wi2 <- WiMP2/WiMPHalfHours2


distGWhOP2Au2 <- AuEP2/AuEPHalfHours2
distGWhOP2Wi2 <- WiEP2/WiEPHalfHours2




#Adding amount of spreaded peak consumption to off-peak periods
HPHWprofileDT <- HPHWprofileDT[season == "Autumn" &
                     Period == "Off Peak 1", GWhs4 :=
                     kWperHhSum + distGWhOP1Au2]
HPHWprofileDT <- HPHWprofileDT[season == "Winter" &
                     Period == "Off Peak 1", GWhs4 :=
                     kWperHhSum + distGWhOP1Wi2]


HPHWprofileDT <- HPHWprofileDT[season == "Autumn" &
                     Period == "Off Peak 2", GWhs4 :=
                     kWperHhSum + distGWhOP2Au2]
HPHWprofileDT <- HPHWprofileDT[season == "Winter" &
                     Period == "Off Peak 2", GWhs4 :=
                     kWperHhSum + distGWhOP2Wi2]



#Setting missing values in peak periods to NULL
HPHWprofileDT <- HPHWprofileDT[, GWhs4:= ifelse(Period =="Morning Peak",
                                  0, GWhs4)]
HPHWprofileDT <- HPHWprofileDT[, GWhs4:= ifelse(Period =="Evening Peak",
                                  0, GWhs4)]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(HPHWprofileDT, season, obsHalfHour)

CpdMergedHWDT <- HPHWprofileDT[CpdSumDT]
CpdMergedHWDT <- CpdMergedHWDT[, AvgDemCPD := GWhs4 * Probability]
AvgHWHPCpdDemSC2 <- sum(CpdMergedHWDT$AvgDemCPD)



#Claculating annual charges hot water for one household
sumPS1HW <- AvgHWHPCpdDemSC2 * PS1 * 365
sumPS2HW <- AvgHWHPCpdDemSC2 * PS2 * 365
sumPS3HW <- AvgHWHPCpdDemSC2 * PS3 * 365
sumPS4HW <- AvgHWHPCpdDemSC2 * PS4 * 365










```

#Grid generation
```{r loading summer data}

Generationdata  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/EA_Generation_Data/Monthly extract/2018_01_07.csv")


#Time and month adjustments
GenDT <- data.table::as.data.table(Generationdata)
GenDT <- GenDT[, Period.start := lubridate::dmy_hm(Period.start, tz = "Pacific/Auckland")]
GenDT <- GenDT[, year := lubridate::year(Period.start)]
GenDT <- GenDT[, obsHalfHour := hms::as.hms(Period.start)]
GenDT <- GenDT[, month := lubridate::month(Period.start)]
GenDT <- GenDT[month == 1, season := "Summer"]
GenDT <- GenDT[month == 7, season := "Winter"]

GenDT <- GenDT[, Period.start := NULL]
GenDT <- GenDT[, Period.end := NULL]

GenDT <- GenDT[, GWh := GWh * 3]#Scaling up for whole season

```
##Running scenarios
```{r running scenarios with generation data}

#Determining electricity generation during peak time-periods


MPS <- hms::as.hms("06:00:00")
MPE <- hms::as.hms("10:00:00")

EPS <- hms::as.hms("17:00:00")
EPE <- hms::as.hms("21:00:00")

OP1S <- hms::as.hms("21:30:00")
OP1E <- hms::as.hms("23:30:00")

OP12S <- hms::as.hms("00:00:00")
OP12E <- hms::as.hms("05:30:00")

OP2S <- hms::as.hms("10:30:00")
OP2E <- hms::as.hms("16:30:00")



sc1data <- GenDT

sc1data <- sc1data[, .(GWh1 = sum(GWh)), 
                    keyby = .(season, obsHalfHour)]


sc1data <- sc1data[, Period := "Not Peak"]

sc1data <- sc1data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc1data <- sc1data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc1data <- sc1data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc1data <- sc1data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]




#Change the order in facet_grid()
sc1data$season <- factor(sc1data$season, levels = c("Summer",
                                                    "Winter"))


sc1data <- sc1data[, .(PotCur = sum(GWh1)),
                   keyby = .(season, Period)]
sc1data





```
## Grid generation total impact
```{r loading summer data analysis}

Generationdata  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/EA_Generation_Data/Monthly extract/2018_01_07.csv")


#Time and month adjustments
GenDT <- data.table::as.data.table(Generationdata)
GenDT <- GenDT[, Period.start := lubridate::dmy_hm(Period.start, tz = "Pacific/Auckland")]
GenDT <- GenDT[, year := lubridate::year(Period.start)]
GenDT <- GenDT[, obsHalfHour := hms::as.hms(Period.start)]
GenDT <- GenDT[, month := lubridate::month(Period.start)]
GenDT <- GenDT[month == 1, season := "Summer"]
GenDT <- GenDT[month == 7, season := "Winter"]

GenDT <- GenDT[, Period.start := NULL]
GenDT <- GenDT[, Period.end := NULL]

#GenDT <- GenDT[, GWh := GWh * 3]#Scaling up for whole season




GenDT <- GenDT[, .(meanGWh = mean(`GWh`)), keyby = .(season, obsHalfHour)]

GenDT <- GenDT[, Period := "Not Peak"]

GenDT <- GenDT[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

GenDT <- GenDT[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

GenDT <- GenDT[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

GenDT <- GenDT[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

GenDT <- GenDT[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


GenDT <- GenDT[, SuSc1 := meanGWh]
GenDT <- GenDT[, SuSc1 := ifelse(Period=="Morning Peak" & season == "Summer", SuSc1 * 0.8466, SuSc1)]
GenDT <- GenDT[, SuSc1 := ifelse(Period=="Evening Peak" & season == "Summer", SuSc1 * 0.8541, SuSc1)]
GenDT <- GenDT[, SuSc1 := ifelse(Period=="Morning Peak" & season == "Winter", SuSc1 * 0.8178, SuSc1)]
GenDT <- GenDT[, SuSc1 := ifelse(Period=="Evening Peak" & season == "Winter", SuSc1 * 0.7950, SuSc1)]


GenDT <- GenDT[, SuSc2 := meanGWh]
GenDT <- GenDT[, SuSc2 := ifelse(Period=="Morning Peak" & season == "Summer", SuSc2 * 0.9233, SuSc2)]
GenDT <- GenDT[, SuSc2 := ifelse(Period=="Evening Peak" & season == "Summer", SuSc2 * 0.9271, SuSc2)]
GenDT <- GenDT[, SuSc2 := ifelse(Period=="Morning Peak" & season == "Winter", SuSc2 * 0.8975, SuSc2)]
GenDT <- GenDT[, SuSc2 := ifelse(Period=="Evening Peak" & season == "Winter", SuSc2 * 0.9089, SuSc2)]

GenDT <- GenDT[, SuSc3 := meanGWh]
GenDT <- GenDT[, SuSc3 := ifelse(Period=="Morning Peak" & season == "Summer", SuSc3 * 0.8466, SuSc3)]
GenDT <- GenDT[, SuSc3 := ifelse(Period=="Evening Peak" & season == "Summer", SuSc3 * 0.8541, SuSc3)]
GenDT <- GenDT[, SuSc3 := ifelse(Period=="Morning Peak" & season == "Winter", SuSc3 * 0.8178, SuSc3)]
GenDT <- GenDT[, SuSc3 := ifelse(Period=="Evening Peak" & season == "Winter", SuSc3 * 0.7950, SuSc3)]
GenDT <- GenDT[, SuSc3 := ifelse(Period=="Off Peak 1" & season == "Summer", SuSc3 * 1.1001, SuSc3)]
GenDT <- GenDT[, SuSc3 := ifelse(Period=="Off Peak 2" & season == "Summer", SuSc3 * 1.0981, SuSc3)]
GenDT <- GenDT[, SuSc3 := ifelse(Period=="Off Peak 1" & season == "Winter", SuSc3 * 1.1467, SuSc3)]
GenDT <- GenDT[, SuSc3 := ifelse(Period=="Off Peak 2" & season == "Winter", SuSc3 * 1.1433, SuSc3)]


#Visualising shifted and original consumption two colours
  myPlot <- ggplot2::ggplot(GenDT, aes(x = obsHalfHour)) +
  geom_line(aes(y=SuSc3, color="red"), size=0.5) +
     geom_line(aes(y=meanGWh, color="blue"), size=1.5) +
  #geom_line(aes(y=SuSc1, color="green"), size=0.5) +  
     #geom_line(aes(y=SuSc2, color="orange"), size=0.5) +  
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Effects of demand response scenarios 1-3 on total electricity generation per day") +
  scale_colour_manual(name = element_blank(), 
      values = c('red'='red', 'blue'='blue','orange'='orange', 'green'='green'),  labels = c('Orig. Generation','SC1: Load curtailment', 'SC2: Halved load curtailment', 'SC3: Load shifting')) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='GWh') +
  scale_y_continuous( limits = c(0,3.5), expand = c(0,0) )+
  #scale_y_continuous(breaks = c(0.1)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),       hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), 
  hms::as.hms("20:00:00"))) 
  
  myPlot


#ggsave("Effects of DR.jpeg", dpi = 600)



```


#Variance test load profiles
```{r hot water variance test load profiles}

#Hot Water

HotwaterHCS <- data.table::as.data.table(
 readr::read_csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/cleanData/safe/gridSpy/1min/dataExtracts/Hot Water_2015-04-01_2016-03-31_observations.csv.gz",
                       col_types = cols(
                       hhID = col_character(),
                       linkID = col_character(),
                       r_dateTime = col_datetime(format = ""),
                       circuit = col_character(),
                       powerW = col_double() # <- crucial otherwise readr infers integers for some reason
                     )
                 )
)

HotwaterObsDT2 <- data.table::as.data.table(HotwaterHCS)

HotwaterObsDT2 <- HotwaterObsDT2[, year := lubridate::year(r_dateTime)]
HotwaterObsDT2 <- HotwaterObsDT2[, obsHourMin := hms::as.hms(r_dateTime)]
HotwaterObsDT2 <- HotwaterObsDT2[, month := lubridate::month(r_dateTime)]

HotwaterObsDT2 <- HotwaterObsDT2[month >= 12 | month == 1 | month == 2, season := "Summer"]
HotwaterObsDT2 <- HotwaterObsDT2[month >= 3 | month == 4 | month == 5, season := "Autumn"]
HotwaterObsDT2 <- HotwaterObsDT2[month == 6 | month == 7 | month == 8, season := "Winter"]
HotwaterObsDT2 <- HotwaterObsDT2[month == 9 | month == 10 | month == 11, season := "Spring"]

HotWaterTestDT <- HotwaterObsDT2[, .(meanW = mean(powerW)), keyby = .(obsHourMin, season, hhID)]
HotWaterTestDT<-HotWaterTestDT[!(HotWaterTestDT$season=="Spring"),]
HotWaterTestDT<-HotWaterTestDT[!(HotWaterTestDT$season=="Summer"),]
HotWaterTestDT<-HotWaterTestDT[!(HotWaterTestDT$season=="Autumn"),]

  

legend_title <- "hhID"
myPlot <- ggplot2::ggplot(HotWaterTestDT, aes(x = lubridate::hour(obsHourMin),
                                              group=lubridate::hour(obsHourMin),
                                              varwidth = FALSE)) +
  geom_boxplot(aes(y=meanW, colour = meanW), size=0.5, outlier.alpha = 0.1) +
  #geom_point(aes(y=meanW), size=0.1)+
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Variance hot water load winter") +
  #facet_grid(season ~ .) +
  labs(x='Hours of Day', y='Power W') +
  scale_y_continuous( limits = c(0,3200))+
  scale_color_manual(legend_title, labels = c("powerW")
                                                     , values = c("#332288")) 
 # scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                        #  hms::as.hms("04:00:00"), 
                         # hms::as.hms("08:00:00"),       
                          #hms::as.hms("12:00:00"), 
                          #hms::as.hms("16:00:00"), 
                          #hms::as.hms("20:00:00"),
                          #hms::as.hms("24:00:00"))) 
myPlot  
  
#ggsave("Hot water winter variance winter.jpeg", dpi=600) 




HotWaterTestDT <- HotwaterObsDT2[, .(meanW = mean(powerW)), keyby = .(obsHourMin, season, hhID)]
HotWaterTestDT<-HotWaterTestDT[!(HotWaterTestDT$season=="Spring"),]
HotWaterTestDT<-HotWaterTestDT[!(HotWaterTestDT$season=="Winter"),]
HotWaterTestDT<-HotWaterTestDT[!(HotWaterTestDT$season=="Autumn"),]


legend_title <- "hhID"
myPlot <- ggplot2::ggplot(HotWaterTestDT, aes(x = lubridate::hour(obsHourMin),
                                              group=lubridate::hour(obsHourMin),
                                              varwidth = FALSE)) +
  geom_boxplot(aes(y=meanW, colour = meanW), size=0.5, outlier.alpha = 0.1) +
  #geom_point(aes(y=meanW), size=0.1)+
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Variance hot water load summer") +
  #facet_grid(season ~ .) +
  labs(x='Hours of Day', y='Power W') +
  scale_y_continuous( limits = c(0,3200))+
  scale_color_manual(legend_title, labels = c("powerW")
                                                     , values = c("#332288")) 
 # scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                        #  hms::as.hms("04:00:00"), 
                         # hms::as.hms("08:00:00"),       
                          #hms::as.hms("12:00:00"), 
                          #hms::as.hms("16:00:00"), 
                          #hms::as.hms("20:00:00"),
                          #hms::as.hms("24:00:00"))) 
myPlot  
  
#ggsave("Hot water summer variance.jpeg", dpi=600) 


  
```


```{r heat pump variance load}


heatPumpProfileDT1 <- data.table::as.data.table(
 readr::read_csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/cleanData/safe/gridSpy/1min/dataExtracts/Heat Pump_2015-04-01_2016-03-31_observations.csv.gz",
                       col_types = cols(
                       hhID = col_character(),
                       linkID = col_character(),
                       r_dateTime = col_datetime(format = ""),
                       circuit = col_character(),
                       powerW = col_double() # <- crucial otherwise readr infers integers for some reason
                     )
                 )
)

#heatPumpProfileDT1 <- #data.table::as.data.table(readr::read_csv(ggParams$profilesFile))

heatPumpProfileDT2 <- heatPumpProfileDT1
heatPumpProfileDT2 <- heatPumpProfileDT2[, year := lubridate::year(r_dateTime)]
heatPumpProfileDT2 <- heatPumpProfileDT2[, obsHourMin := hms::as.hms(r_dateTime)]
heatPumpProfileDT2 <- heatPumpProfileDT2[, month := lubridate::month(r_dateTime)]

heatPumpProfileDT2 <- heatPumpProfileDT2[month == 12 | month == 1 | month == 2, season := "Summer"]
heatPumpProfileDT2 <- heatPumpProfileDT2[month == 3 | month == 4 | month == 5, season := "Autumn"]
heatPumpProfileDT2 <- heatPumpProfileDT2[month == 6 | month == 7 | month == 8, season := "Winter"]
heatPumpProfileDT2 <- heatPumpProfileDT2[month == 9 | month == 10 | month == 11, season := "Spring"]

heatPumpProfileDT2 <- heatPumpProfileDT2[, .(meanW = mean(powerW)), keyby = .(obsHourMin, season, hhID)]
heatPumpProfileDT2<-heatPumpProfileDT2[!(heatPumpProfileDT2$season=="Spring"),]
heatPumpProfileDT2<-heatPumpProfileDT2[!(heatPumpProfileDT2$season=="Summer"),]
heatPumpProfileDT2<-heatPumpProfileDT2[!(heatPumpProfileDT2$season=="Autumn"),]

legend_title <- "hhID"
myPlot <- ggplot2::ggplot(heatPumpProfileDT2, aes(x = lubridate::hour(obsHourMin),
                                              group=lubridate::hour(obsHourMin),
                                              varwidth = FALSE)) +
  geom_boxplot(aes(y=meanW, colour = meanW), size=0.5, outlier.alpha = 0.1) +
  #geom_point(aes(y=meanW), size=0.1)+
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Variance heat pump load winter") +
  #facet_grid(season ~ .) +
  labs(x='Hours of Day', y='Power W') +
  scale_y_continuous( limits = c(0,3200))+
  scale_color_manual(legend_title, labels = c("powerW")
                                                     , values = c("#332288")) 
 # scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                        #  hms::as.hms("04:00:00"), 
                         # hms::as.hms("08:00:00"),       
                          #hms::as.hms("12:00:00"), 
                          #hms::as.hms("16:00:00"), 
                          #hms::as.hms("20:00:00"),
                          #hms::as.hms("24:00:00"))) 
myPlot  
  
#ggsave("Heat pump variance winter.jpeg", dpi=600) 




heatPumpProfileDT2 <- heatPumpProfileDT1
heatPumpProfileDT2 <- heatPumpProfileDT2[, year := lubridate::year(r_dateTime)]
heatPumpProfileDT2 <- heatPumpProfileDT2[, obsHourMin := hms::as.hms(r_dateTime)]
heatPumpProfileDT2 <- heatPumpProfileDT2[, month := lubridate::month(r_dateTime)]

heatPumpProfileDT2 <- heatPumpProfileDT2[month == 12 | month == 1 | month == 2, season := "Summer"]
heatPumpProfileDT2 <- heatPumpProfileDT2[month == 3 | month == 4 | month == 5, season := "Autumn"]
heatPumpProfileDT2 <- heatPumpProfileDT2[month == 6 | month == 7 | month == 8, season := "Winter"]
heatPumpProfileDT2 <- heatPumpProfileDT2[month == 9 | month == 10 | month == 11, season := "Spring"]

heatPumpProfileDT2 <- heatPumpProfileDT2[, .(meanW = mean(powerW)), keyby = .(obsHourMin, season, hhID)]
heatPumpProfileDT2<-heatPumpProfileDT2[!(heatPumpProfileDT2$season=="Spring"),]
heatPumpProfileDT2<-heatPumpProfileDT2[!(heatPumpProfileDT2$season=="Winter"),]
heatPumpProfileDT2<-heatPumpProfileDT2[!(heatPumpProfileDT2$season=="Autumn"),]



legend_title <- "hhID"
myPlot <- ggplot2::ggplot(heatPumpProfileDT2, aes(x = lubridate::hour(obsHourMin),
                                              group=lubridate::hour(obsHourMin),
                                              varwidth = FALSE)) +
  geom_boxplot(aes(y=meanW, colour = meanW), size=0.5, outlier.alpha = 0.1) +
  #geom_point(aes(y=meanW), size=0.1)+
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Variance heat pump load summer") +
  #facet_grid(season ~ .) +
  labs(x='Hours of Day', y='Power W') +
  scale_y_continuous( limits = c(0,3200))+
  scale_color_manual(legend_title, labels = c("powerW")
                                                     , values = c("#332288")) 
 # scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                        #  hms::as.hms("04:00:00"), 
                         # hms::as.hms("08:00:00"),       
                          #hms::as.hms("12:00:00"), 
                          #hms::as.hms("16:00:00"), 
                          #hms::as.hms("20:00:00"),
                          #hms::as.hms("24:00:00"))) 
myPlot  
  
#ggsave("Heat pump variance summer.jpeg", dpi=600) 








```


```{r lighting variance load}

LightingHCS <- data.table::as.data.table(
 readr::read_csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/cleanData/safe/gridSpy/1min/dataExtracts/Lighting_2015-04-01_2016-03-31_observations.csv.gz",
                       col_types = cols(
                       hhID = col_character(),
                       linkID = col_character(),
                       r_dateTime = col_datetime(format = ""),
                       circuit = col_character(),
                       powerW = col_double() # <- crucial otherwise readr infers integers for some reason
                     )
                 )
)

LightObsDT2 <- data.table::as.data.table(LightingHCS)

LightObsDT2 <- LightObsDT2[, year := lubridate::year(r_dateTime)]
LightObsDT2 <- LightObsDT2[, obsHourMin := hms::as.hms(r_dateTime)]
LightObsDT2 <- LightObsDT2[, month := lubridate::month(r_dateTime)]

LightObsDT2 <- LightObsDT2[month >= 12 | month == 1 | month == 2, season := "Summer"]
LightObsDT2 <- LightObsDT2[month >= 3 | month == 4 | month == 5, season := "Autumn"]
LightObsDT2 <- LightObsDT2[month == 6 | month == 7 | month == 8, season := "Winter"]
LightObsDT2 <- LightObsDT2[month == 9 | month == 10 | month == 11, season := "Spring"]

LightObsDT2 <- LightObsDT2[, .(meanW = mean(powerW)), keyby = .(obsHourMin, season, hhID)]
LightObsDT2<-LightObsDT2[!(LightObsDT2$season=="Spring"),]
LightObsDT2<-LightObsDT2[!(LightObsDT2$season=="Summer"),]
LightObsDT2<-LightObsDT2[!(LightObsDT2$season=="Autumn"),]



legend_title <- "hhID"
myPlot <- ggplot2::ggplot(LightObsDT2, aes(x = lubridate::hour(obsHourMin),
                                              group=lubridate::hour(obsHourMin),
                                              varwidth = FALSE)) +
  geom_boxplot(aes(y=meanW, colour = meanW), size=0.5, outlier.alpha = 0.1) +
  #geom_point(aes(y=meanW), size=0.1)+
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Variance lighting load winter") +
  #facet_grid(season ~ .) +
  labs(x='Hours of Day', y='Power W') +
  scale_y_continuous( limits = c(0,3200))+
  scale_color_manual(legend_title, labels = c("meanW")
                                                     , values = c("#332288")) 
 # scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                        #  hms::as.hms("04:00:00"), 
                         # hms::as.hms("08:00:00"),       
                          #hms::as.hms("12:00:00"), 
                          #hms::as.hms("16:00:00"), 
                          #hms::as.hms("20:00:00"),
                          #hms::as.hms("24:00:00"))) 
myPlot  
  
#ggsave("Lighting variance winter.jpeg", dpi=600) 





LightObsDT2 <- data.table::as.data.table(LightingHCS)

LightObsDT2 <- LightObsDT2[, year := lubridate::year(r_dateTime)]
LightObsDT2 <- LightObsDT2[, obsHourMin := hms::as.hms(r_dateTime)]
LightObsDT2 <- LightObsDT2[, month := lubridate::month(r_dateTime)]

LightObsDT2 <- LightObsDT2[month >= 12 | month == 1 | month == 2, season := "Summer"]
LightObsDT2 <- LightObsDT2[month >= 3 | month == 4 | month == 5, season := "Autumn"]
LightObsDT2 <- LightObsDT2[month == 6 | month == 7 | month == 8, season := "Winter"]
LightObsDT2 <- LightObsDT2[month == 9 | month == 10 | month == 11, season := "Spring"]

LightObsDT2 <- LightObsDT2[, .(meanW = mean(powerW)), keyby = .(obsHourMin, season, hhID)]
LightObsDT2<-LightObsDT2[!(LightObsDT2$season=="Spring"),]
LightObsDT2<-LightObsDT2[!(LightObsDT2$season=="Winter"),]
LightObsDT2<-LightObsDT2[!(LightObsDT2$season=="Autumn"),]



  
legend_title <- "hhID"
myPlot <- ggplot2::ggplot(LightObsDT2, aes(x = lubridate::hour(obsHourMin),
                                              group=lubridate::hour(obsHourMin),
                                              varwidth = FALSE)) +
  geom_boxplot(aes(y=meanW, colour = meanW), size=0.5, outlier.alpha = 0.1) +
  #geom_point(aes(y=meanW), size=0.1)+
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Variance lighting load summer") +
  #facet_grid(season ~ .) +
  labs(x='Hours of Day', y='Power W') +
  scale_y_continuous( limits = c(0,3200))+
  scale_color_manual(legend_title, labels = c("meanW")
                                                     , values = c("#332288")) 
 # scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                        #  hms::as.hms("04:00:00"), 
                         # hms::as.hms("08:00:00"),       
                          #hms::as.hms("12:00:00"), 
                          #hms::as.hms("16:00:00"), 
                          #hms::as.hms("20:00:00"),
                          #hms::as.hms("24:00:00"))) 
myPlot  
  
#ggsave("Lighting variance summer.jpeg", dpi=600) 
  

  


```
```{r  Figure 3 thesis}

GenerationdataFig  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/EA_Generation_Data/Monthly extract/2017_01_12_06.csv")


#Time and month adjustments
GenDTFig <- data.table::as.data.table(GenerationdataFig)
GenDTFig <- GenDTFig[, Period_start := lubridate::dmy_hm(Period_start, tz = "Pacific/Auckland")]
GenDTFig <- GenDTFig[, year := lubridate::year(Period_start)]
GenDTFig <- GenDTFig[, obsHalfHour := hms::as.hms(Period_start)]
GenDTFig <- GenDTFig[, month := lubridate::month(Period_start)]
GenDTFig <- GenDTFig[month == 12, season := "Summer"]
GenDTFig <- GenDTFig[month == 6, season := "Winter"]

GenDTFig <- GenDTFig[, Period_start := NULL]
GenDTFig <- GenDTFig[, Period_end := NULL]

GenDTFig <- GenDTFig[, .(GWh = mean(GWh)), keyby = .(season, obsHalfHour)]
GenDTFig 


WholesalePricesFig  <- read.csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/externalData/EA_Wholesale_Prices/Wholesale_17_06_12.csv")

#Time and month adjustments
WPDTFig <- data.table::as.data.table(WholesalePricesFig)
WPDTFig <- WPDTFig[, Period_start := lubridate::dmy_hm(Period_start, tz = "Pacific/Auckland")]
WPDTFig <- WPDTFig[, year := lubridate::year(Period_start)]
WPDTFig <- WPDTFig[, obsHalfHour := hms::as.hms(Period_start)]
WPDTFig <- WPDTFig[, month := lubridate::month(Period_start)]
WPDTFig <- WPDTFig[month == 12, season := "Summer"]
WPDTFig <- WPDTFig[month == 6, season := "Winter"]

WPDTFig <- WPDTFig[, Period_start := NULL]
WPDTFig <- WPDTFig[, Period_end := NULL]

WPDTFig <- WPDTFig[, .(Price = mean(`Price`)), keyby = .(season, obsHalfHour)]
WPDTFig <- WPDTFig[, Generation := (GenDTFig$GWh)*1000]



#Change the order in facet_grid()
WPDTFig$season <- factor(WPDTFig$season, levels = c("Summer", "Winter"))


#Visualising shifted and original consumption two colours
#Visualising CPD by season
  myPlot <- ggplot2::ggplot(GenDTFig, aes(x = obsHalfHour)) +
  geom_line(aes(y=GWh, colour = season), size=0.5) +
  geom_point(aes(y=GWh, colour = season), size=1) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Average daily half-hour electricity generation in summer and winter") +
  labs(x='Time of Day', y='GWh per ½  hour') +
  facet_grid(season ~ .) +
 # scale_y_continuous(breaks = c(20, 40, 60, 80)) +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"),hms::as.hms("04:00:00"), hms::as.hms("08:00:00"),
                          hms::as.hms("12:00:00"), hms::as.hms("16:00:00"), hms::as.hms("20:00:00"),                              hms::as.hms("24:00:00")))

  
  myPlot

#ggsave("Fig. 3 Average daily half-hour electricity generation in summer and winter.jpg", dpi=600)

```




#Energy Efficiency: Lighting
##Data import

```{r importing lighting data}
LightingHCS <- data.table::as.data.table(
 readr::read_csv("/Volumes/hum-csafe/Research Projects/GREEN Grid/cleanData/safe/gridSpy/1min/dataExtracts/Lighting_2015-04-01_2016-03-31_observations.csv.gz",
                       col_types = cols(
                       hhID = col_character(),
                       linkID = col_character(),
                       r_dateTime = col_datetime(format = ""),
                       circuit = col_character(),
                       powerW = col_double() # <- crucial otherwise readr infers integers for some reason
                     )
                 )
)

LightObsDT <- data.table::as.data.table(LightingHCS)

LightObsDT <- LightObsDT[, year := lubridate::year(r_dateTime)]
LightObsDT <- LightObsDT[, obsHourMin := hms::as.hms(r_dateTime)]
LightObsDT <- LightObsDT[, month := lubridate::month(r_dateTime)]

LightObsDT <- LightObsDT[month >= 12 | month == 1 | month == 2, season := "Summer"]
LightObsDT <- LightObsDT[month >= 3 | month == 4 | month == 5, season := "Autumn"]
LightObsDT <- LightObsDT[month == 6 | month == 7 | month == 8, season := "Winter"]
LightObsDT <- LightObsDT[month == 9 | month == 10 | month == 11, season := "Spring"]

#Building daily average per season

LightDT <- LightObsDT[, .(meanW = mean(powerW)), keyby = .(obsHourMin, season)]



#ggplot2::ggplot(LightDT, aes(x = obsHalfHour, y = meanW, colour = season)) + #geom_line()

```

##Lighting calculation per household
```{r lighting calculation per household}

#Input variables

NZhouseholds2015 <- 1796331.309 #RBS assumption for 2015 households
NZhouseholds2017 <- 1833349.88
NZhouseholds2019 <- 1868507.182
NZhouseholds2021 <- 1903664.484
NZhouseholds2023 <- 1935926.478
NZhouseholds2025 <- 1968188.473
NZhouseholds2027 <- 1998382.39
NZhouseholds2029 <- 2026508.232

NZhouseholds <- NZhouseholds2015

EecaLight <- (1577 * 1000 * 1000) / NZhouseholds2015 #Yearly kWh per household for lighting based on EECA GWh and RBS number of households

ConsumptionHH2015 <- 877.9004139
ConsumptionHH2017 <- 818.4851125
ConsumptionHH2019 <- 731.1840095
ConsumptionHH2021 <- 628.539852 #Yearly lighting consumption per household in kWh out of Excel calc
ConsumptionHH2023 <- 529.9719035
ConsumptionHH2025 <- 442.4107427
ConsumptionHH2027 <- 367.4350267
ConsumptionHH2029 <- 306.6638448
  
ConsumptionTot2015 <- 1577.00
ConsumptionTot2017 <- 1500.57
ConsumptionTot2019 <- 1366.22
ConsumptionTot2021 <- 1196.53 #Yearly lighting consumption total NZ in GWh out of Excel calc
ConsumptionTot2023 <- 1025.99
ConsumptionTot2025 <-  870.75
ConsumptionTot2027 <-  734.28
ConsumptionTot2029 <-  621.46
  
  
  


#Calculation
LightDT <- LightDT[, obsHalfHour := hms::trunc_hms(obsHourMin, 1800)]#Creating half hour time-steps

LightHHDT <- LightDT[, .(meanW = mean(meanW)), keyby = .(obsHalfHour, season)]
LightTestDT1 <- copy(LightHHDT)
LightHHDT <- LightHHDT[, orikWh := (meanW / 2)/1000]
LightHHDT <- LightHHDT[, meanW := NULL]


#Scales original 2015 energy consumption to RBS figures. Applied on profile. Output: kWh for an average day in each season, not seasonal sum!
Scaling <- EecaLight / sum(LightHHDT$orikWh * 90)
LightHHDT <- LightHHDT[, orikWh := orikWh * Scaling] #Scaling profile to EECA input kWh
Scaling <- ConsumptionHH2015 / sum(LightHHDT$orikWh * 90)
LightHHDT <- LightHHDT[, ConsumptionHH2015 := orikWh * Scaling]
Scaling <- ConsumptionHH2017 / sum(LightHHDT$orikWh * 90)
LightHHDT <- LightHHDT[, ConsumptionHH2017 := orikWh * Scaling]
Scaling <- ConsumptionHH2019 / sum(LightHHDT$orikWh * 90)
LightHHDT <- LightHHDT[, ConsumptionHH2019 := orikWh * Scaling]
Scaling <- ConsumptionHH2021 / sum(LightHHDT$orikWh * 90)
LightHHDT <- LightHHDT[, ConsumptionHH2021 := orikWh * Scaling]
Scaling <- ConsumptionHH2023 / sum(LightHHDT$orikWh * 90)
LightHHDT <- LightHHDT[, ConsumptionHH2023 := orikWh * Scaling]
Scaling <- ConsumptionHH2025 / sum(LightHHDT$orikWh * 90)
LightHHDT <- LightHHDT[, ConsumptionHH2025 := orikWh * Scaling]
Scaling <- ConsumptionHH2027 / sum(LightHHDT$orikWh * 90)
LightHHDT <- LightHHDT[, ConsumptionHH2027 := orikWh * Scaling]
Scaling <- ConsumptionHH2029 / sum(LightHHDT$orikWh * 90)
LightHHDT <- LightHHDT[, ConsumptionHH2029 := orikWh * Scaling]


# Getting data ready for plotting: Converting kWh in Wh
LightHHDT <- LightHHDT[, orikWh := orikWh * 1000]
LightHHDT <- LightHHDT[, ConsumptionHH2015 := ConsumptionHH2015 * 1000]
LightHHDT <- LightHHDT[, ConsumptionHH2017 := ConsumptionHH2017 * 1000]
LightHHDT <- LightHHDT[, ConsumptionHH2019 := ConsumptionHH2019 * 1000]
LightHHDT <- LightHHDT[, ConsumptionHH2021 := ConsumptionHH2021 * 1000]
LightHHDT <- LightHHDT[, ConsumptionHH2023 := ConsumptionHH2023 * 1000]
LightHHDT <- LightHHDT[, ConsumptionHH2025 := ConsumptionHH2025 * 1000]
LightHHDT <- LightHHDT[, ConsumptionHH2027 := ConsumptionHH2027 * 1000]
LightHHDT <- LightHHDT[, ConsumptionHH2029 := ConsumptionHH2029 * 1000]

#________________________________________________________________________
#Total NZ
#Calculation
LightHHTotDT <- copy(LightDT)
LightHHTotDT <- LightDT[, .(meanW = mean(meanW)), keyby = .(obsHalfHour, season)]
LightHHTotDT <- LightHHTotDT[, oriMWh := ((meanW / 2) * NZhouseholds) / 1000 /1000]
LightHHTotDT <- LightHHTotDT[, meanW := NULL]

#Scales original 2015 energy consumption to RBS figures. Applied on profile. Output: MWh for an average day in each season, not seasonal sum!
Scaling <- ((EecaLight / 1000) *  NZhouseholds) / sum(LightHHTotDT$oriMWh * 90)
LightHHTotDT <- LightHHTotDT[, oriMWh := oriMWh * Scaling] #Scaling profile to EECA input kWh
Scaling <- ConsumptionTot2015 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightHHTotDT <- LightHHTotDT[, ConsumptionTot2015 := oriMWh * Scaling] 
Scaling <- ConsumptionTot2017 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightHHTotDT <- LightHHTotDT[, ConsumptionTot2017 := oriMWh * Scaling]
Scaling <- ConsumptionTot2019 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightHHTotDT <- LightHHTotDT[, ConsumptionTot2019 := oriMWh * Scaling]
Scaling <- ConsumptionTot2021 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightHHTotDT <- LightHHTotDT[, ConsumptionTot2021 := oriMWh * Scaling]
Scaling <- ConsumptionTot2023 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightHHTotDT <- LightHHTotDT[, ConsumptionTot2023 := oriMWh * Scaling]
Scaling <- ConsumptionTot2025 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightHHTotDT <- LightHHTotDT[, ConsumptionTot2025 := oriMWh * Scaling]
Scaling <- ConsumptionTot2027 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightHHTotDT <- LightHHTotDT[, ConsumptionTot2027 := oriMWh * Scaling]
Scaling <- ConsumptionTot2029 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightHHTotDT <- LightHHTotDT[, ConsumptionTot2029 := oriMWh * Scaling]
LightHHTotDT$season <- factor(LightHHTotDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))
LightHHTotDT <- LightHHTotDT[, ConsumptionTot2029 := ConsumptionTot2029, keyby = .(season, obsHalfHour)]

#_____________________________________________________________________-

#Impact on electriicty generation
LightDevDT <- copy(GenDT)
LightDevDT <- LightDevDT[, SuSc1 := NULL]
LightDevDT <- LightDevDT[, SuSc2 := NULL]# Copying electricity generation data for summer and winter
LightDevDT <- LightDevDT[, SuSc3 := NULL]


LightDev2DT <- copy(LightHHTotDT)# Copying 2015 lighting energy consumption

LightDev2DT<-LightDev2DT[!(LightDev2DT$season=="Spring"),]# Deleting Spring and Autumn
LightDev2DT<-LightDev2DT[!(LightDev2DT$season=="Autumn"),]
LightDev2DT<- LightDev2DT[, oriMWh:= oriMWh, keyby = .(season)]

LightDevDT <- LightDevDT[, oriMWh := LightDev2DT$oriMWh]# Copying2015 lighting consumption for summer and winter
LightDevDT <- LightDevDT[, meanGWh := meanGWh * 1000] # Conversion to MWh electricity generation
LightDevDT <- LightDevDT[, meanMWh := meanGWh]
LightDevDT <- LightDevDT[, meanGWh := NULL]


Scaling <- ConsumptionTot2015 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightDevDT <- LightDevDT[, ConsumptionTot2015 := meanMWh - (oriMWh * (1-Scaling))]# Building difference of electriicty generation and improved lighting
Scaling <- ConsumptionTot2017 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightDevDT <- LightDevDT[, ConsumptionTot2017 := meanMWh - (oriMWh * (1-Scaling))]
Scaling <- ConsumptionTot2019 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightDevDT <- LightDevDT[, ConsumptionTot2019 := meanMWh - (oriMWh * (1-Scaling))]
Scaling <- ConsumptionTot2021 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightDevDT <- LightDevDT[, ConsumptionTot2021 := meanMWh - (oriMWh * (1-Scaling))]
Scaling <- ConsumptionTot2023 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightDevDT <- LightDevDT[, ConsumptionTot2023 := meanMWh - (oriMWh * (1-Scaling))]
Scaling <- ConsumptionTot2025 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightDevDT <- LightDevDT[, ConsumptionTot2025 := meanMWh - (oriMWh * (1-Scaling))]
Scaling <- ConsumptionTot2027 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightDevDT <- LightDevDT[, ConsumptionTot2027 := meanMWh - (oriMWh * (1-Scaling))]
Scaling <- ConsumptionTot2029 *1000 / sum(LightHHTotDT$oriMWh * 90)
LightDevDT <- LightDevDT[, ConsumptionTot2029 := meanMWh - (oriMWh * (1-Scaling))]

#_______________________________________________________________________________________
# Economic analysis
# Wholesale prices per year total NZ
LightpriceDT <- copy(SeasonAvgDT)
LightpriceDT <- LightpriceDT[, meanprice := mean(meanprice), keyby = .(season, obsHalfHour)]
LightpriceDT <- LightpriceDT[!(LightpriceDT$Region=="Central North Island"),]# Copying DT and retain season column and meanprice. Building price average from five regions
LightpriceDT <- LightpriceDT[!(LightpriceDT$Region=="Lower North Island"),]
LightpriceDT <- LightpriceDT[!(LightpriceDT$Region=="Lower South Island"),]
LightpriceDT <- LightpriceDT[!(LightpriceDT$Region=="Upper North Island"),]
LightpriceDT <- LightpriceDT[, Region := NULL]


LightPriceCalcDT <- copy(LightpriceDT)



LightPriceCalcDT <- LightPriceCalcDT[, obsHalfHour := LightpriceDT$obsHalfHour]
LightPriceCalcDT <- LightPriceCalcDT[, WP2015 := 
                                       LightpriceDT$meanprice *  LightHHTotDT$`ConsumptionTot2015`] #Calculating spot market prices for an average day in each season in NZD. To calculate yearly charge sum(LightPriceCalcDT$WP2015*90)/1000000 in MIO NZD
LightPriceCalcDT <- LightPriceCalcDT[, WP2017 :=
                                       LightpriceDT$meanprice *  LightHHTotDT$`ConsumptionTot2017`]
LightPriceCalcDT <- LightPriceCalcDT[, WP2019 :=
                                       LightpriceDT$meanprice *  LightHHTotDT$`ConsumptionTot2019`]
LightPriceCalcDT <- LightPriceCalcDT[, WP2021 :=
                                       LightpriceDT$meanprice *  LightHHTotDT$`ConsumptionTot2021`]
LightPriceCalcDT <- LightPriceCalcDT[, WP2023 :=
                                       LightpriceDT$meanprice *  LightHHTotDT$`ConsumptionTot2023`]
LightPriceCalcDT <- LightPriceCalcDT[, WP2025 :=
                                       LightpriceDT$meanprice *  LightHHTotDT$`ConsumptionTot2025`]
LightPriceCalcDT <- LightPriceCalcDT[, WP2027 :=
                                       LightpriceDT$meanprice *  LightHHTotDT$`ConsumptionTot2027`]
LightPriceCalcDT <- LightPriceCalcDT[, WP2029 :=
                                       LightpriceDT$meanprice *  LightHHTotDT$`ConsumptionTot2029`]
#______________________________________________________________________________________________
#CPD charges

#Loading and scaling hot water load
LightHHCPDDT <- LightHHDT[ !(season %in% c("Spring", "Summer"))]

LightHHCPDDT <- LightHHCPDDT[, kWperHh2015 := (ConsumptionHH2015/1000) *
                                                2]#kW per household and half hour for one day
LightHHCPDDT <- LightHHCPDDT[, kWperHh2017 := (ConsumptionHH2017 *
                                                2)/1000]#kW per household and half hour for one day
LightHHCPDDT <- LightHHCPDDT[, kWperHh2019 := (ConsumptionHH2019 *
                                                2)/1000]#kW per household and half hour for one day
LightHHCPDDT <- LightHHCPDDT[, kWperHh2021 := (ConsumptionHH2021 *
                                                2)/1000]#kW per household and half hour for one day
LightHHCPDDT <- LightHHCPDDT[, kWperHh2023 := (ConsumptionHH2023 *
                                                2)/1000]#kW per household and half hour for one day
LightHHCPDDT <- LightHHCPDDT[, kWperHh2025 := (ConsumptionHH2025 *
                                                2)/1000]#kW per household and half hour for one day
LightHHCPDDT <- LightHHCPDDT[, kWperHh2027 := (ConsumptionHH2027 *
                                                2)/1000]#kW per household and half hour for one day
LightHHCPDDT <- LightHHCPDDT[, kWperHh2029 := (ConsumptionHH2029 *
                                                2)/1000]#kW per household and half hour for one day

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(LightHHCPDDT, season, obsHalfHour)
CpdMergedLightDT <- LightHHCPDDT[CpdSumDT]

#Calculating average kW at congestion periods per household
CpdMergedLightDT <- CpdMergedLightDT[, AvgDemCPD2015 := kWperHh2015 * Probability]
AvgLightCpdDem2015 <- sum(CpdMergedLightDT$AvgDemCPD2015)

CpdMergedLightDT <- CpdMergedLightDT[, AvgDemCPD2017 := kWperHh2017 * Probability]
AvgLightCpdDem2017 <- sum(CpdMergedLightDT$AvgDemCPD2017)

CpdMergedLightDT <- CpdMergedLightDT[, AvgDemCPD2019 := kWperHh2019 * Probability]
AvgLightCpdDem2019 <- sum(CpdMergedLightDT$AvgDemCPD2019)

CpdMergedLightDT <- CpdMergedLightDT[, AvgDemCPD2021 := kWperHh2021 * Probability]
AvgLightCpdDem2021 <- sum(CpdMergedLightDT$AvgDemCPD2021)

CpdMergedLightDT <- CpdMergedLightDT[, AvgDemCPD2023 := kWperHh2023 * Probability]
AvgLightCpdDem2023 <- sum(CpdMergedLightDT$AvgDemCPD2023)

CpdMergedLightDT <- CpdMergedLightDT[, AvgDemCPD2025 := kWperHh2025 * Probability]
AvgLightCpdDem2025 <- sum(CpdMergedLightDT$AvgDemCPD2025)

CpdMergedLightDT <- CpdMergedLightDT[, AvgDemCPD2027 := kWperHh2027 * Probability]
AvgLightCpdDem2027 <- sum(CpdMergedLightDT$AvgDemCPD2027)

CpdMergedLightDT <- CpdMergedLightDT[, AvgDemCPD2029 := kWperHh2029 * Probability]
AvgLightCpdDem2029 <- sum(CpdMergedLightDT$AvgDemCPD2029)


#Introducing prices #Using Frankton GXP of Aurora CPD pricing (lowest charges)
PS1 <- 0.3079
PS2 <- 0.3387
PS3 <- 0.3616
PS4 <- 0.4698

#Adding prices to DT
CpdSumDT <- CpdSumDT[, PS1 := PS1]
CpdSumDT <- CpdSumDT[, PS2 := PS2]
CpdSumDT <- CpdSumDT[, PS3 := PS3]
CpdSumDT <- CpdSumDT[, PS4 := PS4]

#Preparing for merging
setkey(CpdSumDT, season, obsHalfHour)
setkey(CpdMergedHWDT, season, obsHalfHour)
CpdMergedLightDT <- CpdMergedLightDT[CpdSumDT]

#Claculating annual charges hot water for one household
sumPS1Light <- AvgLightCpdDem2029 * PS1 * 365
sumPS2Light <- AvgLightCpdDem2029 * PS2 * 365
sumPS3Light <- AvgLightCpdDem2029 * PS3 * 365
sumPS4Light <- AvgLightCpdDem2029 * PS4 * 365

#__________________________________________________________________________________________

#Energy output tables
#Daily average total NZ in MWh

EnergyOutput1 <- copy(LightHHTotDT)


#Defining peak and off-peak periods
EnergyOutput1 <- EnergyOutput1[, Period := "Not Peak"]

EnergyOutput1 <- EnergyOutput1[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

EnergyOutput1 <- EnergyOutput1[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

EnergyOutput1 <- EnergyOutput1[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

EnergyOutput1 <- EnergyOutput1[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

EnergyOutput1 <- EnergyOutput1[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

#Seasonal average total NZ

EnergyOutput2 <- copy(EnergyOutput1)
EnergyOutput2 <- EnergyOutput2[, ConsumptionTot2015 := ConsumptionTot2015 * 90]
EnergyOutput2 <- EnergyOutput2[, ConsumptionTot2017 := ConsumptionTot2017 * 90]
EnergyOutput2 <- EnergyOutput2[, ConsumptionTot2019 := ConsumptionTot2019 * 90]
EnergyOutput2 <- EnergyOutput2[, ConsumptionTot2021 := ConsumptionTot2021 * 90]
EnergyOutput2 <- EnergyOutput2[, ConsumptionTot2023 := ConsumptionTot2023 * 90]
EnergyOutput2 <- EnergyOutput2[, ConsumptionTot2025 := ConsumptionTot2025 * 90]
EnergyOutput2 <- EnergyOutput2[, ConsumptionTot2027 := ConsumptionTot2027 * 90]
EnergyOutput2 <- EnergyOutput2[, ConsumptionTot2029 := ConsumptionTot2029 * 90]

#______________________________________________________________________________________________

#All four appliances together energy consumption

sc3data <- heatPumpProfileDT
sc3data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW",
            "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

  sc3data <- sc3data[, .(GWhHP = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]


#Defining peak and off-peak periods
sc3data <- sc3data[, Period := "Not Peak"]

sc3data <- sc3data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc3data <- sc3data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc3data <- sc3data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc3data <- sc3data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]








sc4data <- hotWaterProfileDT

sc4data <- sc4data[, .(GWhHW = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc4data <- sc4data[, Period := "Not Peak"]

sc4data <- sc4data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc4data <- sc4data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc4data <- sc4data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc4data <- sc4data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc4data <- sc4data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]



sc5data <- refrigerationProfileDT

sc5data <- sc5data[, .(GWhREF = sum(scaledGWh)), 
                    keyby = .(season, obsHalfHour)]

sc5data <- sc5data[, Period := "Not Peak"]

sc5data <- sc5data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc5data <- sc5data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc5data <- sc5data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc5data <- sc5data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]

sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

sc4data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

sc5data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))



sc3data <- sc3data[, Period := Period, keyby = .(season, obsHalfHour)]
sc4data <- sc4data[, Period := Period, keyby = .(season, obsHalfHour)]
sc5data <- sc5data[, Period := Period, keyby = .(season, obsHalfHour)]


#Lighting
sc6data <- copy(sc5data)
sc6data <- sc6data[, GWhREF:= (EnergyOutput2$ConsumptionTot2015)/1000]
sc6data <- sc6data[, GWhLight := GWhREF]
sc6data <- sc6data[, GWhREF := NULL]



sc6data <- sc6data[, Period := "Not Peak"]

sc6data <- sc6data[obsHalfHour >= MPS & 
                     obsHalfHour <= MPE,
                   Period := "Morning Peak"]

sc6data <- sc6data[obsHalfHour >= EPS & 
                     obsHalfHour <= EPE,
                   Period := "Evening Peak"]

sc6data <- sc6data[obsHalfHour >= OP1S & 
                     obsHalfHour <= OP1E,
                   Period := "Off Peak 1"]

sc6data <- sc6data[obsHalfHour >= OP12S & 
                     obsHalfHour <= OP12E,
                   Period := "Off Peak 1"]

sc6data <- sc6data[obsHalfHour >= OP2S & 
                     obsHalfHour <= OP2E,
                   Period := "Off Peak 2"]


#VERY IMPORTANT Brings column season into the right order for binding, otherwise seasons get mixed up in adding process. Spring becomes summer for lighting
sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

sc4data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

sc5data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

sc6data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

sc3data <- cbind(sc3data, sc4data[,"GWhHW"], sc5data[,"GWhREF"], sc6data[,"GWhLight"])

#COnverting to daily average in MWh
sc3data <- sc3data[, PumpandWater := ((GWhHP+GWhHW+GWhREF+GWhLight)/90)*1000]
sc3data <- sc3data[, GWhHP := (GWhHP/90)*1000]
sc3data <- sc3data[, GWhHW := (GWhHW/90)*1000]
sc3data <- sc3data[, GWhREF := (GWhREF/90)*1000]
sc3data <- sc3data[, GWhLight := (GWhLight/90)*1000]

sc3data <- sc3data[, APumpandWater := PumpandWater]
sc3data <- sc3data[, BGWhHW := GWhHW]
sc3data <- sc3data[, CGWhLight := GWhLight]#Sorting for plotting, ggplot plots columns alphabetically
sc3data <- sc3data[, DGWhREF := GWhREF]
sc3data <- sc3data[, EGWhHP := GWhHP]

#sc3data <- sc3data[,c(1, 2, 8, 5, 7, 6, 3, 4)]#Ordering columns based on previous DT

```

##Visualisation
###Average day per season and household
```{r Plot 1}

#Change the order in facet_grid()
LightHHDT$season <- factor(LightHHDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising Lighting development in Wh per household
legend_title <- "Year"
myPlot <- ggplot2::ggplot(LightHHDT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ConsumptionHH2015, colour = "ConsumptionHH2015"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2017, colour = "ConsumptionHH2017"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2019, colour = "ConsumptionHH2019"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2021, colour = "ConsumptionHH2021"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2023, colour = "ConsumptionHH2023"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2025, colour = "ConsumptionHH2025"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2027, colour = "ConsumptionHH2027"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2029, colour = "ConsumptionHH2029"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Lighting energy for an average day per season and household - forecast") +
  scale_color_manual(legend_title, labels = c("2015",
                                              "2017",
                                              "2019",
                                              "2021",
                                              "2023",
                                              "2025",
                                              "2027",
                                              "2029"), values = c("#332288",
                                                                  "#88CCEE",
                                                                  "#44AA99",
                                                                  "#117733",
                                                                  "#999933",
                                                                  "#DDCC77",
                                                                  "#CC6677",
                                                                  "#882255")) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Wh per ½ hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Lighting energy for an average day per season and household forecast.jpg", dpi=600)

```
```{r Plot 2}

#Change the order in facet_grid()
LightHHDT$season <- factor(LightHHDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising Lighting development in Wh per household
legend_title <- "Year"
myPlot <- ggplot2::ggplot(LightHHDT, aes(x = obsHalfHour)) +
  geom_line(aes(y=ConsumptionHH2015, colour = "ConsumptionHH2015"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2017, colour = "ConsumptionHH2017"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2019, colour = "ConsumptionHH2019"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2021, colour = "ConsumptionHH2021"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2023, colour = "ConsumptionHH2023"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2025, colour = "ConsumptionHH2025"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2027, colour = "ConsumptionHH2027"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2029, colour = "ConsumptionHH2029"), size=0.2) +
  
  geom_point(aes(y=ConsumptionHH2015, colour = "ConsumptionHH2015"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2017, colour = "ConsumptionHH2017"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2019, colour = "ConsumptionHH2019"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2021, colour = "ConsumptionHH2021"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2023, colour = "ConsumptionHH2023"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2025, colour = "ConsumptionHH2025"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2027, colour = "ConsumptionHH2027"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2029, colour = "ConsumptionHH2029"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Lighting energy for an average day per season and household - forecast") +
  scale_color_manual(legend_title, labels = c("2015",
                                              "2017",
                                              "2019",
                                              "2021",
                                              "2023",
                                              "2025",
                                              "2027",
                                              "2029"), values = c("#332288",
                                                                  "#88CCEE",
                                                                  "#44AA99",
                                                                  "#117733",
                                                                  "#999933",
                                                                  "#DDCC77",
                                                                  "#CC6677",
                                                                  "#882255")) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Wh per ½  hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Lighting energy for an average day per season and household.jpg", dpi=600)



```
```{r Plot 3 Spring and Summer}

#Change the order in facet_grid()
LightHHDT$season <- factor(LightHHDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising Lighting development in Wh per household
legend_title <- "Year"
myPlot <- ggplot2::ggplot(subset(LightHHDT, season %in% c("Spring", "Summer"))
                          , aes(x = obsHalfHour)) +
  geom_line(aes(y=ConsumptionHH2015, colour = "ConsumptionHH2015"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2017, colour = "ConsumptionHH2017"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2019, colour = "ConsumptionHH2019"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2021, colour = "ConsumptionHH2021"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2023, colour = "ConsumptionHH2023"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2025, colour = "ConsumptionHH2025"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2027, colour = "ConsumptionHH2027"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2029, colour = "ConsumptionHH2029"), size=0.2) +
  
  geom_point(aes(y=ConsumptionHH2015, colour = "ConsumptionHH2015"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2017, colour = "ConsumptionHH2017"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2019, colour = "ConsumptionHH2019"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2021, colour = "ConsumptionHH2021"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2023, colour = "ConsumptionHH2023"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2025, colour = "ConsumptionHH2025"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2027, colour = "ConsumptionHH2027"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2029, colour = "ConsumptionHH2029"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Lighting energy for an average day per season and household - forecast") +
  scale_color_manual(legend_title, labels = c("2015",
                                              "2017",
                                              "2019",
                                              "2021",
                                              "2023",
                                              "2025",
                                              "2027",
                                              "2029"), values = c("#332288",
                                                                  "#88CCEE",
                                                                  "#44AA99",
                                                                  "#117733",
                                                                  "#999933",
                                                                  "#DDCC77",
                                                                  "#CC6677",
                                                                  "#882255")) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Wh per ½ hour') +
  scale_y_continuous(breaks = c(50, 100, 150, 200)) +
  scale_y_continuous( limits = c(0,208))+
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Lighting energy for an average day Spring and Summer per household.jpg", dpi=600)


```
```{r Plot 4 Autumn and Winter}

#Change the order in facet_grid()
LightHHDT$season <- factor(LightHHDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising Lighting development in Wh per household
legend_title <- "Year"
myPlot <- ggplot2::ggplot(subset(LightHHDT, season %in% c("Autumn", "Winter"))
                          , aes(x = obsHalfHour)) +
  geom_line(aes(y=ConsumptionHH2015, colour = "ConsumptionHH2015"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2017, colour = "ConsumptionHH2017"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2019, colour = "ConsumptionHH2019"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2021, colour = "ConsumptionHH2021"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2023, colour = "ConsumptionHH2023"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2025, colour = "ConsumptionHH2025"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2027, colour = "ConsumptionHH2027"), size=0.2) +
  geom_line(aes(y=ConsumptionHH2029, colour = "ConsumptionHH2029"), size=0.2) +
  
  geom_point(aes(y=ConsumptionHH2015, colour = "ConsumptionHH2015"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2017, colour = "ConsumptionHH2017"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2019, colour = "ConsumptionHH2019"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2021, colour = "ConsumptionHH2021"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2023, colour = "ConsumptionHH2023"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2025, colour = "ConsumptionHH2025"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2027, colour = "ConsumptionHH2027"), size=0.5) +
  geom_point(aes(y=ConsumptionHH2029, colour = "ConsumptionHH2029"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Lighting energy for an average day per season and household - forecast") +
  scale_color_manual(legend_title, labels = c("2015",
                                              "2017",
                                              "2019",
                                              "2021",
                                              "2023",
                                              "2025",
                                              "2027",
                                              "2029"), values = c("#332288",
                                                                  "#88CCEE",
                                                                  "#44AA99",
                                                                  "#117733",
                                                                  "#999933",
                                                                  "#DDCC77",
                                                                  "#CC6677",
                                                                  "#882255")) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Wh per ½ hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Lighting energy for an average day Autumn and Winter per household.jpg", dpi=600)


```
###Average day per season total NZ
```{r Plot 1 1}

#Change the order in facet_grid()
LightHHTotDT$season <- factor(LightHHTotDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising Lighting development in Wh per household
legend_title <- "Year"
myPlot <- ggplot2::ggplot(LightHHTotDT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ConsumptionTot2015, colour = "ConsumptionTot2015"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2017, colour = "ConsumptionTot2017"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2019, colour = "ConsumptionTot2019"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2021, colour = "ConsumptionTot2021"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2023, colour = "ConsumptionTot2023"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2025, colour = "ConsumptionTot2025"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2027, colour = "ConsumptionTot2027"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2029, colour = "ConsumptionTot2029"), size=0.5) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Lighting energy for an average day per season total NZ - forecast") +
  scale_color_manual(legend_title, labels = c("2015",
                                              "2017",
                                              "2019",
                                              "2021",
                                              "2023",
                                              "2025",
                                              "2027",
                                              "2029"), values = c("#332288",
                                                                  "#88CCEE",
                                                                  "#44AA99",
                                                                  "#117733",
                                                                  "#999933",
                                                                  "#DDCC77",
                                                                  "#CC6677",
                                                                  "#882255")) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½ hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Lighting energy for an average day per season total NZ forecast.jpg", dpi=600)

```
```{r Plot 1 2}

#Change the order in facet_grid()
LightHHTotDT$season <- factor(LightHHTotDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising Lighting development in Wh per household
legend_title <- "Year"
myPlot <- ggplot2::ggplot(LightHHTotDT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ConsumptionTot2015, colour = "ConsumptionTot2015"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2017, colour = "ConsumptionTot2017"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2019, colour = "ConsumptionTot2019"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2021, colour = "ConsumptionTot2021"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2023, colour = "ConsumptionTot2023"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2025, colour = "ConsumptionTot2025"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2027, colour = "ConsumptionTot2027"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2029, colour = "ConsumptionTot2029"), size=0.5) +
  
  geom_line(aes(y=ConsumptionTot2015, colour = "ConsumptionTot2015"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2017, colour = "ConsumptionTot2017"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2019, colour = "ConsumptionTot2019"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2021, colour = "ConsumptionTot2021"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2023, colour = "ConsumptionTot2023"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2025, colour = "ConsumptionTot2025"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2027, colour = "ConsumptionTot2027"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2029, colour = "ConsumptionTot2029"), size=0.2) +
  
  
  
  
  
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Lighting energy for an average day per season total NZ - forecast") +
  scale_color_manual(legend_title, labels = c("2015",
                                              "2017",
                                              "2019",
                                              "2021",
                                              "2023",
                                              "2025",
                                              "2027",
                                              "2029"), values = c("#332288",
                                                                  "#88CCEE",
                                                                  "#44AA99",
                                                                  "#117733",
                                                                  "#999933",
                                                                  "#DDCC77",
                                                                  "#CC6677",
                                                                  "#882255")) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½  hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Lighting energy for an average day per season total NZ forecast.jpg", dpi=600)

```
```{r Plot 1 3}

#Change the order in facet_grid()
LightHHTotDT$season <- factor(LightHHTotDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising Lighting development in Wh per household
legend_title <- "Year"
myPlot <- ggplot2::ggplot(subset(LightHHTotDT, season %in% c("Spring", "Summer")), aes(x = obsHalfHour)) +
  geom_point(aes(y=ConsumptionTot2015, colour = "ConsumptionTot2015"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2017, colour = "ConsumptionTot2017"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2019, colour = "ConsumptionTot2019"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2021, colour = "ConsumptionTot2021"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2023, colour = "ConsumptionTot2023"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2025, colour = "ConsumptionTot2025"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2027, colour = "ConsumptionTot2027"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2029, colour = "ConsumptionTot2029"), size=0.5) +
  
  geom_line(aes(y=ConsumptionTot2015, colour = "ConsumptionTot2015"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2017, colour = "ConsumptionTot2017"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2019, colour = "ConsumptionTot2019"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2021, colour = "ConsumptionTot2021"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2023, colour = "ConsumptionTot2023"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2025, colour = "ConsumptionTot2025"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2027, colour = "ConsumptionTot2027"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2029, colour = "ConsumptionTot2029"), size=0.2) +
  
  
  
  
  
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Lighting energy for an average day per season total NZ - forecast") +
  scale_color_manual(legend_title, labels = c("2015",
                                              "2017",
                                              "2019",
                                              "2021",
                                              "2023",
                                              "2025",
                                              "2027",
                                              "2029"), values = c("#332288",
                                                                  "#88CCEE",
                                                                  "#44AA99",
                                                                  "#117733",
                                                                  "#999933",
                                                                  "#DDCC77",
                                                                  "#CC6677",
                                                                  "#882255")) +
  facet_grid(season ~ .) +
  scale_y_continuous(breaks = c(100, 200, 300)) +
  scale_y_continuous( limits = c(0,370))+
  labs(x='Time of Day', y='MWh per ½  hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Lighting energy for an average day Spring and Summer total NZ forecast.jpg", dpi=600)

```
```{r Plot 1 4}

#Change the order in facet_grid()
LightHHTotDT$season <- factor(LightHHTotDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising Lighting development in Wh per household
legend_title <- "Year"
myPlot <- ggplot2::ggplot(subset(LightHHTotDT, season %in% c("Autumn", "Winter")), aes(x = obsHalfHour)) +
  geom_point(aes(y=ConsumptionTot2015, colour = "ConsumptionTot2015"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2017, colour = "ConsumptionTot2017"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2019, colour = "ConsumptionTot2019"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2021, colour = "ConsumptionTot2021"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2023, colour = "ConsumptionTot2023"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2025, colour = "ConsumptionTot2025"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2027, colour = "ConsumptionTot2027"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2029, colour = "ConsumptionTot2029"), size=0.5) +
  
  geom_line(aes(y=ConsumptionTot2015, colour = "ConsumptionTot2015"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2017, colour = "ConsumptionTot2017"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2019, colour = "ConsumptionTot2019"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2021, colour = "ConsumptionTot2021"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2023, colour = "ConsumptionTot2023"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2025, colour = "ConsumptionTot2025"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2027, colour = "ConsumptionTot2027"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2029, colour = "ConsumptionTot2029"), size=0.2) +
  
  
  
  
  
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Lighting energy for an average day per season total NZ - forecast") +
  scale_color_manual(legend_title, labels = c("2015",
                                              "2017",
                                              "2019",
                                              "2021",
                                              "2023",
                                              "2025",
                                              "2027",
                                              "2029"), values = c("#332288",
                                                                  "#88CCEE",
                                                                  "#44AA99",
                                                                  "#117733",
                                                                  "#999933",
                                                                  "#DDCC77",
                                                                  "#CC6677",
                                                                  "#882255")) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½ hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Lighting energy for an average day Autumn and Winter total NZ forecast.jpg", dpi=600)

```
```{r Plot Gen development}

#Change the order in facet_grid()
LightDevDT$season <- factor(LightDevDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))


#Visualising Lighting development in Wh per household
legend_title <- "Year"
myPlot <- ggplot2::ggplot(LightDevDT, aes(x = obsHalfHour)) +
  geom_point(aes(y=ConsumptionTot2015, colour = "ConsumptionTot2015"), size=1.0) +
  geom_point(aes(y=ConsumptionTot2017, colour = "ConsumptionTot2017"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2019, colour = "ConsumptionTot2019"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2021, colour = "ConsumptionTot2021"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2023, colour = "ConsumptionTot2023"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2025, colour = "ConsumptionTot2025"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2027, colour = "ConsumptionTot2027"), size=0.5) +
  geom_point(aes(y=ConsumptionTot2029, colour = "ConsumptionTot2029"), size=0.5) +
  
  geom_line(aes(y=ConsumptionTot2015, colour = "ConsumptionTot2015"), size=1.0) +
  geom_line(aes(y=ConsumptionTot2017, colour = "ConsumptionTot2017"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2019, colour = "ConsumptionTot2019"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2021, colour = "ConsumptionTot2021"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2023, colour = "ConsumptionTot2023"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2025, colour = "ConsumptionTot2025"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2027, colour = "ConsumptionTot2027"), size=0.2) +
  geom_line(aes(y=ConsumptionTot2029, colour = "ConsumptionTot2029"), size=0.2) +
  
  
  
  
  
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Total NZ demand development for an average day with improving lighting efficiency - forecast") +
  scale_color_manual(legend_title, labels = c(
                                              "2015",
                                              "2017",
                                              "2019",
                                              "2021",
                                              "2023",
                                              "2025",
                                              "2027",
                                              "2029"), values = c("#332288",
                                                                  "#88CCEE",
                                                                  "#44AA99",
                                                                  "#117733",
                                                                  "#999933",
                                                                  "#DDCC77",
                                                                  "#CC6677",
                                                                  "#882255")) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½ hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Total NZ demand development for an average day with improving lighting efficiency - forecast.jpeg", dpi=600)

```
```{r Energy output: Daily average per day total NZ Lighting}


sc3intermediate <- sc3data
sc3intermediate <- EnergyOutput2[, .(EnergyOut = sum(ConsumptionTot2029)/1000),
                   keyby = .(season, Period)]
sc3intermediate

```
```{r Dailay average consumption profile with time-periods}


EnergyOutput1$season <- factor(EnergyOutput1$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

#Visualising Lighting time-periods in MWh 2015
legend_title <- "Year"
myPlot <- ggplot2::ggplot(EnergyOutput1, aes(x = obsHalfHour, colour = Period)) +
  geom_point(aes(y=ConsumptionTot2015), size=0.5) +
  
  scale_color_discrete(breaks=c("Off Peak 1", "Morning Peak", "Off Peak 2",
                                "Evening Peak")) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Daily average consumption profile 2015") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½ hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Daily average consumption profile 2015.jpeg", dpi=600)




#Visualising Lighting time-periods in MWh 2015 and 2029
legend_title <- "Year"
myPlot <- ggplot2::ggplot(EnergyOutput1, aes(x = obsHalfHour, colour = Period)) +
  geom_point(aes(y=ConsumptionTot2015), size=0.5) +
  geom_point(aes(y=ConsumptionTot2029), size=0.5) +
  
  scale_color_discrete(breaks=c("Off Peak 1", "Morning Peak", "Off Peak 2",
                                "Evening Peak")) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Daily average consumption profile 2015 and 2029") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½ hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Daily average consumption profile 2015 and 2029.jpeg", dpi=600)







#Visualising Lighting time-periods in MWh 2015-2029
legend_title <- "Year"
myPlot <- ggplot2::ggplot(EnergyOutput1, aes(x = obsHalfHour, colour = Period)) +
  geom_point(aes(y=ConsumptionTot2015), size=0.5) +
  geom_point(aes(y=ConsumptionTot2017), size=0.5) +
  geom_point(aes(y=ConsumptionTot2019), size=0.5) +
  geom_point(aes(y=ConsumptionTot2021), size=0.5) +
  geom_point(aes(y=ConsumptionTot2023), size=0.5) +
  geom_point(aes(y=ConsumptionTot2025), size=0.5) +
  geom_point(aes(y=ConsumptionTot2027), size=0.5) +
  geom_point(aes(y=ConsumptionTot2029), size=0.5) +
  
  scale_color_discrete(breaks=c("Off Peak 1", "Morning Peak", "Off Peak 2",
                                "Evening Peak")) +
  theme(text = element_text(family = "Cambria")) +
  ggtitle("Daily average consumption profile 2015-2029") +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½ hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot


#ggsave("Daily average consumption profile 2015-2029.jpeg", dpi=600)













```
```{r all appliances togetrher visualisation}


#Change the order in facet_grid()
sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))



#All seasons
legend_title <- "Appliance"
myPlot <- ggplot2::ggplot(sc3data, aes(x = obsHalfHour)) +
  geom_line(aes(y=APumpandWater, colour = "APumpandWater"), size=0.2) +
  geom_line(aes(y=BGWhHW, colour = "BGWhHW"), size=0.2) +
  geom_line(aes(y=CGWhLight, colour = "CGWhLight"), size=0.2) +
  geom_line(aes(y=DGWhREF, colour = "DGWhREF"), size=0.2) +
  geom_line(aes(y=EGWhHP, colour = "EGWhHP"), size=0.2) +
  
  
  geom_point(aes(y=APumpandWater, colour = "APumpandWater"), size=0.1) +
  geom_point(aes(y=BGWhHW, colour = "BGWhHW"), size=0.1) +
  geom_point(aes(y=CGWhLight, colour = "CGWhLight"), size=0.1) +
  geom_point(aes(y=DGWhREF, colour = "DGWhREF"), size=0.1) +
  geom_point(aes(y=EGWhHP, colour = "EGWhHP"), size=0.1) +

  theme(text = element_text(family = "Cambria")) +
  ggtitle("Daily average energy consumption all appliances per season") +
  scale_color_manual(legend_title, labels = c("∑ A-D",
                                              "HW (A)",
                                              "LIGHT (B)",
                                              "REF (C)",
                                              "HP (D)"
                                              ), values = c("black",
                                                                  "blue",
                                                                  "red",
                                                                  "orange",
                                                                  "green"
                                                                  )) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½  hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Daily average energy consumption all appliances per season.jpeg", dpi = 600)


#Autumn and Winter
#Change the order in facet_grid()
sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

legend_title <- "Appliance"
myPlot <- ggplot2::ggplot(subset(sc3data, season %in% c("Autumn", "Winter")), aes(x = obsHalfHour)) +
  geom_line(aes(y=APumpandWater, colour = "APumpandWater"), size=0.2) +
  geom_line(aes(y=BGWhHW, colour = "BGWhHW"), size=0.2) +
  geom_line(aes(y=CGWhLight, colour = "CGWhLight"), size=0.2) +
  geom_line(aes(y=DGWhREF, colour = "DGWhREF"), size=0.2) +
  geom_line(aes(y=EGWhHP, colour = "EGWhHP"), size=0.2) +
  
  
  geom_point(aes(y=APumpandWater, colour = "APumpandWater"), size=0.1) +
  geom_point(aes(y=BGWhHW, colour = "BGWhHW"), size=0.1) +
  geom_point(aes(y=CGWhLight, colour = "CGWhLight"), size=0.1) +
  geom_point(aes(y=DGWhREF, colour = "DGWhREF"), size=0.1) +
  geom_point(aes(y=EGWhHP, colour = "EGWhHP"), size=0.1) +

  theme(text = element_text(family = "Cambria")) +
  ggtitle("Daily average energy consumption all appliances for autumn and winter") +
  scale_color_manual(legend_title, labels = c("∑ A-D",
                                              "HW (A)",
                                              "LIGHT (B)",
                                              "REF (C)",
                                              "HP (D)"
                                              ), values = c("black",
                                                                  "blue",
                                                                  "red",
                                                                  "orange",
                                                                  "green"
                                                                  )) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½  hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Daily average energy consumption all appliances for autumn and winter.jpeg", dpi = 600)

#Spring and Summer
#Change the order in facet_grid()
sc3data$season <- factor(sc3data$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))

legend_title <- "Appliance"
myPlot <- ggplot2::ggplot(subset(sc3data, season %in% c("Spring", "Summer")), aes(x = obsHalfHour)) +
  geom_line(aes(y=APumpandWater, colour = "APumpandWater"), size=0.2) +
  geom_line(aes(y=BGWhHW, colour = "BGWhHW"), size=0.2) +
  geom_line(aes(y=CGWhLight, colour = "CGWhLight"), size=0.2) +
  geom_line(aes(y=DGWhREF, colour = "DGWhREF"), size=0.2) +
  geom_line(aes(y=EGWhHP, colour = "EGWhHP"), size=0.2) +
  
  
  geom_point(aes(y=APumpandWater, colour = "APumpandWater"), size=0.1) +
  geom_point(aes(y=BGWhHW, colour = "BGWhHW"), size=0.1) +
  geom_point(aes(y=CGWhLight, colour = "CGWhLight"), size=0.1) +
  geom_point(aes(y=DGWhREF, colour = "DGWhREF"), size=0.1) +
  geom_point(aes(y=EGWhHP, colour = "EGWhHP"), size=0.1) +

  theme(text = element_text(family = "Cambria")) +
  ggtitle("Daily average energy consumption all appliances for spring and summer") +
  scale_color_manual(legend_title, labels = c("∑ A-D",
                                              "HW (A)",
                                              "LIGHT (B)",
                                              "REF (C)",
                                              "HP (D)"
                                              ), values = c("black",
                                                                  "blue",
                                                                  "red",
                                                                  "orange",
                                                                  "green"
                                                                  )) +
  scale_y_continuous(breaks = c(250, 500, 750, 1000)) +
  scale_y_continuous( limits = c(0,1000))+
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='MWh per ½  hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot

#ggsave("Daily average energy consumption all appliances for spring and summer.jpeg", dpi = 600)







```
#Test without scaling
```{r depict applainces without scaling}

HeatPumptestDT <- HeatPumptestDT1[, obsHalfHour := hms::trunc_hms(obsHourMin, 1800)]#Creating half hour time-steps
HeatPumptestDT <- HeatPumptestDT[, .(meanW = mean(meanW)/2), keyby = .(season, obsHalfHour)]#Wh
HeatPumptestDT$season <- factor(HeatPumptestDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))
HeatPumptestDT <- HeatPumptestDT[, season := season, keyby = .(season, obsHalfHour)]
#_____________________________________________________

#Hot Water
HotWatertestDT <-HotWatertestDT1[, obsHalfHour := hms::trunc_hms(obsHourMin, 1800)]
HotWatertestDT <- HotWatertestDT[, .(powerW = mean(powerW)/2), keyby = .(season, obsHalfHour)]#Wh
HotWatertestDT$season <- factor(HotWatertestDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))
HotWatertestDT <- HotWatertestDT[, season := season, keyby = .(season, obsHalfHour)]
#_____________________________________________________

#Lighting
LightTestDT <- LightTestDT1
LightTestDT$season <- factor(LightTestDT$season, levels = c("Spring","Summer",
                                                    "Autumn", "Winter"))
LightTestDT <- LightTestDT[, season := season, keyby = .(season, obsHalfHour)]
LightTestDT <- LightTestDT[, BLighttest := meanW/2]#Wh

#Copying other appliances
LightTestDT <- LightTestDT[, CHPtest := HeatPumptestDT$meanW]
LightTestDT <- LightTestDT[, AHWtest := HotWatertestDT$powerW]

#______________________________________________________

#Visualisation

legend_title <- "Appliance"
myPlot <- ggplot2::ggplot(subset(LightTestDT, season %in% c("Autumn", "Winter")), aes(x = obsHalfHour)) +
  geom_line(aes(y=AHWtest, colour = "AHWtest"), size=0.3) +
  geom_line(aes(y=BLighttest, colour = "BLighttest"), size=0.3) +
  geom_line(aes(y=CHPtest, colour = "CHPtest"), size=0.3) +
  
  
  geom_point(aes(y=AHWtest, colour = "AHWtest"), size=0.1) +
  geom_point(aes(y=BLighttest, colour = "BLighttest"), size=0.1) +
  geom_point(aes(y=CHPtest, colour = "CHPtest"), size=0.1) +


  theme(text = element_text(family = "Cambria")) +
  ggtitle("Original daily average energy consumption profile for autumn and winter per household") +
  scale_color_manual(legend_title, labels = c(
                                              "HW",
                                              "LIGHT",
                                              "HP"
                                              
                                              ), values = c("blue",
                                                                  "red",
                                                                  "green"
                                                                  
                                                                  )) +
  facet_grid(season ~ .) +
  labs(x='Time of Day', y='Wh per ½ hour') +
  scale_x_time(breaks = c(hms::as.hms("00:00:00"), 
                          hms::as.hms("04:00:00"), 
                          hms::as.hms("08:00:00"),       
                          hms::as.hms("12:00:00"), 
                          hms::as.hms("16:00:00"), 
                          hms::as.hms("20:00:00"),
                          hms::as.hms("24:00:00"))) 
myPlot


#ggsave("Original daily average energy consumption profile for autumn and winter per household.jpeg", dpi= 600)



```












#MyPlot example
```{r scenario load curtailment}

#sc1data <- heatPumpProfileDT
#sc1data[, c("medianW", "obsHourMin", "meanW", "nObs", "sdW", "scaledMWmethod1", "EECApmMethod2"):=NULL] #Deleting unnecessary columns

#sc1data <- sc1data[, .(GWh = sum(scaledGWh)), 
                   # keyby = .(season, obsHalfHour)]

#myPlot <- ggplot2::ggplot(sc1data, aes(x = obsHalfHour, color=GWh)) +
  #geom_step(aes(y=GWh), size=0.5) +
 # theme(text = element_text(family = "Cambria")) +
 # ggtitle("Total New Zealand half hour heat pump energy consumption by season for 2015") +
 # facet_grid(season ~ .) +
 # labs(x='Time of Day', y='GWh') +
 # scale_y_continuous(breaks = c(3, 6, 9, 12)) +
 # scale_x_time(breaks = c(hms::as.hms("00:00:00"), hms::as.hms("03:00:00"), hms::as.hms("06:00:00"),       hms::as.hms("09:00:00"), hms::as.hms("12:00:00"), 
 # hms::as.hms("15:00:00"), hms::as.hms("18:00:00"), hms::as.hms("21:00:00"))) +
 # scale_colour_gradient(low= "green", high="red", guide = "colorbar")

#myPlot

#ggsave("Total New Zealand half hour heat pump energy consumption by season for 2015.jpeg",
      # dpi=600)





#Other examples

#AuMP <- 38.35385
#WiMP <- 96.89743
#SpMP <- 39.09743
#SuMP <- 23.28916
#AuEP <- 29.11365
#WiEP <- 75.27774
#SpEP <- 35.80694
#SuEP <- 10.12392

#AuNP1 <- sc1data[ GWhs1[1:12 42:48]]
#AuNP2 <- sc1data[ c(22:32), "GWhs1"]
#WiNP1 <- sc1data[ c(145:156, 186:192), "GWhs1"]
#WiNP2 <- sc1data[ c(166:176), "GWhs1"]
#SpNP1 <- sc1data[ c(49:60, 90:96), "GWhs1"]
#SpNP2 <- sc1data[ c(70:80), "GWhs1"]
#SuNP1 <- sc1data[ c(97:108, 138:144), "GWhs1"]
#SuNP2 <- sc1data[ c(118:128), "GWhs1"]

#sc1data <- sc1data[, ShiftL := GWhs1] # Creating new column ShiftL based on GWhs1

# Updating ShiftL predefined rows with the percentage of peak-period sum. Spreading Morning Peak load over a longer duration than Evening Peak
#sc1data <- sc1data[, ShiftL := AuNP1 * AuMP * 1/19]
#sc1data <- sc1data[, ShiftL := WiNP1 * WiMP * 1/19]
#sc1data <- sc1data[, ShiftL := SpNP1 * SpMP * 1/19]
#sc1data <- sc1data[, ShiftL := SuNP1 * SuMP * 1/19]

#sc1data <- sc1data[, ShiftL := AuNP2 * AuEP * 1/11]
#sc1data <- sc1data[, ShiftL := WiNP2 * WiEP * 1/11]
#sc1data <- sc1data[, ShiftL := SpNP2 * SpEP * 1/11]
#sc1data <- sc1data[, ShiftL := SuNP2 * SuEP * 1/11]


#sc1data <- sc1data[, ShiftL:= ifelse(Period == "Evening Peak", 0, ShiftL )]
#sc1data <- sc1data[, ShiftL:= ifelse(Period == "Morning Peak", 0, ShiftL )]
```




# Runtime


```{r check runtime, include=FALSE}
t <- proc.time() - startTime

elapsed <- t[[3]]
```

Analysis completed in `r round(elapsed,2)` seconds ( `r round(elapsed/60,2)` minutes) using [knitr](https://cran.r-project.org/package=knitr) in [RStudio](http://www.rstudio.com) with `r R.version.string` running on `r R.version$platform`.

# R environment

R packages used:

 * base R - for the basics [@baseR]
 * data.table - for fast (big) data handling [@data.table]
 * lubridate - date manipulation [@lubridate]
 * ggplot2 - for slick graphics [@ggplot2]
 * readr - for csv reading/writing [@readr]
 * skimr - for skim [@skimr]
 * knitr - to create this document & neat tables [@knitr]
 * GREENGrid - for local NZ GREEN Grid project utilities

Session info:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References
